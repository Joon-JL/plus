<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
	<queries>
	
		<!-- 개발,라이선스계약의 의뢰건목록-->
 		<query id="common.jobs.listFirstRequest" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
			
			SELECT RTRIM(SEL_DEPT_CD) SEL_DEPT_CD, CNSDREQ_ID, RTRIM (VC_CNSD_DEPT) VC_CNSD_DEPT FROM (
						SELECT 
						  CASE 
					  		WHEN 0 <( SELECT COUNT(DUTY_EXCEPTDAY) FROM TN_CLM_DUTY_EXCEPTDAY WHERE DUTY_EXCEPTDAY = TO_CHAR(SYSDATE,'YYYYMMDD')) THEN
								'NOT WORKING TIME' 
							WHEN SYSDATE - 
								TO_date(||(TO_CHAR(SYSDATE,'YYYY-MM-DD'), ' 08:00'),'YYYY-MM-DD HH24:MI') < 0 THEN
								'NOT WORKING TIME'
							WHEN SYSDATE - 
								TO_date(||(TO_CHAR(SYSDATE,'YYYY-MM-DD'), ' 17:00'),'YYYY-MM-DD HH24:MI') > 0 THEN
								  'NOT WORKING TIME'  
					  
							--IP센터에서 이관요청없이 시간이 지난건 체크
							WHEN B.CNSDREQ_ID IS NULL THEN
							  CASE WHEN days(current date) - days(NVL(ACPT_DT,SYSDATE)) = 0 THEN
								CASE WHEN HOUR( DATE(NVL(ACPT_DT,SYSDATE))) >= 8 THEN 
								  --당일건이면서 오전8시이후에 신청건 : 점심시간제외하기위해(300)
								  CASE WHEN (HOUR(current date))*60 + MINUTE(current date) -
										  ((HOUR( DATE(NVL(ACPT_DT,SYSDATE))))*60 + MINUTE( DATE(NVL(ACPT_DT,SYSDATE)))) > 300 THEN
									MN_CNSD_DEPT
								  ELSE
									'TIME CHECKING'
								  END
								ELSE
								  --당일건이면서 오전8시이전에 신청건
								  CASE WHEN (HOUR(current date))*60 + MINUTE(current date) - 8*60 > 240 THEN
									MN_CNSD_DEPT
								  ELSE
									'TIME CHECKING'
								  END
								END
							  ELSE
								--어제날짜로 17시 이전에 의뢰한 경우
								CASE WHEN HOUR( DATE(NVL(ACPT_DT,SYSDATE))) < 17 AND
										  (
										  17*60 - ( (HOUR( DATE(NVL(ACPT_DT,SYSDATE))))*60 + MINUTE( DATE(NVL(ACPT_DT,SYSDATE))) ) 
										  + ((HOUR(current date))*60 + MINUTE(current date)) - 8*60
										  )  > 240 THEN
								  MN_CNSD_DEPT
								  
								WHEN HOUR( DATE(NVL(ACPT_DT,SYSDATE))) >= 17 AND 
								  (HOUR(current date))*60 + MINUTE(current date) - 8*60 > 240 THEN
								  --어제날짜로 17시 이후에 의뢰한 경우
								  MN_CNSD_DEPT
								ELSE
								  'TIME CHECKING'
								END
							  END
								
							--IP센터에서 이관요청한 건의 경우  
							ELSE 
							  CASE WHEN days(current date) - days(E.DEMND_DT) = 0 THEN
								CASE WHEN HOUR( DATE(E.DEMND_DT)) >= 8 THEN 
								  --당일건이면서 오전8시이후에 신청건 : 점심시간제외하기위해(300)
								  CASE WHEN (HOUR(current date))*60 + MINUTE(current date) -
										  ((HOUR( DATE(E.DEMND_DT)))*60 + MINUTE( DATE(E.DEMND_DT))) > 300 THEN
									'A00000003'
								  ELSE
									'TIME CHECKING'
								  END
								ELSE
								  --당일건이면서 오전8시이전에 신청건
								  CASE WHEN (HOUR(current date))*60 + MINUTE(current date) - 8*60 > 240 THEN
									'A00000003'
								  ELSE
									'TIME CHECKING'
								  END
								END
							  ELSE
								--어제날짜로 17시 이전에 의뢰한 경우
								CASE WHEN HOUR( DATE(E.DEMND_DT)) < 17 AND
										  (
										  17*60 - ( (HOUR( DATE(E.DEMND_DT)))*60 + MINUTE( DATE(E.DEMND_DT)) ) 
										  + ((HOUR(current date))*60 + MINUTE(current date)) - 8*60
										  )  > 240 THEN
								  'A00000003'
								  
								WHEN HOUR( DATE(E.DEMND_DT)) >= 17 AND 
								  (HOUR(current date))*60 + MINUTE(current date) - 8*60 > 240 THEN
								  --어제날짜로 17시 이후에 의뢰한 경우
								  'A00000003'
								ELSE
								  'TIME CHECKING'
								END
							  END
							END SEL_DEPT_CD,  A.CNSDREQ_ID, (CASE WHEN B.CNSDREQ_ID IS NULL THEN 'A00000003' ELSE MN_CNSD_DEPT END) VC_CNSD_DEPT
					FROM TN_CLM_CONT_CNSDREQ A, (
										SELECT CNSDREQ_ID,MAX(TRANS_SEQNO) TRANS_SEQNO FROM TN_CLM_CONT_CNSDREQ_TRANSFER GROUP BY CNSDREQ_ID
										) B, 
										(SELECT SSA.CNSDREQ_ID, MIN(SSA.CNTRT_ID) CNTRT_ID FROM TN_CLM_CONTRACT_CNSD SSA, TN_CLM_CONTRACT_MASTER SSB 
					  						WHERE SSA.CNTRT_ID = SSB.CNTRT_ID AND SSB.DEL_YN = 'N' AND SSB.DEPTH_STATUS NOT IN ('C02603')  GROUP BY CNSDREQ_ID) C, 
						  		TN_CLM_CONTRACT_MASTER D, TN_CLM_CONT_CNSDREQ_TRANSFER E	
						  WHERE A.PREV_CNSDREQ_ID IS NULL
								AND A.DEL_YN='N'
								AND D.DEL_YN='N'
								AND (A.FAST_TRACK_DIV IS NULL OR A.FAST_TRACK_DIV NOT IN ('W', 'Y'))
								AND A.PRGRS_STATUS IN ('C04202','C04206') 
								AND NOT EXISTS (SELECT CNSDREQ_ID FROM TN_CLM_CONT_CNSDREQ WHERE PREV_CNSDREQ_ID = A.CNSDREQ_ID)
								AND A.CNSDREQ_ID = C.CNSDREQ_ID
								AND C.CNTRT_ID = D.CNTRT_ID
								AND D.CNCLSNPURPS_BIGCLSFCN IN ('T0301','T0303')
								AND D.CNTRT_INFO_GBN = 'C05401'
								AND A.CNSDREQ_ID = B.CNSDREQ_ID(+)
								AND B.CNSDREQ_ID = E.CNSDREQ_ID(+)
								AND 'Y' = (CASE WHEN E.TRANS_STATUS IS NULL OR E.TRANS_STATUS = 'C03801' THEN 'Y' ELSE 'N' END)  
								AND B.TRANS_SEQNO = E.TRANS_SEQNO(+)
						  ) T	  
						  GROUP BY T.CNSDREQ_ID, T.SEL_DEPT_CD, T.VC_CNSD_DEPT  
							 
				
				]]>
			</statement>														 	
		</query>
		
		<!-- 개발,라이선스계약의 의뢰건 부서배정 수정 -->
 		<query id="common.jobs.update_dept" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
				BEGIN
					declare v_trans_status  anchor   TN_CLM_CONT_CNSDREQ_TRANSFER.TRANS_STATUS; 
					declare v_hndl_cause   anchor   TN_CLM_CONT_CNSDREQ_TRANSFER.HNDL_CAUSE; 
					   
					UPDATE TN_CLM_CONT_CNSDREQ SET 
						MN_CNSD_DEPT = :mn_cnsd_dept ,
						VC_CNSD_DEPT = :vc_cnsd_dept ,
						PRGRS_STATUS = 'C04203'
					WHERE CNSDREQ_ID  = :cnsdreq_id ;
					
					SET v_trans_status = ( SELECT DECODE(COUNT(*),0,'C03804','C03802') 
							  		FROM TN_CLM_CONT_CNSDREQ_TRANSFER WHERE CNSDREQ_ID = :cnsdreq_id );
					SET v_hndl_cause = '[AUTO TRANS]4시간 초과에 의한 자동 이관불필요건 입니다.';
					
					IF LTRIM(RTRIM(v_trans_status)) = 'C03804' THEN
						--C03804 : 이관상태(불필요) 부서변경이 없이 법무팀이 됨
						INSERT INTO TN_CLM_CONT_CNSDREQ_TRANSFER  
							(
								 CNSDREQ_ID
								,TRANS_SEQNO
								,DEMND_DT
								,DEMNDMAN_ID
								,HNDL_DT
								,HNDLMAN_ID
								,HNDLMAN_NM
								,HNDL_CAUSE
								,TRANS_STATUS
								,CHGEBFR_CNSD_DEPT
								,CHGEAFT_CNSD_DEPT
							) VALUES (
							   :cnsdreq_id
							  , ( SELECT DECODE(COUNT(*),0,1,MAX(TRANS_SEQNO)+1) 
							  		FROM TN_CLM_CONT_CNSDREQ_TRANSFER WHERE CNSDREQ_ID = :cnsdreq_id )
							  ,SYSDATE
							  ,'SYSTEM_DAEMON'
							  ,SYSDATE
							  ,'SYSTEM_DAEMON'
							  ,'시스템관리자'
							  , v_hndl_cause
							  , v_trans_status 
							  , :mn_cnsd_dept
							  , :mn_cnsd_dept
							) ;
					ELSE
						--C03802 : 이관승인 : 부서변경이 되어서 IP센터로 바뀜
						SET v_hndl_cause = '[AUTO TRANS]이관요청후 4시간 초과에 의한 자동 이관승인건 입니다.';
						
						UPDATE TN_CLM_CONT_CNSDREQ_TRANSFER  
							SET HNDL_DT = SYSDATE, HNDLMAN_ID = 'SYSTEM_DAEMON' , HNDLMAN_NM = '시스템관리자',
								HNDL_CAUSE = v_hndl_cause , TRANS_STATUS = v_trans_status ,
								CHGEBFR_CNSD_DEPT = :vc_cnsd_dept , CHGEAFT_CNSD_DEPT = :mn_cnsd_dept 
						WHERE	
						CNSDREQ_ID = :cnsdreq_id AND TRANS_SEQNO = 
							( SELECT MAX(TRANS_SEQNO) FROM TN_CLM_CONT_CNSDREQ_TRANSFER WHERE CNSDREQ_ID = :cnsdreq_id ) ;
					END IF;		  		
					 
				END;
				]]>
			</statement>														 	
		</query>		  		 
	   
		<!-- 2014-05-19 Sungwoo email Batch Process 중 Execution Information 발송 삭제처리 -->
		<query id="common.jobs.getTargetMailList" isCamelCase="false" comment="자동메일발송">
		  <statement>
			<![CDATA[
				 
			SELECT CNSDREQ_ID,(CASE WHEN TRGTMAN_ROW='MASTER_ROW' THEN EMAIL ELSE (SELECT TOP 1 EMAIL FROM TB_COM_USER WHERE EMAIL=EMAIL ) END) EMAIL,
					  CNTRT_NUM_NM,CNTRT_NM,TOP_A.CNTRT_ID,DAYS1,EXEC_PLNDDAY,
					  FLAG,					   
					  ISNULL(CNTRT_RESPMAN_NM,'') CNTRT_RESPMAN_NM,
					  CNTRT_RESPMAN_ID,
					  ISNULL(CNTRT_NO,'') CNTRT_NO,
					  PRCS_DEPTH,
					  dbo.LAS_CODE_NM('C025',PRCS_DEPTH,:vo.session_user_locale)  AS PRCS_DEPTH_NM,
					  DEPTH_STATUS,
					  dbo.LAS_CODE_NM(PRCS_DEPTH, DEPTH_STATUS,:vo.session_user_locale)  AS DEPTH_STATUS_NM,
					  REQ_TITLE,LAST_LOCALE
				  FROM (
					SELECT AUTHREQ.CNTRT_ID TRGTMAN_ROW, AUTHREQ.TRGTMAN_ID,  TTB.CNSDREQ_ID, TTD.EMAIL,
						  CASE WHEN FLAG = 'FLAG4' OR FLAG = 'FLAG4-1' THEN
							(SELECT TOP 1 LEVEL FROM DBO.[COM.GET_LINK_CNSDREQ_ID]( TTB.CNSDREQ_ID ))				   
						  ELSE
							DBO.COM_CNTRT_ORDER(TTB.CNSDREQ_ID,TTA.CNTRT_ID) 
						  END AS CNTRT_NUM_NM, 
						  TTA.CNTRT_NM, TTA.CNTRT_ID, TTA.DAYS1, TTA.EXEC_PLNDDAY, TTA.FLAG, 
						  TTA.CNTRT_RESPMAN_NM, TTA.CNTRT_RESPMAN_ID 
						  , ISNULL(TTA.CNTRT_NO,'') CNTRT_NO
						  , TTA.PRCS_DEPTH
						  , (SELECT CD_NM FROM TB_COM_CD WHERE CD = TTA.PRCS_DEPTH ) AS PRCS_DEPTH_NM
						  , TTA.DEPTH_STATUS
						  , (SELECT CD_NM FROM TB_COM_CD WHERE CD = TTA.DEPTH_STATUS ) AS DEPTH_STATUS_NM 
						  , (SELECT X.REQ_TITLE FROM TN_CLM_CONT_CNSDREQ X WHERE X.CNSDREQ_ID = (SELECT TOP 1 Y.CNSDREQ_ID FROM TN_CLM_CONTRACT_CNSD Y WHERE Y.CNTRT_ID = TTA.CNTRT_ID )) AS REQ_TITLE
							, ISNULL(LAST_LOCALE,'en') LAST_LOCALE
					  FROM (
						SELECT TA.CNTRT_NM
							,TA.CNTRT_ID
							/*만료알림일 메일발송 CNTRTPERIOD_ENDDAY 30일 전 부터 Notice. (매 7일) 신성우 쿼리튜닝 및 수정 2014-04-01 */
							, CAST(DATEDIFF(DD, GETDATE(), CONVERT(DATETIME,CNTRTPERIOD_ENDDAY)) AS NVARCHAR) DAYS1
							, CONVERT(CHAR(10), CONVERT(DATETIME, CNTRTPERIOD_ENDDAY, 112) , 23) AS EXEC_PLNDDAY /*YYYY-MM-DD*/
							,'FLAG2'AS FLAG
							,ISNULL((
									SELECT TITLE
									FROM TB_COM_START_PROCESS_WSVO SA
									WHERE CHARINDEX(TA.CNTRT_ID, REF_KEY) > 0
										AND EXISTS (
											SELECT 'E'
											FROM (
												SELECT MAX(MIS_ID) MIS_ID
													,REF_KEY
												FROM TB_COM_START_PROCESS_WSVO
												WHERE STATUS = '2'
												GROUP BY REF_KEY
												) SB
											WHERE SA.MIS_ID = SB.MIS_ID
												AND SA.REF_KEY = SB.REF_KEY
											)
									), TA.CNTRT_NM) WSVO_TITLE
							,TA.CNTRT_RESPMAN_NM + '/' + TA.CNTRT_RESPMAN_JIKGUP_NM + '/' + TA.CNTRT_RESP_DEPT_NM cntrt_respman_nm
							,TA.CNTRT_RESPMAN_ID
							,ISNULL(TA.CNTRT_NO, '') CNTRT_NO
							,TA.PRCS_DEPTH
							,TA.DEPTH_STATUS
						FROM TN_CLM_CONTRACT_MASTER TA
						WHERE TA.DEL_YN = 'N' AND ISNULL(TA.CLOSE_YN,'N') = 'N' /* 2014-04-30 신성우 추가*/
							AND CNTRT_STATUS NOT IN ('C02406')
							AND TA.CNTRT_INFO_GBN = 'C05401'
							AND PRCS_DEPTH IN ('C02503','C02504','C02505')
							/* 단계상태가 계약종료(변경), 계약종료(만료), 계약종료(해지),보류 는 메일을 보내지 않는다. 20120509 박영덕수석 요청*/
							AND TA.DEPTH_STATUS NOT IN ('C02686','C02687','C02688','C02647')
							AND (
								TA.SYS_NM IS NULL
								OR (
									TA.SYS_NM != 'CPCEX'
									AND TA.SYS_NM != 'CMS'
									AND TA.SYS_NM != 'EMP'
									AND TA.SYS_NM != 'myProject'
									AND TA.SYS_NM != 'PUWP'
									)
								) /* 종료를 우리시스템에서 하지 않는 경우 메일발송을 하지 않는다 */
							AND CNTRTPERIOD_ENDDAY IS NOT NULL
							AND CNTRTPERIOD_ENDDAY != ''
							AND DATEDIFF(DD, CONVERT(VARCHAR(8), GETDATE(), 112), CASE ISDATE(CNTRTPERIOD_ENDDAY) WHEN 1 THEN CNTRTPERIOD_ENDDAY ELSE '19000101' END) BETWEEN 0 AND 30
							AND (0 = DATEDIFF(DD, CONVERT(VARCHAR(8), GETDATE(), 112), CASE ISDATE(CNTRTPERIOD_ENDDAY) WHEN 1 THEN CNTRTPERIOD_ENDDAY ELSE '19000101' END) % 7)

					  ) TTA, (SELECT MAX(CNSDREQ_ID) CNSDREQ_ID,CNTRT_ID FROM TN_CLM_CONTRACT_CNSD GROUP BY CNTRT_ID) TTB, 
						TB_COM_USER TTD, (  /*바이오에피스인경우에 관련자에게도 메일발송처리를 위해*/
											SELECT 'MASTER_ROW' CNTRT_ID, '' TRGTMAN_ID UNION ALL
											SELECT SB.CNTRT_ID, SB.TRGTMAN_ID FROM TN_CLM_CONTRACT_MASTER SA, TN_CLM_CONTRACT_AUTHREQ SB 
												WHERE SA.CNTRT_ID = SB.CNTRT_ID AND SB.DEL_YN='N' AND ISNULL(SA.CLOSE_YN,'N') = 'N' /* 2014-04-30 신성우 추가*/ AND SA.COMP_CD= 'PEQ') AUTHREQ 
					WHERE TTA.CNTRT_ID = TTB.CNTRT_ID AND
					TTA.CNTRT_RESPMAN_ID = TTD.USER_ID AND CHARINDEX('@',TTD.EMAIL) > 0	
					AND FLAG <> 'N' 
					AND TTA.CNTRT_ID = (CASE WHEN AUTHREQ.CNTRT_ID = 'MASTER_ROW' THEN TTA.CNTRT_ID
											 ELSE AUTHREQ.CNTRT_ID END) 
				) TOP_A  
			]]>
		  </statement>
		</query>
		
		<!-- Will be terminated 대상 조회 신성우 수정 20140401 기존 EXPRT_NOTIDAY 제외 후 현재 계약의 END Date 기준으로 조회 조건 변경-->
 		<query id="common.jobs.getConfirm_ending" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
					SELECT TTA.CNTRT_ID
						,TTB.CNSDREQ_ID
					FROM (
						SELECT A.CNTRT_ID
						FROM TN_CLM_CONTRACT_MASTER A
						WHERE A.DEL_YN = 'N'
							AND A.CNTRT_STATUS NOT IN ('C02406')
							AND A.CNTRT_INFO_GBN = 'C05401'
							AND A.PRCS_DEPTH IN ('C02504','C02505')
							AND A.DEPTH_STATUS NOT IN ('C02686','C02687','C02688','C02647')
							AND CNTRTPERIOD_ENDDAY IS NOT NULL
							AND CNTRTPERIOD_ENDDAY != ''
							AND CNTRTPERIOD_ENDDAY != '19000101'
							AND CNTRTPERIOD_ENDDAY BETWEEN CONVERT(varchar,GETDATE(),112) and CONVERT(varchar,DATEADD(DD,1,GETDATE()),112)	/* SUNGWOO REPLACED QUERY 2014-07-31 */
							AND 0 = (
								SELECT COUNT(*)
								FROM TN_CLM_CONT_EXECINFO
								WHERE EXEC_CMPLTDAY IS NULL
									AND CNTRT_ID = A.CNTRT_ID
								)
						GROUP BY A.CNTRT_ID
							,A.CNTRTPERIOD_ENDDAY
						) TTA
						,(
							SELECT MAX(CNSDREQ_ID) CNSDREQ_ID
								,CNTRT_ID
							FROM TN_CLM_CONTRACT_CNSD
							GROUP BY CNTRT_ID
							) TTB
					WHERE TTA.CNTRT_ID = TTB.CNTRT_ID
				]]>
			</statement>														 	
		</query>
		
		<!-- Expired 대상 조회 신성우 추가 20140408-->
 		<query id="common.jobs.getUpdate_ExpiredList" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
					SELECT TTA.CNTRT_ID
						,TTB.CNSDREQ_ID
					FROM (
						SELECT A.CNTRT_ID
						FROM TN_CLM_CONTRACT_MASTER A
						WHERE A.DEL_YN = 'N'
							AND A.CNTRT_STATUS NOT IN ('C02406')
							AND A.CNTRT_INFO_GBN = 'C05401'
							AND A.PRCS_DEPTH IN ('C02505')
							AND A.DEPTH_STATUS IN ('C02681')
							AND CNTRTPERIOD_ENDDAY IS NOT NULL
							AND CNTRTPERIOD_ENDDAY != ''
							AND CNTRTPERIOD_ENDDAY != '19000101'
							AND CNTRTPERIOD_ENDDAY = convert(varchar,DATEADD(DD,1,GETDATE()),112)
							AND 0 = (
								SELECT COUNT(*)
								FROM TN_CLM_CONT_EXECINFO
								WHERE EXEC_CMPLTDAY IS NULL
									AND CNTRT_ID = A.CNTRT_ID
								)
						GROUP BY A.CNTRT_ID
							,A.CNTRTPERIOD_ENDDAY
						) TTA
						,(
							SELECT MAX(CNSDREQ_ID) CNSDREQ_ID
								,CNTRT_ID
							FROM TN_CLM_CONTRACT_CNSD
							GROUP BY CNTRT_ID
							) TTB
					WHERE TTA.CNTRT_ID = TTB.CNTRT_ID
				]]>
			</statement>														 	
		</query>
		
		<!-- 종료대상확인 수정 -->
 		<query id="common.jobs.updateConfirm_ending" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
				BEGIN
				 
				UPDATE TN_CLM_CONTRACT_MASTER SET 
					PRCS_DEPTH = 'C02505' ,
					DEPTH_STATUS = 'C02681' 
					, MOD_DT = GETDATE()
				WHERE CNTRT_ID  = :cntrt_id ;
				 
				--TN_CLM_CONTRACT_MASTER에서 종료대상(C02681)이 아닌 계약건이  전혀 없다면  
				--TN_CLM_CONT_CNSDREQ의 의뢰상태(PRGRS_STATUS)를   종료대상(C04220)으로 수정.
				UPDATE TN_CLM_CONT_CNSDREQ SET 
					PRGRS_STATUS = 'C04220'
				FROM TN_CLM_CONT_CNSDREQ TA	
				WHERE 
				TA.CNSDREQ_ID = :cnsdreq_id
				AND NOT EXISTS (SELECT B.* FROM (
											SELECT CNSDREQ_ID, CNTRT_ID 
											FROM TN_CLM_CONTRACT_CNSD 
											WHERE CNSDREQ_ID  = :cnsdreq_id
										) A, TN_CLM_CONTRACT_MASTER B
						WHERE A.CNTRT_ID  = B.CNTRT_ID
						AND B.DEL_YN = 'N'  		
						AND B.CNTRT_INFO_GBN = 'C05401'	
						AND B.DEPTH_STATUS NOT IN ('C02681') 	
						AND A.CNSDREQ_ID = TA.CNSDREQ_ID
						) ;				
				
				
				END;
				]]>
			</statement>														 	
		</query>	
		
		<!-- 종료대상 Expired 신성우 추가 2014-04-08 -->
 		<query id="common.jobs.update_Expired" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
				BEGIN
				 
				UPDATE TN_CLM_CONTRACT_MASTER SET 
					PRCS_DEPTH = 'C02505' ,
					DEPTH_STATUS = 'C02686' 
					, MOD_DT = GETDATE()
				WHERE CNTRT_ID  = :cntrt_id ;
				 
				--TN_CLM_CONTRACT_MASTER에서 종료대상(C02681)이 아닌 계약건이  전혀 없다면  
				--TN_CLM_CONT_CNSDREQ의 의뢰상태(PRGRS_STATUS)를   종료대상(C04223)으로 수정.
				UPDATE TN_CLM_CONT_CNSDREQ SET 
					PRGRS_STATUS = 'C04223'
				FROM TN_CLM_CONT_CNSDREQ TA	
				WHERE 
				TA.CNSDREQ_ID = :cnsdreq_id
				AND NOT EXISTS (SELECT B.* FROM (
											SELECT CNSDREQ_ID, CNTRT_ID 
											FROM TN_CLM_CONTRACT_CNSD 
											WHERE CNSDREQ_ID  = :cnsdreq_id
										) A, TN_CLM_CONTRACT_MASTER B
						WHERE A.CNTRT_ID  = B.CNTRT_ID
						AND B.DEL_YN = 'N'  		
						AND B.CNTRT_INFO_GBN = 'C05401'	
						AND B.DEPTH_STATUS NOT IN ('C02681') 	
						AND A.CNSDREQ_ID = TA.CNSDREQ_ID
						) ;				
				
				
				END;
				]]>
			</statement>														 	
		</query>	
		
		<!-- 퇴사자를 체크하기위해 의뢰건이 있는 전체 사용자 조회  ( DROP된 의뢰건은 제외, 구시스템 데이타를 제외함. 그외의 신시스템 데이타에서 검색 )-->
 		<query id="common.jobs.getRetireUser" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
					SELECT TD.DEPT_MGR_EMP_NO,TA.USER_ID, TA.USER_NM || '/' || TA.DEPT_NM REQMAN_NM 
						FROM TB_COM_USER TA, TB_COM_ROLE_USER TB,
							(SELECT DISTINCT DECODE(C.CNTRT_STATUS,'C02401',A.REQMAN_ID,C.CNTRT_RESPMAN_ID) REQMAN_ID FROM TN_CLM_CONT_CNSDREQ A, 
											  (SELECT MAX(CNSDREQ_ID) CNSDREQ_ID,  CNTRT_ID FROM TN_CLM_CONTRACT_CNSD GROUP BY CNTRT_ID)B, 
											  TN_CLM_CONTRACT_MASTER C
											  WHERE A.DEL_YN = 'N' AND A.CNSDREQ_ID = B.CNSDREQ_ID AND B.CNTRT_ID = C.CNTRT_ID 
											  AND C.DEL_YN = 'N' AND C.CNTRT_INFO_GBN = 'C05401' AND A.PRGRS_STATUS NOT IN ('C04208','C04223')) TC,
							TB_COM_DEPT TD		
						WHERE TA.USER_ID = TB.USER_ID AND TB.SYS_CD = 'CLM' AND TB.ROLE_CD = 'RD02' AND
							  TA.USER_ID = TC.REQMAN_ID AND
							  TA.DEPT_CD = TD.DEPT_CD AND TD.DEPT_MGR_EMP_NO IS NOT NULL  
				]]>
			</statement>														 	
		</query>	
		
		<!-- 퇴사자가 의뢰한 계약건을 모두 모아주는 함수를 이용해서 조회 -->
 		<query id="common.jobs.getRetireUserReqs" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
					SELECT EMAIL_ID EMAIL, CLM_RETIRE_REQ( :user_id ) RETIRE_REQS FROM GAIS.CSTB_INSA3 WHERE EMP_NO = :emp_no
				]]>
			</statement>														 	
		</query>
		
		<!-- Drop되는 의뢰건의 최초 계약건  주의:결재후처리시 이미 DROP을 시킨후 이쿼리를 호출하므로 조건에 SB.DEPTH_STATUS NOT IN (C02603) 를 넣으면 안됨.-->
 		<query id="common.jobs.getDropMinCntrtid" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
				SELECT  MIN(SA.CNTRT_ID) CNTRT_ID
				FROM TN_CLM_CONTRACT_CNSD SA, TN_CLM_CONTRACT_MASTER SB
				WHERE SA.CNSDREQ_ID = :cnsdreq_id AND SA.CNTRT_ID = SB.CNTRT_ID AND SB.DEL_YN = 'N'
				]]>
			</statement>														 	
		</query>		 	 
		
		<!-- Drop되는 의뢰건 혹은 계약건 조회 (해당부서에서 부서장의 EMP_NO가 사용자테이블에 없을경우 메일이 발송안됨.) 
			결재후처리(postproc_yn)에서 호출될경우 마스터에 사유가 [AUTO DROP]이고 [계약_변경_요청일]이 결재요청일과 동일한 계약을 조회한다.
		-->
 		<query id="common.jobs.getDropReq" isCamelCase="false">																				 
			<statement>																								   
				<![CDATA[
					SELECT 
						M.CNTRT_ID
						,C.CNSDREQ_ID
						,M.CNTRT_RESPMAN_ID
						,RESP_U.EMAIL
						,M.CNTRT_NM
						,M.CNTRTPERIOD_STARTDAY
						,M.CNTRTPERIOD_ENDDAY
						,M.CNTRT_RESPMAN_NM + DBO.DECODE3(M.CNTRT_RESPMAN_JIKGUP_NM, NULL, '', '/' + M.CNTRT_RESPMAN_JIKGUP_NM) + DBO.DECODE3(M.CNTRT_RESP_DEPT_NM, NULL, '', '/' + M.CNTRT_RESP_DEPT_NM) AS CNTRT_RESPMAN_NM
						,R.REQ_TITLE AS TITLE
						,M.PRCS_DEPTH
						,CASE WHEN :session_user_locale= 'ko' THEN D1.CD_NM
								WHEN :session_user_locale= 'fr' THEN D1.CD_NM_FRA
								WHEN :session_user_locale= 'de' THEN D1.CD_NM_DEU
									ELSE D1.CD_NM_ENG
						END PRCS_DEPTH_NM,
						CASE WHEN :session_user_locale= 'ko' THEN D2.CD_NM 
								WHEN :session_user_locale= 'fr' THEN D2.CD_NM_FRA
								WHEN :session_user_locale= 'de' THEN D2.CD_NM_DEU
									ELSE D2.CD_NM_ENG
						END
						+
						CASE WHEN M.DEPTH_STATUS IN ('C02601', 'C02606', 'C02608')
									THEN 
										CASE WHEN R.PLNDBN_REQ_YN = 'Y'
											THEN '(Final)'
											ELSE 
												CASE WHEN REQ_MAX.LVL = '1' THEN '(' + CAST(REQ_MAX.LVL AS NVARCHAR) + 'st)'
														WHEN REQ_MAX.LVL = '2' THEN '(' + CAST(REQ_MAX.LVL AS NVARCHAR) + 'nd)'
														WHEN REQ_MAX.LVL = '3' THEN '(' + CAST(REQ_MAX.LVL AS NVARCHAR) + 'rd)'
														ELSE '(' + CAST(REQ_MAX.LVL AS NVARCHAR) + 'th)'
												END
										END
									ELSE ''
						END 
						AS DEPTH_STATUS_NM
						,M.CNTRT_CNCLSN_YN
						,ISNULL(M.CNTRT_CHGE_DEMND_CAUSE ,'') AS CNTRT_CHGE_DEMND_CAUSE
						,DBO.COM_CNTRT_ORDER(C.CNSDREQ_ID,M.CNTRT_ID) AS cntrt_num_nm
						,CASE
						   WHEN :session_user_locale = 'fr' THEN
						   		dbo.DECODE3 (M.CPY_REGDAY,
								   NULL,
								   'En attente d‘enregistrement',
								   'Enregistrement')
						   WHEN :session_user_locale = 'de' THEN
						   		dbo.DECODE3 (M.CPY_REGDAY,
								   NULL,
								   'Registrierung steht aus.',
								   'Registrierung')
						   ELSE
						   		dbo.DECODE3 (M.CPY_REGDAY,
								   NULL,
								   'Yet to be Registered',
								   'Registration')
						   END CPY_REG_YN
					FROM TN_CLM_CONTRACT_MASTER M
					INNER JOIN TN_CLM_CONTRACT_CNSD C ON M.CNTRT_ID = C.CNTRT_ID
					INNER JOIN TN_CLM_CONT_CNSDREQ R ON R.CNSDREQ_ID = C.CNSDREQ_ID
					INNER JOIN TB_COM_START_PROCESS_WSVO W ON W.REF_KEY IN (
							C.CNTRT_ID
							,C.CNSDREQ_ID
							)
					INNER JOIN TB_COM_USER RESP_U
					ON M.CNTRT_RESPMAN_ID = RESP_U.USER_ID
					INNER JOIN TB_COM_CD D1
					ON D1.CD = M.PRCS_DEPTH
					INNER JOIN TB_COM_CD D2
					ON D2.CD = M.DEPTH_STATUS
					INNER JOIN 
						(SELECT FST_CNSDREQ_ID, MAX(CNSD_LEVEL) AS LVL, MIN(ISNULL(REQ_DT, REG_DT)) AS REQ_DT
							FROM TN_CLM_CONT_CNSDREQ
						WHERE DEL_YN = 'N'
						GROUP BY FST_CNSDREQ_ID) REQ_MAX
					ON  R.FST_CNSDREQ_ID = REQ_MAX.FST_CNSDREQ_ID
					WHERE C.CNSDREQ_ID = :cnsdreq_id
					
					ORDER BY M.REG_DT DESC 
				]]>
			</statement>														 	
		</query>	
		
		<!-- 체결 결재 완료가 되었는데도 불구하고 여전히 업데이트가 안된 놈들을 골라서 결재 진행중으로 바꾸는데 사용하는 쿼리 -->
		<query id="common.jobs.modifyNotUpdatedStartProcessWsvo" isCamelCase="false">
			<statement>
			<![CDATA[
				UPDATE tb_com_start_process_wsvo 
				SET	status = '1' 
				WHERE  mis_id IN (SELECT mis_id 
								  FROM   tb_com_start_process_wsvo 
								  WHERE  1 = 1 
										 AND status = '2' 
										 AND apprvl_clsfcn = 'C03002' 
										 AND nvl(post_process_flag,'x') <> 'B'
										 AND ref_key IN (SELECT A.cnsdreq_id 
														 FROM   tn_clm_cont_cnsdreq A, 
																tn_clm_contract_cnsd C, 
																tn_clm_contract_master D 
														 WHERE  A.del_yn = 'N' 
																AND A.prev_cnsdreq_id IS NOT 
																	NULL 
																AND A.cnsdreq_id = C.cnsdreq_id 
																AND C.cntrt_id = D.cntrt_id 
																AND D.del_yn = 'N' 
																AND D.cntrt_info_gbn NOT IN	-- 사업부 등록, 구시스템 이관이 아닌것 
																	( 'C05403', 'C05499' ) 
																AND D.depth_status IN ( 
																	'C02622', 'C02621' )	   -- 결재중, 작성중 
																AND D.prcs_depth = 'C02502'))  -- 계약체결 
			]]>
	  		</statement>
		</query>	
		
		<!-- 종료 결재 완료가 되었는데도 불구하고 여전히 업데이트가 안된 놈들을 골라서 결재 진행중으로 바꾸는데 사용하는 쿼리 -->
		<query id="common.jobs.modifyNotUpdatedStartProcessWsvoAtEnd" isCamelCase="false">
			<statement>
			<![CDATA[
				UPDATE tb_com_start_process_wsvo 
				SET	status = '1' 
				WHERE  mis_id IN (SELECT mis_id 
								  FROM TB_COM_START_PROCESS_WSVO 
								 WHERE 1=1
								   AND STATUS ='2'
								   AND APPRVL_CLSFCN ='C03003' --종료 품의 
								   AND nvl(POST_PROCESS_FLAG,'x') <> 'B'
								   AND REF_KEY  in (
								SELECT A.CNSDREQ_ID
								  FROM TN_CLM_CONT_CNSDREQ A,
									   TN_CLM_CONTRACT_CNSD C,
									   TN_CLM_CONTRACT_MASTER D
								 WHERE A.DEL_YN = 'N'
								   AND A.PREV_CNSDREQ_ID IS NOT NULL 
								   AND A.CNSDREQ_ID  = C.CNSDREQ_ID
								   AND C.CNTRT_ID	= D.CNTRT_ID
								   AND D.DEL_YN = 'N'
								   AND D.CNTRT_INFO_GBN not in ( 'C05403' ,'C05499')  
								   AND D.DEPTH_STATUS in ( 'C02682')  -- 결재중, 
								   AND D.PRCS_DEPTH ='C02505'   -- 계약종료 
								))
			]]>
	  		</statement>
		</query>					
					
	</queries>
</queryservice>
