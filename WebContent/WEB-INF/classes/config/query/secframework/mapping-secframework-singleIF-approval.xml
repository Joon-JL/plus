<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>

        <!-- ######################################################################### -->
        <!-- ##########                 결재정보 조회                       ########## -->
        <!-- ######################################################################### -->

        <!-- 결재목록 조회 -->
        <query id="secfw.singleIF.approval.listApproval" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT *
                  FROM (
                        SELECT ROWNUM RN
                             , T.*
                             , COUNT(1) OVER() TOTAL_CNT
                          FROM (
                                SELECT A.MODULE_ID
                                     , A.MIS_ID
                                     , A.STATUS
                                     , A.BODY
                                     , A.BODY_TYPE
                                     , CONVERT(CHAR(19), A.CREATE_DATE, 20) AS CREATE_DATE /*YYYY-MM-DD HH24:MI:SS*/
                                     , A.DRM_OPTION_INFO
                                     , A.LOCALE_INFO
                                     , A.NOTI_MAIL
                                     , A.PRIORITY
                                     , A.SECURITY
                                     , A.TIME_ZONE
                                     , A.TITLE
                                     , B.SINGLE_ID
                                     , (SELECT USER_NM
                                          FROM TB_COM_USER
                                         WHERE SINGLE_ID = B.SINGLE_ID
                                       ) AS USER_NM
                                  FROM TB_COM_START_PROCESS_WSVO A
                                     , TB_COM_ROUTE_WSVO B
                                 WHERE 1 = 1
                                   AND A.CREATE_DATE BETWEEN :vo.srch_start_ymd + '000000' AND :vo.srch_end_ymd + '999999'
                        #if ($vo.srch_user_level && !$vo.srch_user_level.equals("A"))
                                   AND (A.MODULE_ID, A.MIS_ID)
                                        IN SELECT MODULE_ID, MIS_ID
                                             FROM TB_COM_ROUTE_WSVO
                                            WHERE SENDER_SINGLE_ID = :vo.srch_single_id
                                              AND ACTIVITY         = :vo.srch_activity
                        #end
                        #if ($vo.srch_status && !$vo.srch_status.equals(""))
                                   AND A.STATUS = :vo.srch_status
                        #end
                                   AND A.MODULE_ID = B.MODULE_ID
                                   AND A.MIS_ID    = B.MIS_ID
                                   AND B.ACTIVITY  = '0'
                               ) T
                         ORDER BY RN
                       )
                 WHERE RN BETWEEN :vo.start_index AND :vo.end_index
            ]]>
            </statement>
        </query>

        <!-- 특정 결재상태인 건을 가져온다. -->
        <query id="secfw.singleIF.approval.listTargetList" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MIS_ID
                     , COUNT(*) OVER() AS TOTAL_CNT
                  FROM TB_COM_START_PROCESS_WSVO
                 WHERE STATUS = :status    AND REF_KEY NOT LIKE 'F%' /*이관 데이타 제외*/
            ]]>
            </statement>
        </query>

        <!-- 결재상신 : 기본정보를 가져온다. -->
        <query id="secfw.singleIF.approval.getApprovalHeader" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT STATUS
                     , BODY
                     , BODY_TYPE
                     , CREATE_DATE
                     , DRM_OPTION_INFO
                     , LOCALE_INFO
                     , NOTI_MAIL
                     , PRIORITY
                     , SECURITY
                     , TIME_ZONE
                     , TITLE
                     , METHOD
                     , REF_KEY
                  FROM TB_COM_START_PROCESS_WSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 결재경로 정보를 가져온다. -->
        <query id="secfw.singleIF.approval.listApprovalPath" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MIS_ID
                     , ACTION_TYPE
                     , ACTIVITY
                     , ALARM_TYPE
                     , APPROVED
                     , ARBITRARY
                     , ARRIVED
                     , BODY_MODIFY
                     , COMP_CODE
                     , COMP_NAME
                     , DEPT_CODE
                     , DEPT_NAME
                     , DURATION
                     , DUTY
                     , DUTY_CODE
                     , GROUP_CODE
                     , GROUP_NAME
                     , MAIL_ADDRESS
                     , OPINION
                     , RESERVED
                     , ROUTE_MODIFY
                     , SEQUENCE
                     , SOCIAL_ID
                     , USER_ID
                     , USER_NAME
                     , DELEGATED
                     , CAST(COUNT(*) OVER() AS NUMERIC) AS TOTAL_CNT
                  FROM TB_COM_ROUTE_WSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
                 ORDER BY CAST(SEQUENCE AS NUMERIC) ASC
            ]]>
            </statement>
        </query>

        <!-- 첨부파일 정보를 가져온다. : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원 -->
        <query id="secfw.singleIF.approval.listApprovalAttach" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT SEQUENCE
                     , FILE_NAME
                     , FILE_SIZE
                     , STORE_LOCATION
                     , COUNT(*) OVER() AS TOTAL_CNT
                  FROM TB_COM_ATTACHMENT_WSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
                 ORDER BY SEQUENCE ASC
            ]]>
            </statement>
        </query>

        <!-- 결재내역 COUNT -->
        <query id="secfw.singleIF.approval.selectApprovalHeaderCount" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT CAST(COUNT(*) AS NUMERIC) AS WSVO_CNT
                     , 'TMP' AS TMP1
                  FROM TB_COM_START_PROCESS_WSVO
                 WHERE REF_KEY       = :ref_key
                   AND APPRVL_CLSFCN = :apprvl_clsfcn
                   AND STATUS        = '1'
            ]]>
            </statement>
        </query>

        <!-- ######################################################################### -->
        <!-- ##########                  결재정보 등록                      ########## -->
        <!-- ######################################################################### -->

        <!-- 결재내역 등록 -->
        <query id="secfw.singleIF.approval.insertApprovalHeader" parameterClass="ApprovalVO" resultClass="int">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_START_PROCESS_WSVO (
                        MODULE_ID
                      , MIS_ID
                      , STATUS
                      , BODY
                      , BODY_TYPE
                      , CREATE_DATE
                      , DRM_OPTION_INFO
                      , LOCALE_INFO
                      , NOTI_MAIL
                      , PRIORITY
                      , SECURITY
                      , TIME_ZONE
                      , TITLE
                      , METHOD
                      , APPRVL_CLSFCN
                      , REF_KEY
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.status
                      , :vo.body
                      , :vo.body_type
                      , :vo.create_date
                      , :vo.drm_option_info
                      , :vo.locale_info
                      , :vo.noti_mail
                      , :vo.priority
                      , :vo.security
                      , :vo.time_zone
                      , :vo.title
                      , :vo.method
                      , :vo.apprvl_clsfcn
                      , :vo.ref_key
                  )
            ]]>
            </statement>
        </query>

        <!-- 결재경로 등록 -->
        <query id="secfw.singleIF.approval.insertApprovalPath" parameterClass="ApprovalRouteVO" resultClass="int">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_ROUTE_WSVO (
                        MODULE_ID
                      , MIS_ID
                      , ACTION_TYPE
                      , ACTIVITY
                      , ALARM_TYPE
                      , APPROVED
                      , ARBITRARY
                      , ARRIVED
                      , BODY_MODIFY
                      , COMP_CODE
                      , COMP_NAME
                      , DEPT_CODE
                      , DEPT_NAME
                      , DURATION
                      , DUTY
                      , DUTY_CODE
                      , GROUP_CODE
                      , GROUP_NAME
                      , MAIL_ADDRESS
                      , OPINION
                      , RESERVED
                      , ROUTE_MODIFY
                      , SEQUENCE
                      , SOCIAL_ID
                      , USER_ID
                      , USER_NAME
                      , DELEGATED
                  ) VALUES (
                        CASE WHEN :vo.module_id     IS NULL THEN NULL ELSE SUBSTRING(:vo.module_id		, 1, 100) END
                      , CASE WHEN :vo.mis_id        IS NULL THEN NULL ELSE SUBSTRING(:vo.mis_id			, 1, 32	) END
                      , CASE WHEN :vo.action_type   IS NULL THEN NULL ELSE SUBSTRING(:vo.action_type	, 1, 1	) END
                      , CASE WHEN :vo.activity      IS NULL THEN NULL ELSE SUBSTRING(:vo.activity		, 1, 1	) END
                      , CASE WHEN :vo.alarm_type    IS NULL THEN NULL ELSE SUBSTRING(:vo.alarm_type		, 1, 1	) END
                      , CASE WHEN :vo.approved      IS NULL THEN NULL ELSE SUBSTRING(:vo.approved		, 1, 14	) END
                      , CASE WHEN :vo.arbitrary     IS NULL THEN NULL ELSE SUBSTRING(:vo.arbitrary		, 1, 2	) END
                      , CASE WHEN :vo.arrived       IS NULL THEN NULL ELSE SUBSTRING(:vo.arrived		, 1, 14	) END
                      , CASE WHEN :vo.body_modify   IS NULL THEN NULL ELSE SUBSTRING(:vo.body_modify	, 1, 2	) END
                      , CASE WHEN :vo.comp_code     IS NULL THEN NULL ELSE SUBSTRING(:vo.comp_code		, 1, 100) END
                      , CASE WHEN :vo.comp_name     IS NULL THEN NULL ELSE SUBSTRING(:vo.comp_name		, 1, 50	) END
                      , CASE WHEN :vo.dept_code     IS NULL THEN NULL ELSE SUBSTRING(:vo.dept_code		, 1, 20	) END
                      , CASE WHEN :vo.dept_name     IS NULL THEN NULL ELSE SUBSTRING(:vo.dept_name		, 1, 100) END
                      , CASE WHEN :vo.duration      IS NULL THEN NULL ELSE SUBSTRING(:vo.duration		, 1, 1	) END
                      , CASE WHEN :vo.duty          IS NULL THEN NULL ELSE SUBSTRING(:vo.duty			, 1, 100) END
                      , CASE WHEN :vo.duty_code     IS NULL THEN NULL ELSE SUBSTRING(:vo.duty_code		, 1, 30	) END
                      , CASE WHEN :vo.group_code    IS NULL THEN NULL ELSE SUBSTRING(:vo.group_code		, 1, 30	) END
                      , CASE WHEN :vo.group_name    IS NULL THEN NULL ELSE SUBSTRING(:vo.group_name		, 1, 50	) END
                      , CASE WHEN :vo.mail_address  IS NULL THEN NULL ELSE SUBSTRING(:vo.mail_address	, 1, 100) END
                      , CASE WHEN :vo.opinion       IS NULL THEN NULL ELSE SUBSTRING(:vo.opinion		, 1, 3000) END
                      , CASE WHEN :vo.reserved      IS NULL THEN NULL ELSE SUBSTRING(:vo.reserved		, 1, 14	) END
                      , CASE WHEN :vo.route_modify  IS NULL THEN NULL ELSE SUBSTRING(:vo.route_modify	, 1, 2	) END
                      , CASE WHEN :vo.sequence      IS NULL THEN NULL ELSE SUBSTRING(:vo.sequence		, 1, 3	) END
                      , NULL
                      , CASE WHEN :vo.user_id       IS NULL THEN NULL ELSE SUBSTRING(:vo.user_id		, 1, 100) END
                      , CASE WHEN :vo.user_name     IS NULL THEN NULL ELSE SUBSTRING(:vo.user_name		, 1, 100) END
                      , CASE WHEN :vo.delegated     IS NULL THEN NULL ELSE SUBSTRING(:vo.delegated		, 1, 1	) END
                  )
            ]]>
            </statement>
        </query>

        <!-- 결재 첨부파일 내역 등록 : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원 -->
        <!--
        <query id="secfw.singleIF.approval.insertApprovalAttach" parameterClass="ApprovalAttachmentVO" resultClass="int">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_ATTACHMENT_WSVO (
                        MODULE_ID
                      , MIS_ID
                      , SEQUENCE
                      , FILE_NAME
                      , FILE_SIZE
                      , STORE_LOCATION
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.sequence
                      , :vo.file_name
                      , :vo.file_size
                      , :vo.store_location
                  )
            ]]>
            </statement>
        </query>
        -->

        <!-- ######################################################################### -->
        <!-- ##########                  결재정보 업데이트                  ########## -->
        <!-- ######################################################################### -->

        <!-- 결재내역 수정 -->
        <query id="secfw.singleIF.approval.modifyApprovalContent">
            <statement>
            <![CDATA[
                UPDATE TB_COM_START_PROCESS_WSVO
                   SET STATUS          = :vo.status
                     , BODY            = :vo.body
                     , BODY_TYPE       = :vo.body_type
                     , CREATE_DATE     = :vo.create_date
                     , DRM_OPTION_INFO = :vo.drm_option_info
                     , LOCALE_INFO     = :vo.locale_info
                     , NOTI_MAIL       = :vo.noti_mail
                     , PRIORITY        = :vo.priority
                     , SECURITY        = :vo.security
                     , TIME_ZONE       = :vo.time_zone
                     , TITLE           = :vo.title
                WHERE MODULE_ID = :vo.module_id
                  AND MID_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- 결재 전송결과를 업데이트 한다. -->
        <query id="secfw.singleIF.approval.modifyStatus">
            <statement>
            <![CDATA[
                UPDATE TB_COM_START_PROCESS_WSVO
                   SET STATUS    = :status
                   ,UPDATE_DATETIME = GETDATE() 
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 결재 후처리 프로세스의 결과를 업데이트 한다. -->
        <query id="secfw.singleIF.approval.modifyApprovalPostProcessFlag">
            <statement>
            <![CDATA[
                UPDATE TB_COM_START_PROCESS_WSVO
                   SET POST_PROCESS_FLAG = :vo.post_process_flag
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- ######################################################################### -->
        <!-- ##########                  결재정보 삭제                      ########## -->
        <!-- ######################################################################### -->

        <!-- 결재기본정보 삭제 -->
        <query id="secfw.singleIF.approval.deleteApprovalHeader">
            <statement>
            <![CDATA[
                DELETE TB_COM_START_PROCESS_WSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- 결재경로 삭제 -->
        <query id="secfw.singleIF.approval.deleteApprovalPath">
            <statement>
            <![CDATA[
                DELETE TB_COM_ROUTE_WSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 결재첨부 삭제 : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원 -->
        <!--
        <query id="secfw.singleIF.approval.deleteApprovalAttach">
            <statement>
            <![CDATA[
                DELETE TB_COM_ATTACHMENT_WSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>
        -->

        <!-- ######################################################################### -->
        <!-- ##########                  예외발생                           ########## -->
        <!-- ######################################################################### -->

        <!-- 에러순번을 생성한다. -->
        <query id="secfw.singleIF.approval.genErrorSeq" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT ISNULL(MAX(SEQUENCE),0) + 1 AS SEQ
                  FROM TB_COM_ESB_FAULT_VO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 에러메세지를 남긴다. -->
        <query id="secfw.singleIF.approval.insertError">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_ESB_FAULT_VO (
                        MODULE_ID
                      , MIS_ID
                      , SEQUENCE
                      , FAULT_ACTOR1
                      , FAULT_CODE1
                      , FAULT_STRING1
                      , FAULT_MESSAGE
                      , CREATE_DATE
                  ) VALUES (
                        :module_id
                      , :mis_id
                      , :sequence
                      , :fault_actor1
                      , :fault_code1
                      , :fault_string1
                      , :fault_message
                      , CONVERT(CHAR(8), GETDATE(), 112)+REPLACE(CONVERT(VARCHAR(10),GETDATE(),24),':','') /*YYYYMMDDHH24MISS*/
                  )
            ]]>
            </statement>
        </query>

        <!-- ######################################################################### -->
        <!-- ##########                  후속프로세스(샘플)                 ########## -->
        <!-- ######################################################################### -->
        
        <!-- 법무시스템 날인 및 증명서류 발급 신청 결재승인후 상태코드 변경처리를 위한 날인신청건 조회 -->
        <query id="secfw.singleIF.approval.selectPostProcessSign" isCamelCase="false">
            <statement>
            <![CDATA[
					
					 SELECT CAST(B.APL_SQN AS NVARCHAR) AS APL_SQN_CHAR
                     , A.STATUS
                     , A.APPRVL_CLSFCN
                     , A.CREATE_DATE
                     , ISNULL((SELECT TOP 1 LAST_LOCALE
                              FROM TB_COM_USER SA
                                 , TB_COM_ROUTE_WSVO SB
                             WHERE SA.EMAIL     = SB.MAIL_ADDRESS
                               AND SB.MODULE_ID = A.MODULE_ID
                               AND SB.MIS_ID    = A.MIS_ID
                               AND SB.ACTIVITY  = '0'
                               AND SB.MAIL_ADDRESS IS NOT NULL
                              ), 'en') GIAN_LOCALE
                  FROM TB_COM_START_PROCESS_WSVO A
                     , TN_CLM_PRTB_SD_APL B

                 WHERE
                       A.REF_KEY = CAST(B.APL_SQN AS NVARCHAR)
                   AND A.MIS_ID     = :vo.mis_id
                   AND A.MODULE_ID  = :vo.module_id
                   
            ]]>
            </statement>
        </query>
        
        <!-- 후속프로세스(날인신청 결재처리) -->
        <query id="secfw.singleIF.approval.updatePostProcessSignStatus">
            <statement>
            <![CDATA[
 					UPDATE  TN_CLM_PRTB_SD_APL 
                   SET  
                   		SEAL_RQST_STATUS = :seal_rqst_status 	        	      
	        	      , MOD_DT = GETDATE() 
    	        	  , MOD_ID = 'ESB_APPR_BAT'
        	     	  , MOD_NM = 'ESB_APPR_BAT'        	     	  
                WHERE APL_SQN = :apl_sqn
            ]]>
            </statement>
        </query>
        

        <!-- 후속프로세스(샘플) -->
        <query id="secfw.singleIF.approval.insertPostProcessSample">
            <statement>
            <![CDATA[
                INSERT INTO TEST_POST_APPROVAL (
                        MODULE_ID
                      , MIS_ID
                      , STATUS
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.status
                  )
            ]]>
            </statement>
        </query>

		<!-- Sungwoo 2014-06-12 Replacement Query -->
        <!-- 계약관리시스템 결재승인후 상태코드 변경처리를 위한 의뢰건 혹은 계약건 조회 -->
        <query id="secfw.singleIF.approval.selectPostAppContStatus" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT C.CNSDREQ_ID
                     , MIN(D.CNTRT_ID) CNTRT_ID
                     , A.STATUS
                     , A.APPRVL_CLSFCN
                     , A.CREATE_DATE
                     , ISNULL((SELECT TOP 1 LAST_LOCALE
                              FROM TB_COM_USER SA
                                 , TB_COM_ROUTE_WSVO SB
                             WHERE SA.EMAIL     = SB.MAIL_ADDRESS
                               AND SB.MODULE_ID = A.MODULE_ID
                               AND SB.MIS_ID    = A.MIS_ID
                               AND SB.ACTIVITY  = '0'
                               AND SB.MAIL_ADDRESS IS NOT NULL
                           ), 'en') GIAN_LOCALE
                 FROM TN_CLM_CONTRACT_MASTER E
					 LEFT JOIN TN_CLM_CONTRACT_CNSD D
					 ON D.CNTRT_ID   = E.CNTRT_ID
					 LEFT JOIN TN_CLM_CONT_CNSDREQ C
					 ON C.CNSDREQ_ID = D.CNSDREQ_ID
					 LEFT JOIN TB_COM_START_PROCESS_WSVO A
					 /* 검토 품의(C03001), 체결 품의(C03002), 체결후등록(C03004), 종료품의(C03003) */
					 ON A.REF_KEY = DBO.DECODE3(A.APPRVL_CLSFCN, 'C03003', D.CNTRT_ID, D.CNSDREQ_ID)
                 WHERE
                   A.STATUS     = :status /* 완결 */
                   AND ISNULL(A.POST_PROCESS_FLAG, 'X') != 'B'
                   AND E.DEL_YN     = 'N'
                   AND E.DEPTH_STATUS NOT IN ('C02603')
                   AND A.MIS_ID     = :mis_id
                   AND A.MODULE_ID  = :module_id
                 GROUP BY C.CNSDREQ_ID, A.STATUS, A.APPRVL_CLSFCN, A.CREATE_DATE, A.MODULE_ID, A.MIS_ID
            ]]>
            </statement>
        </query>

        <!-- 계약관리시스템 결재승인후 상태코드 변경처리를 위한 의뢰건 혹은 계약건 수정 -->
        <query id="secfw.singleIF.approval.updatePostAppContStatus" isCamelCase="false">
            <statement>
            <![CDATA[
             BEGIN
                #if($apprvl_clsfcn.equals("C03001")) /* 검토 품의 */
                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET ACPT_DT = GETDATE()
                             , PRGRS_STATUS = (SELECT DBO.DECODE5(C.CNCLSNPURPS_BIGCLSFCN, 'T0301', 'C04203', 'T0303', 'C04203', 'C04203')
                                                 FROM (SELECT MIN(SA.CNTRT_ID) CNTRT_ID
                                                         FROM TN_CLM_CONTRACT_CNSD SA
                                                            , TN_CLM_CONTRACT_MASTER SB
                                                        WHERE SA.CNSDREQ_ID = :cnsdreq_id
                                                          AND SA.CNTRT_ID   = SB.CNTRT_ID
                                                          AND SB.DEL_YN     = 'N'
                                                          AND SB.DEPTH_STATUS NOT IN ('C02603')
                                                      ) B
                                                    , TN_CLM_CONTRACT_MASTER C
                                                WHERE B.CNTRT_ID = C.CNTRT_ID)
                    	FROM TN_CLM_CONT_CNSDREQ A
                        WHERE A.CNSDREQ_ID = :cnsdreq_id;

                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET DEPTH_STATUS = 'C02606'
                        FROM TN_CLM_CONTRACT_MASTER A   
                        WHERE EXISTS (SELECT *
                                         FROM TN_CLM_CONTRACT_CNSD B
                                        WHERE A.CNTRT_ID   = B.CNTRT_ID
                                          AND B.CNSDREQ_ID = :cnsdreq_id
                                          AND A.DEL_YN     = 'N'
                                      )
                           AND A.DEPTH_STATUS NOT IN ('C02603');

                #elseif($apprvl_clsfcn.equals("C03002")) /* 체결 품의. B는 결제완료된것을 ROLLBACK 한 것임 */
                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET MOD_DT = GETDATE()
                             , PRGRS_STATUS = 'C04217'
                         WHERE CNSDREQ_ID   = :cnsdreq_id
                           AND PRGRS_STATUS = 'C04214';

                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET MOD_DT = GETDATE()
                           	 , DEPTH_STATUS = 'C02641'
                             , PRCS_DEPTH   = 'C02503'
                             , CNTRT_CHGE_DEMND_CAUSE = CASE WHEN A.DEPTH_STATUS IN ('C02622','C02624','C02625','C02626')
                                                                  THEN CNTRT_CHGE_DEMND_CAUSE
                                                                  ELSE CASE WHEN :vo.session_user_locale = 'ko'
                                                                                 THEN 'AUTO DROP이 아닌 체결미확인으로 상태값 변경(' + A.CNTRT_STATUS + ', '+ A.PRCS_DEPTH +', '+ A.DEPTH_STATUS +')'
                                                                            WHEN :vo.session_user_locale = 'fr'
                                                                                 THEN 'Le statut a été changé en ""Conclusion non vérifiée"", pas d‘ABANDON AUTOMATIQUE(' + A.CNTRT_STATUS + ', '+ A.PRCS_DEPTH +', '+ A.DEPTH_STATUS +')'
                                                                            WHEN :vo.session_user_locale = 'de'
                                                                                 THEN 'Status change to Unchecked Conclusion, not AUTO DROP(' + A.CNTRT_STATUS + ', '+ A.PRCS_DEPTH +', '+ A.DEPTH_STATUS +')'
                                                                            ELSE 'Status change to Unchecked Conclusion, not AUTO DROP(' + A.CNTRT_STATUS + ', '+ A.PRCS_DEPTH +', '+ A.DEPTH_STATUS +')'
                                                                       END
                                                        END
                        FROM TN_CLM_CONTRACT_MASTER A
                         WHERE EXISTS (SELECT *
                                         FROM TN_CLM_CONTRACT_CNSD B
                                        WHERE A.CNTRT_ID   = B.CNTRT_ID
                                          AND B.CNSDREQ_ID = :cnsdreq_id
                                          AND A.DEL_YN     = 'N'
                                          AND A.DEPTH_STATUS NOT IN ('C02603'))
                           AND A.PRCS_DEPTH IN ('C02501', 'C02502');

                #elseif($apprvl_clsfcn.equals("C03004")) /* 체결등록 품의 */
                        -- C02636(확인중)
                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET DEPTH_STATUS = 'C02636', MOD_DT = GETDATE()
                         WHERE CNTRT_ID     = :cntrt_id
                           AND DEPTH_STATUS = 'C02632';

                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET PRGRS_STATUS = 'C04213'
                        FROM TN_CLM_CONT_CNSDREQ A
                         WHERE CNSDREQ_ID   = :cnsdreq_id
                           AND 0 = (SELECT COUNT(C.DEPTH_STATUS)
                                      FROM TN_CLM_CONTRACT_CNSD B
                                         , TN_CLM_CONTRACT_MASTER C
                                     WHERE A.CNSDREQ_ID = B.CNSDREQ_ID
                                       AND B.CNTRT_ID   = C.CNTRT_ID
                                       AND C.DEL_YN     = 'N'
                                       AND C.DEPTH_STATUS NOT IN ('C02662', 'C02681', 'C02682', 'C02636', 'C02685', 'C02686', 'C02687', 'C02688', 'C02603'));
                                       /* C02662(이행중) C02681(종료대상) C02682(결재중) C02636 (확인중) */
                                       /* C02685 확인중, C02687 계약종료(변경), C02686 계약종료(만료), C02688 계약종료(해지), DROP */

                #elseif($apprvl_clsfcn.equals("C03003")) /* 종료 품의 */
                        UPDATE TN_CLM_CONTRACT_MASTER
                        /* Sungwoo Changed Status C02686 (Expired) -> C02689 (Terminated) 2014-06-06 */
                           SET DEPTH_STATUS = DBO.DECODE5(CNTRT_STATUS, 'C02404', 'C02689', 'C02405', 'C02688', DEPTH_STATUS) /* 계약상태 'C02404'(만료), 'C02405'(해지) */
                           	   , MOD_DT = GETDATE()
                         WHERE CNTRT_ID     = :cntrt_id
                           AND DEPTH_STATUS = 'C02682';

                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET PRGRS_STATUS = 'C04223'
                        FROM TN_CLM_CONT_CNSDREQ A
                         WHERE CNSDREQ_ID   = :cnsdreq_id
                           AND 0 = (SELECT COUNT(C.DEPTH_STATUS)
                                      FROM TN_CLM_CONTRACT_CNSD B
                                         , TN_CLM_CONTRACT_MASTER C
                                     WHERE A.CNSDREQ_ID = B.CNSDREQ_ID
                                       AND B.CNTRT_ID   = C.CNTRT_ID
                                       AND C.DEL_YN     = 'N'
                                       AND C.DEPTH_STATUS NOT IN ('C02685', 'C02686', 'C02687', 'C02688', 'C02603'));
                                       /* C02685 확인중, C02687 계약종료(변경), C02686 계약종료(만료), C02688 계약종료(해지), DROP */
                #end
            END;
            ]]>
            </statement>
        </query>

        <!-- 계약관리시스템 결재(반려후 상태코드 변경처리를 위한 의뢰건 혹은 계약건 수정 -->
        <query id="secfw.singleIF.approval.updateReturnPostAppContStatus" isCamelCase="false">
            <statement>
            <![CDATA[
            BEGIN
                #if ($apprvl_clsfcn.equals("C03001"))
                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET DEPTH_STATUS = 'C02601'
                        FROM TN_CLM_CONTRACT_MASTER A   
                         WHERE EXISTS (SELECT *
                                         FROM TN_CLM_CONTRACT_CNSD B
                                        WHERE A.CNTRT_ID   = B.CNTRT_ID
                                          AND B.CNSDREQ_ID = :cnsdreq_id
                                          AND A.DEL_YN     = 'N'
                                          AND A.DEPTH_STATUS NOT IN ('C02603'));

                #elseif($apprvl_clsfcn.equals("C03002"))
                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET MOD_DT = GETDATE()
                             , PRGRS_STATUS = 'C04211'
                         WHERE CNSDREQ_ID   = :cnsdreq_id
                           AND PRGRS_STATUS = 'C04214';

                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET DEPTH_STATUS = 'C02621'
                             , PRCS_DEPTH   = 'C02502'
                             , CNTRT_STATUS = 'C02401'
                             , MOD_DT = GETDATE()
                        FROM TN_CLM_CONTRACT_MASTER A
                         WHERE EXISTS (SELECT *
                                         FROM TN_CLM_CONTRACT_CNSD B
                                        WHERE A.CNTRT_ID   = B.CNTRT_ID
                                          AND B.CNSDREQ_ID = :cnsdreq_id
                                          AND A.DEL_YN     = 'N'
                                          AND A.DEPTH_STATUS IN ('C02622'));

                        UPDATE TN_CLM_CONTRACT_MASTER
                           SET DEPTH_STATUS           = 'C02621'
                             , PRCS_DEPTH             = 'C02502'
                             , CNTRT_STATUS           = 'C02401'
                             , CNTRT_CHGE_DEMND_CAUSE = NULL
                        FROM TN_CLM_CONTRACT_MASTER A     
                         WHERE EXISTS (SELECT *
                                         FROM TN_CLM_CONTRACT_CNSD B
                                        WHERE A.CNTRT_ID   = B.CNTRT_ID
                                          AND B.CNSDREQ_ID = :cnsdreq_id
                                          AND A.DEL_YN     = 'N'
                                          AND CHARINDEX('[AUTO DROP]',A.CNTRT_CHGE_DEMND_CAUSE ) > 0);
										  		
                #elseif($apprvl_clsfcn.equals("C03004"))
					UPDATE TN_CLM_CONTRACT_MASTER
                           SET	DEPTH_STATUS = 
								CASE 
									WHEN SYS_NM = 'TNC' then 'C02635'
									ELSE 'C02631'
								END
							,MOD_DT = GETDATE()
                         WHERE CNTRT_ID     = :cntrt_id
                           AND DEPTH_STATUS = 'C02632';
                           
                           

                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET PRGRS_STATUS = 'C04211'
                         WHERE CNSDREQ_ID   =  :cnsdreq_id
                           AND PRGRS_STATUS = 'C04214';

                #elseif($apprvl_clsfcn.equals("C03003"))
                        UPDATE TN_CLM_CONTRACT_MASTER
                        
                           SET DEPTH_STATUS = CASE WHEN CNTRTPERIOD_ENDDAY > REPLACE(CONVERT(CHAR(10), GETDATE(), 23),'-','') THEN 'C02662'
                                                                                                         ELSE 'C02681'
                                              END
                             , PRCS_DEPTH   = CASE WHEN CNTRTPERIOD_ENDDAY > REPLACE(CONVERT(CHAR(10), GETDATE(), 23),'-','') THEN 'C02504'
                                                                                                         ELSE 'C02505'
                                              END
                             , CNTRT_STATUS = 'C02402', MOD_DT = GETDATE()
                         WHERE CNTRT_ID     = :cntrt_id
                           AND DEPTH_STATUS = 'C02682';

                        UPDATE TN_CLM_CONT_CNSDREQ
                           SET PRGRS_STATUS = (SELECT CASE WHEN CNTRTPERIOD_ENDDAY > REPLACE(CONVERT(CHAR(10), GETDATE(), 23),'-','') THEN 'C04219'
                                                                                                                 ELSE 'C04220'
                                                      END
                                                 FROM TN_CLM_CONTRACT_MASTER SA
                                                WHERE SA.CNTRT_ID = :cntrt_id)
                        FROM TN_CLM_CONT_CNSDREQ A
                         WHERE CNSDREQ_ID   = :cnsdreq_id
                           AND PRGRS_STATUS = 'C04221';
                #end
            END;
            ]]>
            </statement>
        </query>

		<!-- 기안자 ESB조회 예외여부 조회 -->
        <query id="secfw.singleIF.approval.listExceptWsvoList" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT USER_ID
                     , USER_NM
                     , JIKGUP_CD
                     , JIKGUP_NM
                     , DEPT_CD
                     , DEPT_NM
                     , COMP_CD
                     , COMP_NM
                     , DIVISION_CD
                     , DIVISION_NM
                     , EMAIL
                     , COMMENTS
                     , REG_ID
                     , REG_DT
                  FROM TB_COM_EXCEPT_WSVO
                 WHERE USER_ID = :user_id
            ]]>
            </statement>
        </query>
        
        <!-- 기안자 ESB조회 예외여부 조회(구주요청에 의한 수정 : 기안자, 기안자의 부서장, 결재가능자를 조회 ) -->
        <query id="secfw.singleIF.approval.listExceptWsvo_NewList" isCamelCase="false">
            <statement>
            <![CDATA[
            SELECT 
				USER_ID
				,USER_NM
				,JIKGUP_CD
				,JIKGUP_NM
				,DEPT_CD
				,DEPT_NM
				,COMP_CD
				,COMP_NM
				,DIVISION_CD
				,DIVISION_NM
				,EMAIL
				,COMMENTS
				,REG_ID
				,REG_DT
				,FLAG
				,APPROVAL_YN
				,SORT
			FROM (
            	/*예외자인 경우*/
                SELECT USER_ID
                     , USER_NM
                     , JIKGUP_CD
                     , JIKGUP_NM
                     , DEPT_CD
                     , DEPT_NM
                     , COMP_CD
                     , COMP_NM
                     , DIVISION_CD
                     , DIVISION_NM
                     , EMAIL
                     , COMMENTS
                     , REG_ID
                     , REG_DT
                     , 'EXCEPT_ID' FLAG
                     , 'N' as APPROVAL_YN
					 ,1 AS SORT
                  FROM TB_COM_EXCEPT_WSVO
                 WHERE USER_ID = :user_id
                 
                 /*예외자가 아닌경우*/
                 UNION ALL
                 SELECT TOP 1 B.USER_ID
                     , B.USER_NM
                     , B.JIKGUP_CD
                     , B.JIKGUP_NM
                     , B.DEPT_CD
                     , B.DEPT_NM
                     , B.COMP_CD
                     , B.COMP_NM
                     , B.DIVISION_CD
                     , B.DIVISION_NM
                     , B.EMAIL
                     , '' COMMENTS
                     , '' REG_ID
                     , '' REG_DT
                     , 'CHECK_ID' FLAG
                     ,B.APPROVAL_YN
					 ,2 AS SORT
                  FROM TB_COM_EXCEPT_WSVO A
				  RIGHT OUTER JOIN
				  TB_COM_USER B ON A.USER_ID = B.USER_ID
                 WHERE NOT EXISTS( SELECT 'E' FROM TB_COM_EXCEPT_WSVO WHERE USER_ID = :user_id )
                 AND B.USER_ID = :user_id
                  /*구주요청사항 : 결재가능여부*/
                 UNION ALL
                 SELECT AA.USER_ID
                     , AA.USER_NM
                     , AA.JIKGUP_CD
                     , AA.JIKGUP_NM
                     , AA.DEPT_CD
                     , AA.DEPT_NM
                     , AA.COMP_CD
                     , AA.COMP_NM
                     , AA.DIVISION_CD
                     , AA.DIVISION_NM
                     , AA.EMAIL
                     , '' COMMENTS
                     , '' REG_ID
                     , AA.REG_DT
                     , AA.FLAG
                     , AA.APPROVAL_YN
					 ,3 AS SORT
				FROM (
		                 SELECT SC.USER_ID
		                     , SC.USER_NM
		                     , SC.JIKGUP_CD
		                     , SC.JIKGUP_NM
		                     , SC.DEPT_CD
		                     , SC.DEPT_NM
		                     , SC.COMP_CD
		                     , SC.COMP_NM
		                     , SC.DIVISION_CD
		                     , SC.DIVISION_NM
		                     , SC.EMAIL
		                     , '' COMMENTS
		                     , '' REG_ID
		                     , SC.REG_DT
		                     , 'APP_Y_ID' FLAG
		                     ,CASE WHEN (select count(role_cd) from tb_com_role_user WHERE USER_ID  = SC.USER_ID  and role_cd in ('RA01','RD01','RM00')) > 0
								   then 'Y'
								   else 'N'
								   End as APPROVAL_YN   /*legaladmin인 권한자와 APPROVAL_YN = 'Y' 인 유저는 결재상신창에서 삭제불가로 만들기 위한 조건*/
		                  FROM TB_COM_USER SA, TB_COM_USER SC
		                 WHERE SA.USER_ID = :user_id
		                 	AND SA.COMP_CD = SC.COMP_CD  
							AND SC.APPROVAL_YN = 'Y'
					) AA
				WHERE AA.USER_ID <> :user_id
                 /*구주요청사항  : 부서장*/
                 UNION ALL
                 SELECT AA.USER_ID
                     , AA.USER_NM
                     , AA.JIKGUP_CD
                     , AA.JIKGUP_NM
                     , AA.DEPT_CD
                     , AA.DEPT_NM
                     , AA.COMP_CD
                     , AA.COMP_NM
                     , AA.DIVISION_CD
                     , AA.DIVISION_NM
                     , AA.EMAIL
                     , '' COMMENTS
                     , '' REG_ID
                     , AA.REG_DT
                     , AA.FLAG
                     , AA.APPROVAL_YN
					 ,4 AS SORT
				FROM (
		                 SELECT SC.USER_ID
		                     , SC.USER_NM
		                     , SC.JIKGUP_CD
		                     , SC.JIKGUP_NM
		                     , SC.DEPT_CD
		                     , SC.DEPT_NM
		                     , SC.COMP_CD
		                     , SC.COMP_NM
		                     , SC.DIVISION_CD
		                     , SC.DIVISION_NM
		                     , SC.EMAIL
		                     , '' COMMENTS
		                     , '' REG_ID
		                     , SC.REG_DT
		                     , 'MGR_ID' FLAG
		                     , 'N' as APPROVAL_YN
		                  FROM TB_COM_USER SA, TB_COM_DEPT SB, TB_COM_USER SC
		                 WHERE SA.USER_ID = :user_id
		                 	AND SA.DEPT_CD = SB.DEPT_CD  
							AND SB.DEPT_MGR_EMP_NO IS NOT NULL
							AND SB.DEPT_MGR_EMP_NO IN (SC.SINGLE_ID, SC.EMP_NO)
							-- AND SA.APPROVAL_YN <> 'Y'
					) AA
				WHERE AA.USER_ID <> :user_id           
			) AA
			ORDER BY SORT, APPROVAL_YN DESC     
            ]]>
            </statement>
        </query>

		<!--  계약 조건 정보 가져오기 -->
		<query id="secfw.singleIF.approval.cntrtMasterInfo" isCamelCase="false">
            <statement>
            <![CDATA[
            SELECT BIZ_CLSFCN,DEPTH_CLSFCN,CNCLSNPURPS_BIGCLSFCN,CNCLSNPURPS_MIDCLSFCN,AUTO_RNEW_YN,CNTRT_AMT , RELATED_PRODUCTS 
            ,(select count(*) from TN_CLM_REQU_ITEM where cntrt_id=:cntrt_id) as REQU_ITEM
            ,(select distinct SUBSTRING(req_title,1,3) from (select  ROW_NUMBER() OVER (PARTITION BY a.cntrt_id ORDER BY a.cnsdreq_id DESC) as no,req_title 
            from tn_clm_contract_cnsd a,TN_CLM_CONT_CNSDREQ b where a.cnsdreq_id = b.CNSDREQ_ID and a.CNTRT_ID=:cntrt_id ) x where x.no =1) as req_title_sub
            FROM TN_CLM_CONTRACT_MASTER 
            WHERE CNTRT_ID =:cntrt_id
            
            ]]>
            </statement>
        </query>

		<!--  Approval path 조건 정보 가져오기 -->
		<query id="secfw.singleIF.approval.approvalInfo" isCamelCase="false">
            <statement>
            <![CDATA[

				SELECT A.COMP_CD,A.PATH_ID, A.PRIORITY, A.MANDATORY, B.CONDITION,B.OPERATION,B.CONDITION_OPTION,B.CONDITION_VAL, A.TYPE_1 ,A.TYPE_2 ,A.TYPE_3 ,A.TYPE_4 
				FROM TN_CLM_APPROVAL_CONT A left OUTER JOIN TN_CLM_APPROVAL_CONT_DETAIL B on A.PATH_ID  =B.PATH_ID and b.DEL_YN <> 'Y'
				WHERE A.USE_YN ='Y'
				AND A.DEL_YN <> 'Y'
				and a.COMP_CD = :vo.comp_cd
                ORDER BY CAST(A.PATH_ID AS NUMERIC ) ,b.CONDITION_ID ASC
            
            ]]>
            </statement>
        </query>


		<!--  조건과 계약건이 일치하는지 확인 -->
		<query id="secfw.singleIF.approval.cntrtMasterEqual" isCamelCase="false">
            <statement>
            <![CDATA[
			 SELECT count(*) as ct_count
					FROM TN_CLM_CONTRACT_MASTER 
			        WHERE CNTRT_ID =:vo.cntrt_id
			        #if(!$vo.path_Query.equals(""))
					  and ($vo.path_Query)
					#end
            
            ]]>
            </statement>
        </query>
        
        <query id="secfw.singleIF.approval.isTNCContract" isCamelCase="false">
            <statement>
            <![CDATA[
        	SELECT m.CNTRT_INFO_GBN,
	        	case
				when CNTRT_INFO_GBN = 'C05404' then 'true'
				else 'false'
				end as isTNC
        	FROM TN_CLM_CONTRACT_MASTER m WHERE CNTRT_ID = :vo.cntrt_id
            ]]>
            </statement>
        </query>
        
         <query id="secfw.singleIF.approval.listExceptWsvoListPathForSEF" isCamelCase="false">
            <statement>
            <![CDATA[
            SELECT tt.USER_ID
                     , tt.USER_NM
                     , tt.JIKGUP_CD
                     , tt.JIKGUP_NM
                     , tt.DEPT_CD
                     , tt.DEPT_NM
                     , tt.COMP_CD
                     , tt.COMP_NM
                     , tt.DIVISION_CD
                     , tt.DIVISION_NM
                     , tt.EMAIL
                     , tt.COMMENTS
                     , tt.REG_ID
                     , tt.REG_DT
                     , tt.FLAG
                     , tt.APPROVAL_YN
					 , tt.APPROVAL_type
					 , tt.sort_no 
				from 
					 (
					 SELECT USER_ID
					, USER_NM
					, JIKGUP_CD
					, JIKGUP_NM
					, DEPT_CD
					, DEPT_NM
					, COMP_CD
					, COMP_NM
					, DIVISION_CD
					, DIVISION_NM
					, EMAIL
					,'' as COMMENTS
					,'' as REG_ID
					, REG_DT
					, 'EXCEPT_ID' FLAG
					, 'N' as APPROVAL_YN
					, '0' as APPROVAL_type
					,0 as sort_no
				FROM TB_COM_USER
				WHERE USER_ID =:vo.user_id
				union
								SELECT SC.USER_ID
					,SC.USER_NM
					,SC.JIKGUP_CD
					,SC.JIKGUP_NM
					,SC.DEPT_CD
					,SC.DEPT_NM
					,SC.COMP_CD
					,SC.COMP_NM
					,SC.DIVISION_CD
					,SC.DIVISION_NM
					,SC.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,SC.REG_DT
					, 'CONDITION_ID' FLAG
					,'Y' as APPROVAL_YN   /*legaladmin인 권한자와 APPROVAL_YN = 'Y' 인 유저는 결재상신창에서 삭제불가로 만들기 위한 조건*/
					,a.activity AS APPROVAL_TYPE
					,a.sequence AS SORT_NO
				FROM TB_COM_USER SC, TB_COM_AUTO_APP_PATH a
				WHERE SC.COMP_CD= :vo.comp_cd 
				AND SC.USER_ID <> :vo.user_id
				and SC.comp_cd = a.comp_cd
				and a.div_cd=:vo.req_title_sub
				and a.type_cd=:vo.cnclsnpurps_midclsfcn
				and a.single_id= SC.SINGLE_ID
				) tt
				order by tt.sort_no
            ]]>
            </statement>
        </query>
        
        
		<!-- 조건에 맞는 사용자 리스트 가져오기 -->
        <query id="secfw.singleIF.approval.listExceptWsvoListPathForTNC" isCamelCase="false">
            <statement>
            <![CDATA[
            
            SELECT tt.USER_ID
                     , tt.USER_NM
                     , tt.JIKGUP_CD
                     , tt.JIKGUP_NM
                     , tt.DEPT_CD
                     , tt.DEPT_NM
                     , tt.COMP_CD
                     , tt.COMP_NM
                     , tt.DIVISION_CD
                     , tt.DIVISION_NM
                     , tt.EMAIL
                     , tt.COMMENTS
                     , tt.REG_ID
                     , tt.REG_DT
                     , tt.FLAG
                     , tt.APPROVAL_YN
					 , tt.APPROVAL_type
					 , tt.sort_no
			FROM 
            (
				/* Requester */
				SELECT USER_ID
					, USER_NM
					, JIKGUP_CD
					, JIKGUP_NM
					, DEPT_CD
					, DEPT_NM
					, COMP_CD
					, COMP_NM
					, DIVISION_CD
					, DIVISION_NM
					, EMAIL
					,'' as COMMENTS
					,'' as REG_ID
					, REG_DT
					, 'EXCEPT_ID' FLAG
					, 'N' as APPROVAL_YN
					, '0' as APPROVAL_type
					,0 as sort_no
				FROM TB_COM_USER
				WHERE USER_ID = :vo.user_id 
				
				UNION
				
				/* DEFAULT APPROVOR */
				SELECT SC.USER_ID
					,SC.USER_NM
					,SC.JIKGUP_CD
					,SC.JIKGUP_NM
					,SC.DEPT_CD
					,SC.DEPT_NM
					,SC.COMP_CD
					,SC.COMP_NM
					,SC.DIVISION_CD
					,SC.DIVISION_NM
					,SC.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,SC.REG_DT
					, 'APP_Y_ID' FLAG
					,CASE WHEN (select count(role_cd) from tb_com_role_user WHERE USER_ID  = SC.USER_ID  and role_cd in ('RA01','RD01','RM00')) > 0
						then 'Y'
						else 'N'
						End as APPROVAL_YN   /*legaladmin인 권한자와 APPROVAL_YN = 'Y' 인 유저는 결재상신창에서 삭제불가로 만들기 위한 조건*/
					,'1' AS APPROVAL_TYPE
					,1 AS SORT
				FROM TB_COM_USER SA, TB_COM_USER SC
				WHERE SA.USER_ID = :vo.user_id 
				AND SA.COMP_CD = SC.COMP_CD  
				AND SC.APPROVAL_YN = 'Y'
				AND SC.USER_ID <>:vo.user_id 	
				
				
				UNION 
				/* 부서장 DEPARTMENT LINE MANAGER*/
				SELECT SC.USER_ID
					,SC.USER_NM
					,SC.JIKGUP_CD
					,SC.JIKGUP_NM
					,SC.DEPT_CD
					,SC.DEPT_NM
					,SC.COMP_CD
					,SC.COMP_NM
					,SC.DIVISION_CD
					,SC.DIVISION_NM
					,SC.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,SC.REG_DT
					,'CONDITION_ID' AS FLAG
					,'N' AS APPROVAL_YN
					,'1' AS APPROVAL_TYPE
					,2 AS sort_no
				FROM TB_COM_USER SA
				INNER JOIN TB_COM_DEPT SB ON SA.DEPT_CD = SB.DEPT_CD
				INNER JOIN TB_COM_USER SC ON SB.DEPT_MGR_EMP_NO IS NOT NULL
					AND SB.DEPT_MGR_EMP_NO IN (
						SC.SINGLE_ID
						,SC.EMP_NO
						)
				WHERE SA.USER_ID = :vo.user_id
					AND SC.USER_ID <> :vo.user_id
				
				
							
				
				) tt
				ORDER BY TT.APPROVAL_type, TT.sort_no ASC
            
            ]]>
            </statement>
        </query>
        

		<!-- 조건에 맞는 사용자 리스트 가져오기 -->
        <query id="secfw.singleIF.approval.listExceptWsvoListPath" isCamelCase="false">
            <statement>
            <![CDATA[
                 
            SELECT tt.USER_ID
                     , tt.USER_NM
                     , tt.JIKGUP_CD
                     , tt.JIKGUP_NM
                     , tt.DEPT_CD
                     , tt.DEPT_NM
                     , tt.COMP_CD
                     , tt.COMP_NM
                     , tt.DIVISION_CD
                     , tt.DIVISION_NM
                     , tt.EMAIL
                     , tt.COMMENTS
                     , tt.REG_ID
                     , tt.REG_DT
                     , tt.FLAG
                     , tt.APPROVAL_YN
					 , tt.APPROVAL_type
					 , tt.sort_no
			FROM 
            (
				/* Requester */
				SELECT USER_ID
					, USER_NM
					, JIKGUP_CD
					, JIKGUP_NM
					, DEPT_CD
					, DEPT_NM
					, COMP_CD
					, COMP_NM
					, DIVISION_CD
					, DIVISION_NM
					, EMAIL
					,'' as COMMENTS
					,'' as REG_ID
					, REG_DT
					, 'EXCEPT_ID' FLAG
					, 'N' as APPROVAL_YN
					, '0' as APPROVAL_type
					,0 + 0 as sort_no
				FROM TB_COM_USER
				WHERE USER_ID = :vo.user_id 
				
				UNION
				
				/* DEFAULT APPROVOR */
				SELECT SC.USER_ID
					,SC.USER_NM
					,SC.JIKGUP_CD
					,SC.JIKGUP_NM
					,SC.DEPT_CD
					,SC.DEPT_NM
					,SC.COMP_CD
					,SC.COMP_NM
					,SC.DIVISION_CD
					,SC.DIVISION_NM
					,SC.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,SC.REG_DT
					, 'APP_Y_ID' FLAG
					,CASE WHEN (select count(role_cd) from tb_com_role_user WHERE USER_ID  = SC.USER_ID  and role_cd in ('RA01','RD01','RM00')) > 0
						then 'Y'
						else 'N'
						End as APPROVAL_YN   /*legaladmin인 권한자와 APPROVAL_YN = 'Y' 인 유저는 결재상신창에서 삭제불가로 만들기 위한 조건*/
					,'1' AS APPROVAL_TYPE
					,1 + 10 AS sort_no
				FROM TB_COM_USER SA, TB_COM_USER SC
				WHERE SA.USER_ID = :vo.user_id 
				AND SA.COMP_CD = SC.COMP_CD  
				AND SC.APPROVAL_YN = 'Y'
				AND SC.USER_ID <>:vo.user_id 
				
				UNION 
				/* 부서장 DEPARTMENT LINE MANAGER*/
				SELECT SC.USER_ID
					,SC.USER_NM
					,SC.JIKGUP_CD
					,SC.JIKGUP_NM
					,SC.DEPT_CD
					,SC.DEPT_NM
					,SC.COMP_CD
					,SC.COMP_NM
					,SC.DIVISION_CD
					,SC.DIVISION_NM
					,SC.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,SC.REG_DT
					,'CONDITION_ID' AS FLAG
					,'N' AS APPROVAL_YN
					,'1' AS APPROVAL_TYPE
					,2 + 100 AS sort_no
				FROM TB_COM_USER SA
				INNER JOIN TB_COM_DEPT SB ON SA.DEPT_CD = SB.DEPT_CD
				INNER JOIN TB_COM_USER SC ON SB.DEPT_MGR_EMP_NO IS NOT NULL
					AND SB.DEPT_MGR_EMP_NO IN (
						SC.SINGLE_ID
						,SC.EMP_NO
						)
				WHERE SA.USER_ID = :vo.user_id
					AND SC.USER_ID <> :vo.user_id
				
				UNION
				
				/* 결재라인에 조건에 맞는 사람 */
				SELECT c.USER_ID
					,c.USER_NM
					,c.JIKGUP_CD
					,c.JIKGUP_NM
					,c.DEPT_CD
					,c.DEPT_NM
					,c.COMP_CD
					,c.COMP_NM
					,c.DIVISION_CD
					,c.DIVISION_NM
					,c.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,c.REG_DT
					,'CONDITION_ID' FLAG
					,'M' AS APPROVAL_YN /* Sungwoo replacement 2014-10-04 do not delete and can be move */
					,CASE 
						WHEN d.A_TYPE = '1'
							THEN '1'
						ELSE '2'
						END AS APPROVAL_TYPE
					--,C.USER_LEVEL AS SORT_NO /* Sungwoo replacement 2014-12-01 */
					, D.SORT_NO + 1000 AS sort_no 
				FROM (
					SELECT DISTINCT (AA.USER_ID)
						,A_TYPE
						,AA.SORT_NO
					FROM (
						SELECT ZZ.PATH_ID
							,ZZ.COMP_CD
							,XX.USER_ID
							,ZZ.A_TYPE
							,ZZ.SORT_NO
						FROM TN_CLM_APPROVAL_PATH ZZ
						INNER JOIN TN_CLM_ROLE_PATH XX ON ZZ.ROLE_USER_ID = XX.ROLE_CD
						WHERE ZZ.R_TYPE = 'r'
							AND zz.DEL_YN <> 'Y'
							AND zz.COMP_CD = :vo.comp_cd
							AND (
								xx.REVIEW_YN = 'N'
								OR xx.REVIEW_YN IS NULL
								)
						
						UNION
						
						SELECT PATH_ID
							,COMP_CD
							,ROLE_USER_ID
							,A_TYPE
							,SORT_NO
						FROM TN_CLM_APPROVAL_PATH
						WHERE DEL_YN <> 'Y'
							AND R_TYPE = 'u'
							AND COMP_CD = :vo.comp_cd
						) AA
					WHERE AA.PATH_ID IN (
							(
								SELECT PATH_ID
								FROM TN_CLM_APPROVAL_CONT
								WHERE DEL_YN <> 'Y'
									AND COMP_CD = :vo.comp_cd
									AND PATH_ID IN (#if(!$vo.path_id.equals("")) $vo.path_id #end)
									AND MANDATORY = 'M'
								
								UNION ALL
								
								SELECT PATH_ID
								FROM (
									SELECT ROW_NUMBER() OVER (
											ORDER BY CAST(priority AS NUMERIC) ASC
												,REG_DT DESC
											) RN
										,*
									FROM TN_CLM_APPROVAL_cont
									WHERE DEL_YN <> 'Y'
										AND COMP_CD = :vo.comp_cd
										AND path_id IN (#if(!$vo.path_id.equals("")) $vo.path_id #end)
										AND MANDATORY = 'O'
									) a
								WHERE a.rn = 1
								)
							)
					) D
				INNER JOIN TB_COM_USER c ON D.USER_ID = C.USER_ID
				WHERE D.USER_ID <> :vo.user_id
				
				/* 15개 필수항목 체크여부 */
				/* Brice change $vo.requ_item.equals("Y") to false by request of EHQ 2016/3/10 */
				#if(false)
				UNION
				/*HQ합의자 추가*/
				SELECT a.user_id
					,a.user_nm
					,a.JIKGUP_CD
					,a.JIKGUP_NM
					,a.DEPT_CD
					,a.DEPT_NM
					,a.COMP_CD
					,a.COMP_NM
					,a.DIVISION_CD
					,a.DIVISION_NM
					,a.EMAIL
					,'' COMMENTS
					,'' REG_ID
					,a.reg_dt
					,'CONDITION_ID' FLAG
					,'M' AS APPROVAL_YN /* Sungwoo replacement 2014-10-04 do not delete and can be move */
					,'2' AS APPROVAL_TYPE
					,100 + 1000 AS sort_no
				from tb_com_user a
				INNER JOIN TB_COM_ROLE_USER b
				ON	a.user_id = b.USER_ID
				where a.COMP_CD='HQ'
					#if($vo.related_products.equals("RP010"))
						and a.RELATED_PRODUCTS = 'RP0201'
					#elseif($vo.related_products.equals("RP020"))
						and a.RELATED_PRODUCTS = 'RP0202'
					#elseif($vo.related_products.equals("RP030") || $vo.related_products.equals("RP040"))
						and a.RELATED_PRODUCTS in ('RP0201','RP0202')
					#elseif($vo.related_products.equals("RP040"))
					#end
					and b.sys_cd = 'LAS' 
					and b.role_cd ='HQ01'
				#end
				) tt
				ORDER BY /*TT.APPROVAL_type,*/ TT.sort_no ASC
            ]]>
            </statement>
        </query>
        
        
        <!-- GAIS 입력실패 시 우리쪽 테이블에 저장 (사용안함) -->
        <query id="secfw.singleIF.approval.insertGaisHistory" isCamelCase="false">
            <statement>
            <![CDATA[
                INSERT INTO TH_CLM_GAIS_RESULT (
                        CNSDREQ_ID
                      , CNTRT_ID
                      , SEQNO
                      , REQ_DT
                      , EXEC_YN
                  ) VALUES (
                        :cnsdreq_id
                      , :cntrt_id
                      , (SELECT ISNULL(MAX(SEQNO) + 1, 1) FROM TH_CLM_GAIS_RESULT WHERE CNSDREQ_ID = :cnsdreq_id AND CNTRT_ID = :cntrt_id)
                      , GETDATE()
                      , 'N'
                  )
            ]]>
            </statement>
        </query>
        
        <!-- ref_key로 cntrt_id 가지고 오기 -->
        <query id="secfw.singleIF.approval.findCntrt_id" isCamelCase="false">
            <statement>
            <![CDATA[
                 
            SELECT DISTINCT CNTRT_ID
              FROM TN_CLM_CONTRACT_CNSD
             WHERE CNSDREQ_ID = :vo.ref_key
				
            ]]>
            </statement>
        </query>

    </queries>
</queryservice>
