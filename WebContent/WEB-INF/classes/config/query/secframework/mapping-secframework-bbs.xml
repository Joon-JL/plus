<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
	<queries>
	
        <!--
        *************************************************************
        # 게시글 상세
        *************************************************************
        -->
		
		<!-- 게시글 목록조회 -->
		<query id="secfw.bbs.listBBSDetailPage" isCamelCase="false">
			<statement>
			<![CDATA[
                SELECT *
                  FROM ( SELECT rownum RN, t.*, COUNT(1) over() TOTAL_CNT
                           FROM (
                            -- Business Logic
							SELECT A.SYS_CD, A.BBS_ID, A.NOTICE_ID, A.NOTICE_TITLE, A.NOTICE_CNTNT,
								       A.UP_NOTICE_ID, A.NOTICE_GRP_ID, A.NOTICE_DEPTH, A.NOTICE_ORDER, A.NOTICE_DISP, A.STATUS, 
								       A.URGENCY_YN, A.REF_CNT, A.RECOMMEND_CNT, 
									   A.NOTICE_START_YMD, A.NOTICE_END_YMD, A.NOTICE_YMD, A.FILE_REF_NO,
								       B.USER_NM, B.DEPT_NM, B.COMP_NM, 				       
								       A.REG_ID, B.USER_NM AS REG_NM, TO_CHAR(A.REG_DT,'YYYY-MM-DD') AS REG_DT, 
								       A.MOD_ID, TO_CHAR(A.MOD_DT,'YYYY-MM-DD') AS MOD_DT
				                  FROM TB_COM_BBS_DETAIL A,
				                       TB_COM_USER B
				                 WHERE A.REG_ID = B.USER_ID(+)
				                   AND A.SYS_CD = :vo.sys_cd
								   --AND A.BBS_ID = :vo.bbs_id 2011.03.31 안홍순 임시로 주석처리
				                   AND A.NOTICE_YMD BETWEEN :vo.srch_start_notice_ymd AND :vo.srch_end_notice_ymd
				                   AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN NVL(NOTICE_START_YMD,'10000101') AND NVL(NOTICE_END_YMD,'99991231') 
							   #if ($vo.srch_cntnt_type.equals("title"))
				                   AND A.NOTICE_TITLE LIKE '%' || :vo.srch_cntnt || '%'
							   #else
				                   AND B.USER_NM LIKE '%' || :vo.srch_cntnt || '%'
				               #end
				                 ORDER BY A.NOTICE_GRP_ID DESC, A.NOTICE_DISP
                            -- Business Logic
		                         ) t
                          ORDER BY rn )
                     WHERE rn between :vo.start_index and :vo.end_index
			]]>
			</statement>
		</query>
		
		<!-- 게시글 상세조회 -->
		<query id="secfw.bbs.detailBBSDetail" isCamelCase="false">
			<statement>
			<![CDATA[
				SELECT A.SYS_CD
					,A.BBS_ID
					,A.NOTICE_ID
					,A.NOTICE_TITLE
					,A.NOTICE_CNTNT
					,A.UP_NOTICE_ID
					,A.NOTICE_GRP_ID
					,A.NOTICE_DEPTH
					,A.NOTICE_ORDER
					,A.NOTICE_DISP
					,A.STATUS
					,A.URGENCY_YN
					,A.REF_CNT
					,A.RECOMMEND_CNT
					,A.NOTICE_START_YMD
					,A.NOTICE_END_YMD
					,A.NOTICE_YMD
					,A.FILE_REF_NO
					,A.REG_ID
					,TO_CHAR(A.REG_DT, 'YYYYMMDD') AS REG_DT
					,A.MOD_ID
					,TO_CHAR(A.MOD_DT, 'YYYYMMDD') AS MOD_DT
					,B.USER_NM
					,B.DEPT_NM
					,B.COMP_NM
				FROM TB_COM_BBS_DETAIL A,
				     TB_COM_USER B
				 WHERE A.REG_ID = B.USER_ID(+)
				   AND A.SYS_CD = :vo.sys_cd	 
				   AND A.BBS_ID = :vo.bbs_id
				   AND A.NOTICE_ID = :vo.notice_id
			]]>
			</statement>
		</query>

		<!-- 게시글 등록 -->
		<query id="secfw.bbs.insertBBSDetail">
			<statement>
			<![CDATA[
				INSERT INTO TB_COM_BBS_DETAIL (
				     SYS_CD
					,BBS_ID
					,NOTICE_ID
					,NOTICE_TITLE
					,NOTICE_CNTNT
					,UP_NOTICE_ID
					,NOTICE_GRP_ID
					,NOTICE_DEPTH
					,NOTICE_ORDER
					,NOTICE_DISP
					,STATUS
					,URGENCY_YN
					,REF_CNT
					,RECOMMEND_CNT
					,NOTICE_START_YMD
					,NOTICE_END_YMD
					,NOTICE_YMD
					,FILE_REF_NO
					,REG_ID
					,REG_DT
			) VALUES (
					 :vo.sys_cd
					,:vo.bbs_id
					,:vo.notice_id
					,:vo.notice_title
					,:vo.notice_cntnt
					,:vo.up_notice_id
					,:vo.notice_grp_id
					,:vo.notice_depth
					,:vo.notice_order
					,:vo.notice_disp
					,:vo.status
					,:vo.urgency_yn
					,:vo.ref_cnt
					,:vo.recommend_cnt
					,:vo.notice_start_ymd
					,:vo.notice_end_ymd
					,TO_CHAR(SYSDATE, 'YYYYMMDD')
					,:vo.file_ref_no
					,:vo.reg_id
					,SYSDATE
				)
			]]>
			</statement>
		</query>

		<!-- 게시글 수정 -->
		<query id="secfw.bbs.modifyBBSDetail">
			<statement>
			<![CDATA[
				UPDATE TB_COM_BBS_DETAIL
				   SET NOTICE_TITLE     = :vo.notice_title
				      ,NOTICE_CNTNT     = :vo.notice_cntnt
				      ,STATUS           = :vo.status
				      ,URGENCY_YN       = :vo.urgency_yn
				      ,NOTICE_START_YMD = :vo.notice_start_ymd
				      ,NOTICE_END_YMD   = :vo.notice_end_ymd
				      ,FILE_REF_NO      = :vo.file_ref_no
				      ,MOD_ID           = :vo.mod_id
				      ,MOD_DT           = SYSDATE
				 WHERE SYS_CD           = :vo.sys_cd
				   AND BBS_ID           = :vo.bbs_id
				   AND NOTICE_ID        = :vo.notice_id
			]]>
			</statement>
		</query>

		<!-- 게시글 삭제 -->
		<query id="secfw.bbs.deleteBBSDetail">
			<statement>
			<![CDATA[
				DELETE TB_COM_BBS_DETAIL
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
			]]>
			</statement>
		</query>

        <!-- 
        *************************************************************
        # 게시글 댓글(Reply)
        *************************************************************
        -->

		<!-- 해당 게시글 삭제시 딸려있는 댓글 전체 삭제 -->
		<query id="secfw.bbs.deleteBBSReplyAll">
			<statement>
			<![CDATA[
				DELETE TB_COM_BBS_DETAIL
				 WHERE SYS_CD        = :vo.sys_cd
				   AND BBS_ID        = :vo.bbs_id
				   AND NOTICE_GRP_ID = :vo.notice_grp_id
			]]>
			</statement>
		</query>

        <!-- 
        *************************************************************
        # 게시글 덧글(한줄답변)
        *************************************************************
        -->
		<!-- 해당게시글 조회시 딸려있는 한줄답변 전체조회 -->
		<query id="secfw.bbs.listBBSAppend" isCamelCase="false">
			<statement>
			<![CDATA[
				SELECT A.SYS_CD, A.BBS_ID, A.NOTICE_ID, A.APPEND_SEQ, A.APPEND_CNTNT,
				       A.REG_ID, B.USER_NM AS REG_NM, TO_CHAR(A.REG_DT, 'YYYY-MM-DD HH24:MI:SS') AS REG_DT, A.MOD_ID, TO_CHAR(A.MOD_DT, 'YYYY-MM-DD') AS MOD_DT,
					   B.USER_NM, B.DEPT_NM, B.COMP_NM
				  FROM TB_COM_BBS_APPEND A,
				       TB_COM_USER B
				 WHERE A.REG_ID    = B.USER_ID(+)	
				   AND A.SYS_CD    = :vo.sys_cd			 
				   AND A.BBS_ID    = :vo.bbs_id
				   AND A.NOTICE_ID = :vo.notice_id
				 ORDER BY APPEND_SEQ DESC
			]]>
			</statement>
		</query>

		<!-- 덧글등록 -->
		<query id="secfw.bbs.insertBBSAppend">
			<statement>
			<![CDATA[
				INSERT INTO TB_COM_BBS_APPEND (
					SYS_CD
					,BBS_ID
					,NOTICE_ID
					,APPEND_SEQ
					,APPEND_CNTNT
					,REG_ID
					,REG_DT
				) VALUES (
					:vo.sys_cd
					,:vo.bbs_id
					,:vo.notice_id
					,:vo.append_seq
					,:vo.append_cntnt
					,:vo.reg_id
					,SYSDATE
				)
			]]>
			</statement>
		</query>

		<!-- 덧글등록시 시퀀스 번호 채번 -->
		<query id="secfw.bbs.getBBSAppendSeq" isCamelCase="false">
			<statement>
			<![CDATA[
            	SELECT NVL(MAX(APPEND_SEQ), 0) + 1 AS APPEND_SEQ 
            	  FROM TB_COM_BBS_APPEND
            	 WHERE SYS_CD    = :vo.sys_cd
            	   AND BBS_ID    = :vo.bbs_id
            	   AND NOTICE_ID = :vo.notice_id
            ]]>
			</statement>
		</query>

		<!-- 덧글등록자에 한하여 한줄답변수정 -->
		<query id="secfw.bbs.modifyBBSAppend">
			<statement>
			<![CDATA[
				UPDATE TB_COM_BBS_APPEND
				   SET APPEND_CNTNT = :vo.append_cntnt,
				       MOD_ID       = :vo.mod_id
				 WHERE SYS_CD       = :vo.sys_cd
				   AND BBS_ID       = :vo.bbs_id
				   AND NOTICE_ID    = :vo.notice_id
				   AND APPEND_SEQ   = :vo.append_seq
			]]>
			</statement>
		</query>

		<!-- 덧글등록자에 한하여 한줄답변삭제 -->
		<query id="secfw.bbs.deleteBBSAppend">
			<statement>
			<![CDATA[
				DELETE TB_COM_BBS_APPEND
				 WHERE SYS_CD     = :vo.sys_cd
				   AND BBS_ID     = :vo.bbs_id
				   AND NOTICE_ID  = :vo.notice_id
				   AND APPEND_SEQ = :vo.append_seq
			]]>
			</statement>
		</query>

		<!-- 해당 게시글 삭제시 딸려있는 한줄답변 전체 삭제 -->
		<query id="secfw.bbs.deleteBBSAppendAll">
			<statement>
			<![CDATA[
				DELETE TB_COM_BBS_APPEND
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
			]]>
			</statement>
		</query>

        <!-- 
        *************************************************************
        # 게시글 추천
        *************************************************************
        -->
		<!-- 추천여부조회 -->
		<query id="secfw.bbs.getBBSRecommend" isCamelCase="false">
			<statement>
			<![CDATA[
				SELECT DECODE(MAX(1), NULL, 'N', 'Y') AS GBN
				  FROM TB_COM_BBS_RECOMMEND
				 WHERE SYS_CD = :vo.sys_cd
				   AND BBS_ID = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
				   AND RECOMMEND_USER_ID = :vo.recommend_user_id
			]]>
			</statement>
		</query>

		<!-- 추천등록 -->
		<query id="secfw.bbs.insertBBSRecommend">
			<statement>
			<![CDATA[
				INSERT INTO TB_COM_BBS_RECOMMEND (
					 SYS_CD
					,BBS_ID
					,NOTICE_ID
					,RECOMMEND_USER_ID
					,RECOMMEND_YN
					,RECOMMEND_DT
				) VALUES (
					 :vo.sys_cd
					,:vo.bbs_id
					,:vo.notice_id
					,:vo.recommend_user_id
					,:vo.recommend_yn
					,SYSDATE
				)
 			]]>
			</statement>
		</query>

		<!-- 해당게시글 삭제시 추천정보 삭제 -->
		<query id="secfw.bbs.deleteBBSRecommend">
			<statement>
			<![CDATA[
				DELETE TB_COM_BBS_RECOMMEND
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
			]]>
			</statement>
		</query>

        <!-- 
        *************************************************************
        # 게시글 Utility
        *************************************************************
		-->        
        
        <!-- 게시글 그룹아이디 채번 -->
        <query id="secfw.bbs.getBBSDetailNoticeGrpId" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT NOTICE_ID AS NOTICE_GRP_ID
                  FROM 
	                (
						SELECT NOTICE_ID, UP_NOTICE_ID, NOTICE_DEPTH
		                  FROM (
		                  		SELECT NOTICE_ID, UP_NOTICE_ID, NOTICE_DEPTH
		                          FROM TB_COM_BBS_DETAIL
		                         WHERE SYS_CD = :vo.sys_cd
		                           AND BBS_ID = :vo.bbs_id
		                        )
		                 START WITH NOTICE_ID = :vo.up_notice_id
		                 CONNECT BY NOTICE_ID = PRIOR UP_NOTICE_ID
		             )
                WHERE NOTICE_DEPTH = 1
            ]]>
            </statement>
        </query>

        <!-- 게시글 정렬순번 채번 -->
        <query id="secfw.bbs.getBBSDetailNoticeOrder" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT NVL(MAX(NOTICE_ORDER), 1) + 1 AS NOTICE_ORDER
				  FROM TB_COM_BBS_DETAIL
				 WHERE SYS_CD = :vo.sys_cd
				   AND BBS_ID = :vo.bbs_id
				   AND UP_NOTICE_ID = :vo.up_notice_id
            ]]>
            </statement>
        </query>

        <!-- 게시글 깊이 채번 -->
        <query id="secfw.bbs.getBBSDetailChildNoticeDepth" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT NVL(MAX(NOTICE_DEPTH), 1) + 1 AS NOTICE_DEPTH
				  FROM TB_COM_BBS_DETAIL
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.up_notice_id
            ]]>
            </statement>
        </query>

        <!-- 게시글 조회카운트 증가 -->
        <query id="secfw.bbs.modifyDetailRefCnt">
            <statement>
            <![CDATA[
				UPDATE TB_COM_BBS_DETAIL
				   SET REF_CNT   = REF_CNT + 1
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
            ]]>
            </statement>
        </query>

        <!-- 게시글 추천카운트 증가 -->
        <query id="secfw.bbs.modifyDetailRecommendCnt">
            <statement>
            <![CDATA[
				UPDATE TB_COM_BBS_DETAIL
				   SET RECOMMEND_CNT = RECOMMEND_CNT + 1
				 WHERE SYS_CD    = :vo.sys_cd
				   AND BBS_ID    = :vo.bbs_id
				   AND NOTICE_ID = :vo.notice_id
            ]]>
            </statement>
        </query>

        <!-- 이전글/다음글 NOTICE ID조회 -->
        <query id="secfw.bbs.getBBSPrevNextID" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT NVL(MAX(NOTICE_ID),'N') AS NOTICE_ID
				  FROM TB_COM_BBS_DETAIL
				 WHERE SYS_CD = :vo.sys_cd
				   AND BBS_ID = :vo.bbs_id
				   AND NOTICE_DEPTH = 1
				   AND NOTICE_ORDER = (SELECT MAX(NOTICE_ORDER)
				                         FROM TB_COM_BBS_DETAIL
				                        WHERE SYS_CD = :vo.sys_cd
				                          AND BBS_ID = :vo.bbs_id
				                          AND NOTICE_DEPTH = 1
				                          AND NOTICE_ORDER < (SELECT NOTICE_ORDER
				                                                FROM TB_COM_BBS_DETAIL
				                                               WHERE SYS_CD = :vo.sys_cd
				                                                 AND BBS_ID = :vo.bbs_id
				                                                 AND NOTICE_ID = :vo.notice_id
				                                             )
				                      )
				UNION ALL
				SELECT NVL(MAX(NOTICE_ID),'N') AS NOTICE_ID
				  FROM TB_COM_BBS_DETAIL
				 WHERE SYS_CD = :vo.sys_cd
				   AND BBS_ID = :vo.bbs_id
				   AND NOTICE_DEPTH = 1
				   AND NOTICE_ORDER = (SELECT MIN(NOTICE_ORDER)
				                         FROM TB_COM_BBS_DETAIL
				                        WHERE SYS_CD = :vo.sys_cd
				                          AND BBS_ID = :vo.bbs_id
				                          AND NOTICE_DEPTH = 1
				                          AND NOTICE_ORDER > (SELECT NOTICE_ORDER
				                                                FROM TB_COM_BBS_DETAIL
				                                               WHERE SYS_CD = :vo.sys_cd
				                                                 AND BBS_ID = :vo.bbs_id
				                                                 AND NOTICE_ID = :vo.notice_id
				                                             )
				                      )
            ]]>
            </statement>
        </query>
                
       <!-- 해당글의 하위글의 NOTICE_ID 가져오기 -->
        <query id="secfw.bbs.listBBSChildNoticeId" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT NOTICE_ID, FILE_REF_NO
				  FROM TB_COM_BBS_DETAIL
				 START WITH NOTICE_ID = :vo.notice_id
				 CONNECT BY PRIOR NOTICE_ID = UP_NOTICE_ID
            ]]>
            </statement>
        </query>

       <!-- 댓글 등록시 해당 순번 소팅정보 -->
        <query id="secfw.bbs.listBBSChildDisp" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT ROWNUM RN, NOTICE_ID
  				  FROM TB_COM_BBS_DETAIL B
 				 WHERE SYS_CD = :vo.sys_cd
 				   AND BBS_ID = :vo.bbs_id
 				   AND NOTICE_ID = B.NOTICE_ID
 				 START WITH NOTICE_ID = (SELECT NOTICE_ID
 				      				  	   FROM TB_COM_BBS_DETAIL
						 				  WHERE SYS_CD = :vo.sys_cd
						 				    AND BBS_ID = :vo.bbs_id
						 				    AND NOTICE_DEPTH = 1
										  START WITH NOTICE_ID = :vo.up_notice_id
			 							CONNECT BY NOTICE_ID = PRIOR UP_NOTICE_ID)  
 			   CONNECT BY PRIOR NOTICE_ID = UP_NOTICE_ID
 			   ORDER SIBLINGS BY NOTICE_ORDER
            ]]>
            </statement>
        </query>

       <!-- 댓글 등록시 해당 순번 소팅 -->
        <query id="secfw.bbs.modifyBBSChildDisp">
            <statement>
            <![CDATA[
                UPDATE TB_COM_BBS_DETAIL
                   SET NOTICE_DISP = :notice_disp
                 WHERE SYS_CD    = :sys_cd
                   AND BBS_ID    = :bbs_id
                   AND NOTICE_ID = :notice_id
            ]]>
            </statement>
        </query>
					
	</queries>
</queryservice>
