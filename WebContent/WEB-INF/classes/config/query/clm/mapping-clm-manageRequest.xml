<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>
    
    	<!-- 계약 의뢰정보 - 요청 : 2011.10.13 : dawn -->
		<query id="clm.manage.detailRequest" isCamelCase="false">
		  <statement>
		    <![CDATA[
	        SELECT CNSDREQ_ID
			     , REQ_TITLE AS DEMND_TITLE_NM
			     , REQMAN_ID AS DEMNDMAN_ID
			     , REQMAN_NM  AS DEMNDMAN_NM
			     , REQ_DEPT AS DEMNDMAN_DEPT
			     , REQ_DEPT_NM AS DEMNDMAN_DEPT_NM
			     , REQMAN_JIKGUP_NM AS DEMNDMAN_JIKGUP_NM
			     , TO_CHAR(REQ_DT, 'YYYY-MM-DD HH:MM') AS REQ_DT
			     , (SELECT CD_NM FROM TB_COM_CD WHERE GRP_CD='C037' AND CD='C03701') AS DEMND_STATUS_NM
			     , 'C03701' AS DEMND_STATUS
			     , TO_CHAR(SYSDATE, 'YYYY-MM-DD HH:MM') AS DEMND_DT2
			FROM 	TN_CLM_CONT_CNSDREQ
			WHERE 	CNSDREQ_ID = :vo.cnsdreq_id
		    ]]>
		  </statement>
		</query>
		
    	<!-- 계약 정보  - 요청 : 2011.11.04 : snw -->
		<query id="clm.manage.detailCntrt" isCamelCase="false">
		  <statement>
		    <![CDATA[
			 SELECT   CNTRT_ID
	 				, CNTRT_NM AS DEMND_TITLE_NM
	 			  	, CNTRT_RESPMAN_ID AS DEMNDMAN_ID
					, CNTRT_RESPMAN_NM AS DEMNDMAN_NM
					, CNTRT_RESP_DEPT AS DEMNDMAN_DEPT
					, CNTRT_RESP_DEPT_NM AS DEMNDMAN_DEPT_NM
					, CNTRT_RESPMAN_JIKGUP_NM AS DEMNDMAN_JIKGUP_NM
					, TO_CHAR(REG_DT, 'YYYY-MM-DD HH:MM') AS REQ_DT
					, (SELECT CD_NM FROM TB_COM_CD WHERE GRP_CD='C037' AND CD='C03701') AS DEMND_STATUS_NM
					, 'C03701' AS DEMND_STATUS
					, TO_CHAR(SYSDATE, 'YYYY-MM-DD HH:MM') AS DEMND_DT2
			 FROM	TN_CLM_CONTRACT_MASTER
			 WHERE	CNTRT_ID = :vo.cntrt_id	
		    ]]>
		  </statement>
		</query>		
		
    	<!-- 계약권한정보조회(계약검토단계) : 2011.11.04 : snw -->
		<query id="clm.manage.detailAuthReqInfo1" isCamelCase="false">
		  <statement>
		    <![CDATA[
			SELECT 	Y.CNSDREQ_ID, Y.REQ_TITLE AS DEMND_TITLE_NM, TO_CHAR(Y.REQ_DT, 'YYYY-MM-DD HH:MM') AS REQ_DT,
					X.DEMNDMAN_ID, X.DEMNDMAN_NM, X.DEMNDMAN_DEPT_NM, X.DEMNDMAN_JIKGUP_NM,
					X.TRGTMAN_ID, X.TRGTMAN_NM, X.TRGTMAN_DEPT_NM, X.TRGTMAN_JIKGUP_NM, X.DEMND_STATUS,
					(SELECT CD_NM FROM TB_COM_CD WHERE GRP_CD='C037' AND CD=X.DEMND_STATUS) AS DEMND_STATUS_NM,
					X.DEMND_CONT, X.DEMND_DT, TO_CHAR(X.DEMND_DT, 'YYYY-MM-DD HH:MM') AS DEMND_DT2
			FROM	TN_CLM_CONTRACT_AUTHREQ X, (
												SELECT  A.CNSDREQ_ID, C.CNTRT_ID, A.REQ_TITLE, A.REQ_DT
												FROM	TN_CLM_CONT_CNSDREQ A, TN_CLM_CONTRACT_CNSD B, TN_CLM_CONTRACT_MASTER C
												WHERE 	A.CNSDREQ_ID = B.CNSDREQ_ID
												AND	  	B.CNTRT_ID = C.CNTRT_ID
												AND	  	A.CNSDREQ_ID = :vo.cnsdreq_id	
												AND	  	A.DEL_YN = 'N'
												AND	  	C.DEL_YN = 'N'
												) Y
			WHERE 	X.CNTRT_ID = Y.CNTRT_ID
			AND		X.DEMND_GBN='C04602'
			AND		X.DEMND_STATUS='C03701'
			AND		X.DEL_YN ='N'
		    ]]>
		  </statement>
		</query>
		
    	<!-- 계약권한정보조회(계약검토단계 이후) : 2011.11.04 : snw -->
		<query id="clm.manage.detailAuthReqInfo2" isCamelCase="false">
		  <statement>
		    <![CDATA[
			SELECT 	Y.CNTRT_ID, Y.CNTRT_NM AS DEMND_TITLE_NM, TO_CHAR(Y.REG_DT, 'YYYY-MM-DD HH:MM') AS REQ_DT,
					X.DEMNDMAN_ID, X.DEMNDMAN_NM, X.DEMNDMAN_DEPT_NM, X.DEMNDMAN_JIKGUP_NM,
					X.TRGTMAN_ID, X.TRGTMAN_NM, X.TRGTMAN_DEPT_NM, X.TRGTMAN_JIKGUP_NM, X.DEMND_STATUS,
					(SELECT CD_NM FROM TB_COM_CD WHERE GRP_CD='C037' AND CD=X.DEMND_STATUS) AS DEMND_STATUS_NM,
					X.DEMND_CONT, X.DEMND_DT, TO_CHAR(X.DEMND_DT, 'YYYY-MM-DD HH:MM') AS DEMND_DT2					
			FROM	TN_CLM_CONTRACT_AUTHREQ X, (
												SELECT 	CNTRT_ID, CNTRT_NM, REG_DT
												FROM	TN_CLM_CONTRACT_MASTER
												WHERE 	CNTRT_ID = :vo.cntrt_id	
												AND		DEL_YN = 'N'
												) Y
			WHERE 	X.CNTRT_ID = Y.CNTRT_ID
			AND		X.DEMND_GBN='C04602'
			AND		X.DEMND_STATUS='C03701'
			AND		X.DEL_YN ='N'
		    ]]>
		  </statement>
		</query>				
		
		<!-- 계약 권한 목록: 2011.10.13 : dawn -->
		<query id="clm.manage.listRequestCntrt" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT C.CNTRT_ID
				  FROM TN_CLM_CONT_CNSDREQ A
				     , TN_CLM_CONTRACT_CNSD B
				     , TN_CLM_CONTRACT_MASTER C
				 WHERE A.CNSDREQ_ID = B.CNSDREQ_ID
				   AND B.CNTRT_ID   = C.CNTRT_ID
				   AND A.CNSDREQ_ID = :vo.cnsdreq_id
				   AND A.DEL_YN     = 'N'
		    ]]>
		  </statement>
		</query>
				
    	<!-- 계약 권한 일련번호  : 2011.09.27 : 신남원 -->
		<query id="clm.manage.maxRequestSeqno" isCamelCase="false">
		  <statement>
		    <![CDATA[
			    SELECT ISNULL(MAX(DEMND_SEQNO)+1, 1) AS MAX_DEMND_SEQNO
	              FROM TN_CLM_CONTRACT_AUTHREQ
	             WHERE CNTRT_ID = :vo.cntrt_id
		    ]]>
		  </statement>
		</query>
				
		<!-- 계약권한요청 저장 - 요청  : 2011.10.12 : dawn -->
		<query id="clm.manage.insertRequestAuthreq" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        INSERT INTO TN_CLM_CONTRACT_AUTHREQ
						  ( CNTRT_ID, DEMND_SEQNO, DEMNDMAN_ID, DEMNDMAN_NM
						  , DEMNDMAN_DEPT_NM, DEMNDMAN_JIKGUP_NM, DEMND_CONT
						  , TRGTMAN_ID, TRGTMAN_NM, TRGTMAN_DEPT_NM
						  , TRGTMAN_JIKGUP_NM, DEMND_STATUS
						  , DEMND_DT, DEL_YN, DEMND_GBN
						  )
					   VALUES
						  ( :vo.cntrt_id, :vo.demnd_seqno, :vo.demndman_id, :vo.demndman_nm
						  , :vo.demndman_dept_nm, :vo.demndman_jikgup_nm, :vo.demnd_cont
						  , :vo.trgtman_id, :vo.trgtman_nm, :vo.trgtman_dept_nm
						  , :vo.trgtman_jikgup_nm, :vo.demnd_status
						  , SYSDATE, 'N', :vo.demnd_gbn
						  )
		    ]]>
		  </statement>
		</query>		

		<!-- 계약권한요청 삭제 (취소)  : 2011.10.14 : dawn -->
		<query id="clm.manage.deleteRequestAuthreq" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_CONTRACT_AUTHREQ
				   SET DEL_YN       = 'Y'
				     , DEL_DT       = SYSDATE
				     , DEL_ID       = :vo.del_id
				     , DEL_NM       = :vo.del_nm
				 WHERE CNTRT_ID     = :vo.cntrt_id
				   AND DEMND_GBN    = 'C04602'
				   AND DEMND_STATUS = 'C03701'
				   AND DEMNDMAN_ID  = :vo.demndman_id
				   AND TRGTMAN_ID   = :vo.trgtman_id
				   AND DEL_YN 		= 'N'
		    ]]>
		  </statement>
		</query>

		<!-- 계약권한요청 AUTHREQ 수정(승인)  : 2011.10.14 : dawn -->
		<query id="clm.manage.modifyRequestAuthreq" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_CONTRACT_AUTHREQ
				   SET HNDL_DT      = SYSDATE
				     , HNDL_CONT    = :vo.hndl_cont
				     , HNDLMAN_ID   = :vo.hndlman_id
				     , HNDLMAN_NM   = :vo.hndlman_nm
				     , DEMND_STATUS = :vo.demnd_status
				 WHERE CNTRT_ID     = :vo.cntrt_id
				   AND DEMND_GBN    = 'C04602'
				   AND DEMND_STATUS = 'C03701'
				   AND DEMNDMAN_ID  = :vo.demndman_id
				   AND TRGTMAN_ID   = :vo.trgtman_id
				   AND DEL_YN 		= 'N'
		    ]]>
		  </statement>
		</query>

		<!-- 계약권한요청 계약마스터 담당자 수정  : 2011.10.14 : dawn -->
		<query id="clm.manage.modifyContractMasterStatus" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_CONTRACT_MASTER
				   SET CNTRT_RESPMAN_ID   = :vo.trgtman_id
				     , CNTRT_RESPMAN_NM   = :vo.trgtman_nm
				     , CNTRT_RESP_DEPT    = :vo.trgtman_dept
				     , CNTRT_RESP_DEPT_NM = :vo.trgtman_dept_nm
				 WHERE CNTRT_ID           = :vo.cntrt_id
		    ]]>
		  </statement>
		</query>
		
		<!-- 계약권한요청 검토의뢰 담당자 수정  : 2011.10.14 : dawn -->
		<query id="clm.manage.modifyContractCnsdReqStatus" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_CONT_CNSDREQ SET 
		        	REQMAN_ID				= :vo.trgtman_id
					, REQMAN_NM				= :vo.trgtman_nm
					, REQ_DEPT				= :vo.trgtman_dept
					, REQ_DEPT_NM			= :vo.trgtman_dept_nm
					, REQ_INTNL_DEPT_CD		= :vo.trgtman_in_dept
					, REQMAN_JIKGUP_NM		= :vo.trgtman_jikgup_nm
					, REQ_UP_DEPT			= (
															SELECT MAX(DEPT_UP_STR)
															FROM (
																SELECT SUBSTRING(DEPT_UP_STR, 1, CHARINDEX( '^',DEPT_UP_STR)-1) AS DEPT_CD, DEPT_UP_STR
																FROM 
																(
																	SELECT STUFF((	
																		SELECT '^'+DEPT_CD FROM DBO.[SECFW.USER.LISTORGNZLIST]( :vo.trgtman_dept ) 
																		FOR XML PATH('')
																	 	), 1, 1, '') +'^' AS DEPT_UP_STR
																) SSA
															) SA
															GROUP BY DEPT_CD
														)   
				 WHERE CNSDREQ_ID         = :vo.cnsdreq_id
		    ]]>
		  </statement>
		</query>		
	
		<!-- 계약조회권한 저장 - 요청  *주의 : 요청자와 대상자가 뒤바뀜(쿼리 순서 바꾸어 놓음 ) : 2011.11.07 : snw -->
		<query id="clm.manage.insertSearchAuthreq" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        INSERT INTO TN_CLM_CONTRACT_AUTHREQ
						  ( CNTRT_ID, DEMND_SEQNO 
						  ,  DEMNDMAN_ID, DEMNDMAN_NM, DEMNDMAN_DEPT_NM, DEMNDMAN_JIKGUP_NM
						  , DEMND_CONT
						  , TRGTMAN_ID, TRGTMAN_NM, TRGTMAN_DEPT_NM, TRGTMAN_JIKGUP_NM
						  , HNDL_DT, HNDL_CONT, HNDLMAN_ID, HNDLMAN_NM
						  , DEMND_STATUS, DEMND_DT, DEL_YN, DEMND_GBN
						  )
				VALUES
						  ( :vo.cntrt_id, :vo.demnd_seqno
						  , :vo.trgtman_id, :vo.trgtman_nm, :vo.trgtman_dept_nm, :vo.trgtman_jikgup_nm
						  , :vo.demnd_cont
						  , :vo.demndman_id, :vo.demndman_nm, :vo.demndman_dept_nm, :vo.demndman_jikgup_nm
						  , SYSDATE, :vo.hndl_cont, :vo.hndlman_id, :vo.hndlman_nm
						  , :vo.demnd_status, SYSDATE, 'N', :vo.demnd_gbn
						  )
		    ]]>
		  </statement>
		</query>

		<!-- 계약 담당자 변경 권한 체크 : 2011.12.06 : 최준영 -->
		<query id="clm.manage.checkChangeAuth" isCamelCase="false">
		  <statement>
		    <![CDATA[
			SELECT REG_OPERDIV ,CNTRT_RESP_UP_DEPT
			  FROM (
#if ($vo.p_prcs_depth.equals("C02501") + $vo.p_prcs_depth.equals("C02502"))
					SELECT B.REG_OPERDIV ,B.CNTRT_RESP_UP_DEPT
					  FROM TN_CLM_CONTRACT_CNSD A
					      ,TN_CLM_CONTRACT_MASTER B
					 WHERE A.CNSDREQ_ID = :vo.cnsdreq_id
					   AND A.CNTRT_ID = B.CNTRT_ID
					   AND B.DEL_YN = 'N'
#else
					SELECT REG_OPERDIV ,CNTRT_RESP_UP_DEPT
					  FROM TN_CLM_CONTRACT_MASTER
					 WHERE CNTRT_ID = :vo.cntrt_id
					   AND DEL_YN = 'N'
#end
			       )

		    ]]>
		  </statement>
		</query>

		<!-- 계약 담당자 변경을 위한 기본 정보 조회 : 2011.12.06 : 최준영 -->
		<!-- C.REQ_OPERDIV (의뢰사업부 조직조회를 위해 추가 : 2012.09.07 : 소유진 -->
		<query id="clm.manage.detailChangeInfo" isCamelCase="false">
		  <statement>
		    <![CDATA[
		SELECT A.CNTRT_ID, A.CNTRT_NO ,C.CNSDREQ_ID ,A.CNTRT_NM ,C.REQ_TITLE
				,DBO.LAS_CODE_NM('C025', D.CD, :vo.session_user_locale) AS PRCS_DEPTH_NM
				,DBO.LAS_CODE_NM(D.CD, E.CD, :vo.session_user_locale) AS DEPTH_STATUS_NM
		      ,A.CNTRT_RESPMAN_ID ,A.CNTRT_RESPMAN_NM ,A.CNTRT_RESPMAN_JIKGUP_NM ,A.CNTRT_RESP_DEPT_NM, C.REQ_OPERDIV
		  FROM TN_CLM_CONTRACT_MASTER A
		      ,TN_CLM_CONTRACT_CNSD B
		      ,TN_CLM_CONT_CNSDREQ C
		      ,TB_COM_CD D
		      ,TB_COM_CD E
		 WHERE A.DEL_YN = 'N'
		   AND C.DEL_YN = 'N'
		   AND A.CNTRT_ID = B.CNTRT_ID
		   AND B.CNSDREQ_ID = C.CNSDREQ_ID
		   AND A.PRCS_DEPTH = D.CD
		   AND A.DEPTH_STATUS = E.CD
#if ($vo.p_prcs_depth.equals("C02501") + $vo.p_prcs_depth.equals("C02502"))
		   AND C.CNSDREQ_ID = :vo.cnsdreq_id
#else
		   AND A.CNTRT_ID = :vo.cntrt_id
#end
		 ORDER BY A.CNTRT_ID ASC ,C.CNSDREQ_ID DESC
		    ]]>
		  </statement>
		</query>

		<!-- 담당자변경 이력 기록 : 2011.12.07 : 최준영 -->
		<query id="clm.manage.insertChangeAuthreq" isCamelCase="false">
		  <statement>
		    <![CDATA[
	INSERT INTO TN_CLM_CONTRACT_AUTHREQ (CNTRT_ID ,DEMND_SEQNO ,DEMND_GBN ,DEMNDMAN_ID ,DEMNDMAN_NM ,DEMNDMAN_DEPT_NM
										,DEMNDMAN_JIKGUP_NM ,TRGTMAN_ID ,TRGTMAN_NM ,TRGTMAN_DEPT_NM ,TRGTMAN_JIKGUP_NM
										,DEMND_STATUS ,DEMND_DT ,HNDL_DT ,HNDLMAN_ID ,HNDLMAN_NM ,HNDL_CONT ,DEL_YN)
	SELECT A.CNTRT_ID ,MAX(ISNULL(B.DEMND_SEQNO, 0))+1 ,'C04602' ,:vo.session_user_id ,:vo.session_user_nm ,:vo.session_dept_nm
          ,:vo.session_jikgup_nm ,:vo.trgtman_id ,:vo.trgtman_nm ,:vo.trgtman_dept_nm ,:vo.trgtman_jikgup_nm ,'C03702' ,SYSDATETIME()
          ,SYSDATETIME() ,:vo.session_user_id ,:vo.session_user_nm ,:vo.demnd_cont ,'N'
	  FROM TN_CLM_CONTRACT_CNSD A LEFT OUTER JOIN 
	      TN_CLM_CONTRACT_AUTHREQ B ON A.CNTRT_ID = B.CNTRT_ID 
	 WHERE  1=1
#if ($vo.p_prcs_depth.equals("C02501") + $vo.p_prcs_depth.equals("C02502"))
	   AND A.CNSDREQ_ID = :vo.cnsdreq_id
#else
	   AND A.CNTRT_ID = :vo.cntrt_id
#end
	 GROUP BY A.CNTRT_ID
		    ]]>
		  </statement>
		</query>

		<!-- 계약마스터 담당자 변경 : 2011.12.07 : 최준영 -->
		<query id="clm.manage.changeContractMasterStatus" isCamelCase="false">
		  <statement>
		    <![CDATA[
				UPDATE TN_CLM_CONTRACT_MASTER SET 
					CNTRT_RESPMAN_ID = :vo.trgtman_id
					,CNTRT_RESPMAN_NM = :vo.trgtman_nm
					,CNTRT_RESP_DEPT = :vo.trgtman_dept
					,REG_INTNL_DEPT_CD = :vo.trgtman_in_dept
					,CNTRT_RESP_DEPT_NM = :vo.trgtman_dept_nm
					,CNTRT_RESPMAN_JIKGUP_NM = :vo.trgtman_jikgup_nm
					,CNTRT_RESP_UP_DEPT = (
							SELECT MAX(DEPT_UP_STR)
							FROM (
								SELECT SUBSTRING(DEPT_UP_STR, 1, CHARINDEX( '^',DEPT_UP_STR)-1) AS DEPT_CD, DEPT_UP_STR
								FROM 
								(
									SELECT STUFF((	
										SELECT '^'+DEPT_CD FROM DBO.[SECFW.USER.LISTORGNZLIST]( :vo.trgtman_dept ) 
										FOR XML PATH('')
									 	), 1, 1, '') +'^' AS DEPT_UP_STR
								) SSA
							) SA
							GROUP BY DEPT_CD						
					)					
				WHERE CNTRT_ID IN (
				#if ($vo.p_prcs_depth.equals("C02501") + $vo.p_prcs_depth.equals("C02502"))
									SELECT CNTRT_ID FROM TN_CLM_CONTRACT_CNSD WHERE CNSDREQ_ID = :vo.cnsdreq_id
				#else
									:vo.cntrt_id
				#end
				                   )
		    ]]>
		  </statement>
		</query>




						
    </queries>
</queryservice>