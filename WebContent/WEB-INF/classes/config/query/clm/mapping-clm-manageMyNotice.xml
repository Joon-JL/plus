<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN" "http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
	<queries>
<query id="clm.manage.listMyNotice" isCamelCase="false">
  <statement>
    <![CDATA[
    SELECT * FROM (
       	SELECT ROW_NUMBER() OVER (ORDER BY SUBSTRING(MIS_ID,0,18) DESC) RN, R.*
		    FROM	(
					SELECT t.*, CAST(COUNT(1) over() AS NUMERIC) TOTAL_CNT
				   		 FROM	(
								  SELECT SUBJECT,  
								  		CASE WHEN :vo.session_user_locale = 'ko' THEN
								  			MIN(NAME) + DBO.DECODE3(ALL_REC_CNT,1,'','외 '+CAST(ALL_REC_CNT-1 AS NVARCHAR)+'명')
								  		WHEN :vo.session_user_locale = 'fr' THEN
								  			MIN(NAME) + DBO.DECODE3(ALL_REC_CNT,1,'','et '+CAST(ALL_REC_CNT-1 AS NVARCHAR)+'Personne(s)')
								  		WHEN :vo.session_user_locale = 'de' THEN
								  			MIN(NAME) + DBO.DECODE3(ALL_REC_CNT,1,'','und '+CAST(ALL_REC_CNT-1 AS NVARCHAR)+'Person(en)')
								  		ELSE
								  			MIN(NAME) + DBO.DECODE3(ALL_REC_CNT,1,'','and '+CAST(ALL_REC_CNT-1 AS NVARCHAR)+'others')
								  		END AS NAME
								  	     ,CREATE_DATE
								  	     ,REC_CNT,ALL_REC_CNT
								  	     ,STATUS_NM
								  	     ,MODULE_ID
								  	     ,MIS_ID
								  FROM ( 
									      select A.SUBJECT
									      		,(ISNULL(B.NAME,D.USER_NM)) NAME 
									      		,CONVERT(CHAR(10), CREATE_DATE, 23) AS CREATE_DATE /*YYYY-MM-DD*/
									      		,SUM(CAST(DBO.DECODE3(B.STATUS,'1',1,0) AS NUMERIC)) OVER (PARTITION BY B.MODULE_ID, B.MIS_ID) AS REC_CNT
									      		,(SELECT COUNT(*) FROM TB_COM_RECIPIENT_ETY_CSVO WHERE MODULE_ID = B.MODULE_ID AND MIS_ID = B.MIS_ID) AS ALL_REC_CNT
									      		,CD_NM STATUS_NM, A.MODULE_ID, A.MIS_ID
									      from TB_COM_HEADER_HELPER_CSVO A, TB_COM_RECIPIENT_ETY_CSVO B, TB_COM_CD C, TB_COM_USER D
									      WHERE A.MODULE_ID = B.MODULE_ID AND A.MIS_ID = B.MIS_ID
									      #if($vo.srch_start_reg_dt && !$vo.srch_start_reg_dt.equals(""))
									      	AND SUBSTRING(A.CREATE_DATE,0,8) >= REPLACE(:vo.srch_start_reg_dt,'-','')
									      #end
									      #if($vo.srch_end_reg_dt && !$vo.srch_end_reg_dt.equals(""))
									      	AND SUBSTRING(A.CREATE_DATE,0,8) <= REPLACE(:vo.srch_end_reg_dt,'-','')
									      #end
									      #if($vo.srch_Addressee && !$vo.srch_Addressee.equals(""))
									      	  AND B.NAME LIKE '%' + :vo.srch_Addressee + '%'
									      #end 
									      #if($vo.srch_stat && !$vo.srch_stat.equals(""))
									      	  AND A.STATUS = :vo.srch_stat
  										  #end  
  										   #if($vo.srch_keyword_mailtitle && !$vo.srch_keyword_mailtitle.equals(""))
									      	  AND A.SUBJECT LIKE '%' + :vo.srch_keyword_mailtitle  + '%' 
									      #end 
									      AND C.GRP_CD = 'C049'  AND A.STATUS = C.CD  
									      AND B.REC_ADDR = D.EMAIL
									      AND D.USER_ID = :vo.session_user_id
									      AND A.STATUS IN ('1','2')
   										) S 
										GROUP BY MODULE_ID,MIS_ID,SUBJECT,CREATE_DATE, REC_CNT,ALL_REC_CNT,STATUS_NM

								) t  
					 )R) TA
		WHERE RN between :vo.start_index and :vo.end_index
		ORDER BY RN
    ]]>
  </statement>
</query>

<query id="clm.manage.detailMyNotice" isCamelCase="false">
	  <statement>
	    <![CDATA[
	       select A.SUBJECT
	              ,CASE WHEN :vo.session_user_locale = 'ko' THEN
		              	CASE A.STATUS
		              		WHEN '0' THEN '대기중'
		              		WHEN '1' THEN '전송완료'
		              		WHEN 'E' THEN '전송실패'
		              	END	              		
	              	WHEN :vo.session_user_locale = 'fr' THEN
	              		CASE A.STATUS
		              		WHEN '0' THEN 'En attente'
		              		WHEN '1' THEN 'La livraison a été effectuée'
		              		WHEN 'E' THEN 'La livraison a échoué'
		              	END	    
	              	WHEN :vo.session_user_locale = 'de' THEN
	              		CASE A.STATUS
		              		WHEN '0' THEN 'Offen'
		              		WHEN '1' THEN 'Vorlage abgeschlossen'
		              		WHEN 'E' THEN 'Vorlage fehlgeschlagen'
		              	END	    
	              	ELSE
	              		CASE A.STATUS
		              		WHEN '0' THEN 'Pending'
		              		WHEN '1' THEN 'Delivery Completed'
		              		WHEN 'E' THEN 'Delivery Failed'
		              	END	   
	              	END STATUS
	              ,CONVERT(VARCHAR, CONVERT(DATE, SUBSTRING(CREATE_DATE,0,9),23), 23) AS CREATE_DATE /*YYYY-MM-DD*/
	       		 /* ,TO_CHAR(TO_DATE(SUBSTRING(CREATE_DATE,0,8), 'YYYY-MM-DD'), 'YYYY-MM-DD') CREATE_DATE */
	       		  ,a.sender_mail_addr as sender_mail_addr
	       		  ,a.body as body
	       		  ,SUM(CAST(DBO.DECODE3(B.STATUS,'1',1,0) AS NUMERIC)) OVER (PARTITION BY B.MODULE_ID, B.MIS_ID) AS REC_CNT
	       		  ,COUNT(B.EPID) OVER (PARTITION BY B.MODULE_ID, B.MIS_ID) AS ALL_REC_CNT
	       		  ,CASE WHEN :vo.session_user_locale = 'ko' THEN CD_NM
	              		WHEN :vo.session_user_locale = 'fr' THEN CD_NM_FRA
	              		WHEN :vo.session_user_locale = 'de' THEN CD_NM_DEU
	              	    ELSE CD_NM_ENG
	              	END STATUS_NM, A.MODULE_ID, A.MIS_ID
	       		  ,A.BODY
	       		  , CASE :vo.session_user_locale
	       		  		WHEN 'ko' THEN E.USER_NM
	       		  		ELSE E.USER_NM_ENG
	       		  	END
	       		  + '/' 
	       		  + CASE :vo.session_user_locale
	       		  		WHEN 'ko' THEN E.JIKGUP_NM
	       		  		ELSE E.JIKGUP_NM_ENG
	       		  	END 
	       		  + '/' + E.DEPT_NM SEND_USER_NM
	       		  ,CASE WHEN :vo.session_user_locale = 'ko' THEN
	       		  		CASE A.MSG_TYPE
		              		WHEN 'personal' THEN '개인'
		              		WHEN 'official' THEN '공문'
		              	END	    
	       		  WHEN :vo.session_user_locale = 'fr' THEN
	       		  		CASE A.MSG_TYPE
		              		WHEN 'personal' THEN 'Caractère personnel'
		              		WHEN 'official' THEN 'Caractère officiel'
		              	END	  
	       		  WHEN :vo.session_user_locale = 'de' THEN
	       		  		CASE A.MSG_TYPE
		              		WHEN 'personal' THEN 'persönlich'
		              		WHEN 'official' THEN 'offiziell'
		              	END	  
	       		  ELSE
	       		  		CASE A.MSG_TYPE
		              		WHEN 'personal' THEN 'personal'
		              		WHEN 'official' THEN 'official'
		              	END	  
	       		  END AS msg_type
			from  TB_COM_HEADER_HELPER_CSVO A 
				 ,TB_COM_RECIPIENT_ETY_CSVO B 
				 ,TB_COM_CD C
				 ,TB_COM_RESOURCE_CSVO D
				 ,TB_COM_USER E
		    WHERE A.MODULE_ID = B.MODULE_ID AND A.MIS_ID = B.MIS_ID
		    AND A.MODULE_ID = D.MODULE_ID AND D.MIS_ID = B.MIS_ID
		    AND B.REC_ADDR = E.EMAIL
		    AND C.GRP_CD = 'C049'  
		    AND A.STATUS = C.CD
		    AND A.MODULE_ID = :vo.module_id
		    AND A.MIS_ID = :vo.mis_id
		]]>
	  </statement>
	 </query>
   
		<query id="clm.manage.recipientMyNotice" isCamelCase="false">
			  <statement>
			    <![CDATA[
						  SELECT 
						  	CASE :vo.session_user_locale
						  		WHEN 'ko' THEN B.USER_NM
						  		ELSE B.USER_NM_ENG
						  	END
						  	+ '/' 
	       		  			+ 
	       		  			CASE :vo.session_user_locale
						  		WHEN 'ko' THEN B.JIKGUP_NM
						  		ELSE B.JIKGUP_NM_ENG
						  	END
	       		  			+ '/' + B.DEPT_NM  USER_NM 
						  FROM TB_COM_RECIPIENT_ETY_CSVO A, TB_COM_USER B,
			                (SELECT COUNT(*) RCNT FROM TB_COM_RECIPIENT_ETY_CSVO 
			                  WHERE MODULE_ID = :vo.module_id AND MIS_ID = :vo.mis_id ) C
						  WHERE A.MODULE_ID = :vo.module_id
							AND A.MIS_ID = :vo.mis_id
							AND A.REC_ADDR = B.EMAIL
			              --	AND ROWNUM <= C.RCNT
				]]>
			  </statement>
	  </query>
	  
		<query id="clm.manage.listMyNoticeByMain" isCamelCase="false">
		  <statement>
		    <![CDATA[
			SELECT * FROM (
		       	SELECT ROWNUM RN,R.*
				    FROM	(
							SELECT t.*, COUNT(1) over() TOTAL_CNT
						   		 FROM	(
										  SELECT SUBJECT,  
										  		CASE WHEN :vo.session_user_locale = 'ko' THEN
										  			MIN(NAME) + DECODE(ALL_REC_CNT,1,'','외 '+(ALL_REC_CNT-1)+'명')
										  		WHEN :vo.session_user_locale = 'fr' THEN
										  			MIN(NAME) + DECODE(ALL_REC_CNT,1,'','et '+(ALL_REC_CNT-1)+'Personne(s)')
										  		WHEN :vo.session_user_locale = 'de' THEN
										  			MIN(NAME) + DECODE(ALL_REC_CNT,1,'','und '+(ALL_REC_CNT-1)+'Person(en)')
										  		ELSE
										  			MIN(NAME) + DECODE(ALL_REC_CNT,1,'','and '+(ALL_REC_CNT-1)+' others')
										  		END AS NAME
										  	     ,CREATE_DATE
										  	     ,CASE WHEN CREATE_DATE > SYSDATE-14 THEN 'NEW' ELSE '' END NEW_YN
										  	     ,REC_CNT,ALL_REC_CNT
										  	     ,STATUS_NM
										  	     ,MODULE_ID
										  	     ,MIS_ID
										  FROM ( 
											      select A.SUBJECT
											      		,(ISNULL(B.NAME,D.USER_NM)) NAME
											      		,TO_CHAR(TO_DATE(SUBSTRING(CREATE_DATE,0,8), 'YYYY-MM-DD'), 'YYYY-MM-DD') CREATE_DATE
											      		,SUM(DECODE(B.STATUS,'1',1,0)) OVER (PARTITION BY B.MODULE_ID, B.MIS_ID) AS REC_CNT
											      		,(SELECT COUNT(*) FROM TB_COM_RECIPIENT_ETY_CSVO WHERE MODULE_ID = B.MODULE_ID AND MIS_ID = B.MIS_ID) AS ALL_REC_CNT
											      		,DECODE('KR','KR',CD_NM, CD_NM_ENG) STATUS_NM, A.MODULE_ID, A.MIS_ID
											      from TB_COM_HEADER_HELPER_CSVO A, TB_COM_RECIPIENT_ETY_CSVO B, TB_COM_CD C, TB_COM_USER D
											      WHERE A.MODULE_ID = B.MODULE_ID AND A.MIS_ID = B.MIS_ID
											      #if(!$vo.srch_start_reg_dt.equals(""))
											      	AND TO_DATE(SUBSTRING(A.CREATE_DATE,0,8), 'YYYYMMDD') >= :vo.srch_start_reg_dt
											      #end
											      #if(!$vo.srch_end_reg_dt.equals(""))
											      	AND TO_DATE(SUBSTRING(A.CREATE_DATE,0,8), 'YYYYMMDD') <= :vo.srch_end_reg_dt 
											      #end
											      #if(!$vo.srch_Addressee.equals(""))
											      	  AND B.NAME LIKE '%' + :vo.srch_Addressee + '%'
											      #end 
											      #if(!$vo.srch_stat.equals(""))
											      	  AND A.STATUS = :vo.srch_stat
		  										  #end  
		  										   #if(!$vo.srch_keyword_mailtitle.equals(""))
											      	  AND A.SUBJECT LIKE '%' + :vo.srch_keyword_mailtitle  + '%' 
											      #end 
											      AND C.GRP_CD = 'C049'  AND A.STATUS = C.CD  
											      AND B.REC_ADDR = D.EMAIL
											      AND D.USER_ID = :vo.session_user_id
											      AND A.STATUS IN ('1','2')
											    ) S 
												GROUP BY MODULE_ID,MIS_ID,SUBJECT,CREATE_DATE, REC_CNT,ALL_REC_CNT,STATUS_NM
		
										) t ORDER BY SUBSTRING(MIS_ID,0,18) DESC
							 )R)
				WHERE RN between :vo.start_index and :vo.end_index				
		    ]]>
		  </statement>
		</query>	  
	  
	  
   	</queries>
</queryservice>