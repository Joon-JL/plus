<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>
    
	    <!-- 프로세스&규정지침서 목록조회: 2011.09.01 : 신남원 -->
		<query id="clm.admin.listRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
				SELECT * FROM (
				      SELECT ROW_NUMBER() OVER (ORDER BY T.UP_RULE_NO, T.RULE_DEPTH, T.RULE_SRT) RN, 
							t.*, CAST(COUNT(1) over() AS NUMERIC) TOTAL_CNT
							  FROM(
				             SELECT A.RULE_TITLE ONE_TITLE,
									A.RULE_CONT ONE_CONT,
									A.RULE_TITLE_EN ONE_TITLE_EN,
									A.RULE_CONT_EN ONE_CONT_EN,
									B.RULE_TITLE TWO_TITLE,
									B.RULE_CONT TWO_CONT,
									B.RULE_TITLE_EN TWO_TITLE_EN,
									B.RULE_CONT_EN TWO_CONT_EN,
									B.RULE_NO,
									CONVERT(CHAR(10), B.REG_DT, 23) AS REG_DT, /*YYYY-MM-DD*/
									B.REG_NM,
									B.REG_ID,
                         			B.DN_RULE_EXIST_YN,
                         			A.UP_RULE_NO,
                         			A.RULE_DEPTH,
                         			A.RULE_SRT
				               FROM(
				                    SELECT A.UP_RULE_NO, A.RULE_TITLE, A.RULE_CONT, A.RULE_TITLE_EN, A.RULE_CONT_EN
				                         , A.RULE_DEPTH, A.RULE_SRT, A.RULE_NO
				                      FROM TN_CLM_PRCS_RULE A
				                     WHERE A.RULE_DEPTH = 1
				                     	#if(!$vo.session_auth_comp_cd.equals(""))
											AND A.COMP_CD IN ($vo.session_auth_comp_cd)
										#end
				                       	AND A.DEL_YN = 'N'
				                    ) A,
				                   (SELECT B.UP_RULE_NO, B.RULE_TITLE, B.RULE_CONT, B.RULE_TITLE_EN, B.RULE_CONT_EN
				                         , B.RULE_DEPTH, B.RULE_SRT, B.RULE_NO
				                         , B.REG_DT, B.REG_NM, B.REG_ID, B.DN_RULE_EXIST_YN
				                      FROM TN_CLM_PRCS_RULE B
				                     WHERE B.RULE_DEPTH <> 1
				                     	#if(!$vo.session_auth_comp_cd.equals(""))
											AND B.COMP_CD IN ($vo.session_auth_comp_cd)
										#end
				                       	AND B.DEL_YN = 'N'
				                    ) B
				              WHERE A.UP_RULE_NO = B.UP_RULE_NO
				                #if(!$vo.srch_one_rule_depth.equals(""))
				                    AND B.UP_RULE_NO = :vo.srch_one_rule_depth
				                #end
				                #if(!$vo.srch_two_rule_depth.equals(""))
				                    AND B.RULE_NO    = :vo.srch_two_rule_depth
				                #end
				                #if(!$vo.srch_cont.equals(""))
				                    AND B.RULE_CONT LIKE '%'+ :vo.srch_cont +'%'
				                #end
				              
				             ) T
				          ) TA
				 WHERE RN BETWEEN :vo.start_index AND :vo.end_index
				 ORDER BY RN
		    ]]>
		  </statement>
		</query>
		
	    <!-- 2단계 코드 가져오기 : 2011.09.01 : 신남원 -->
		<query id="clm.admin.regulationListRuleCd" isCamelCase="false">
		  <statement>
		    <![CDATA[
			SELECT RULE_NO
				/* , RULE_TITLE_EN */
				 , RULE_TITLE_EN AS RULE_TITLE/* modify by hong*/
		      FROM TN_CLM_PRCS_RULE
		     WHERE UP_RULE_NO = CAST( CASE WHEN :up_rule_no IS NULL OR :up_rule_no = '' THEN '0' ELSE :up_rule_no END AS NUMERIC)
		     	AND COMP_CD IN (:comp_cd)
		       	AND RULE_DEPTH <> 1
		       	AND DEL_YN = 'N'
		     ORDER BY RULE_NO
		    ]]>
		  </statement>
		</query>		
		
	    <!-- 프로세스&규정지침서  등록 : 2011.09.01 : 신남원 -->
		<query id="clm.admin.insertRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		    INSERT INTO TN_CLM_PRCS_RULE (
		           	     RULE_NO
		           	   , COMP_CD
		               , UP_RULE_NO
		               , RULE_DEPTH
		               , RULE_SRT
		               , DN_RULE_EXIST_YN
		               , RULE_TITLE
		               , RULE_TITLE_EN
		               , RULE_CONT
		               , RULE_CONT_EN
		               , REG_DT
		               , REG_ID
		               , REG_NM
		               , DEL_YN
		               , MENU_GBN
		        ) VALUES (
		           :vo.rule_no
		          ,#if(!$vo.session_auth_comp_cd.equals(""))
						($vo.session_auth_comp_cd)
					#else
						''
					#end
		          ,:vo.up_rule_no
		          ,:vo.rule_depth
		          ,:vo.rule_srt
		          ,'N'
		          #if(!$vo.gu.equals(""))
		              ,:vo.one_rule_title_input
		              ,''
		              ,''
		              ,''
		          #else
		              ,:vo.rule_title
		              ,:vo.rule_title_en
		              ,:vo.rule_cont
		              ,:vo.rule_cont_en
		          #end
		          ,GETDATE()
		          ,:vo.reg_id
		          ,:vo.reg_nm
		          ,'N'
		          , 'C05301'
		        )
		    ]]>
		  </statement>
		</query>
		
	    <!-- 프로세스&규정지침서 상세조회: 2011.09.01 : 신남원 -->
		<query id="clm.admin.detailRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		      SELECT RULE_NO
		           , UP_RULE_NO
		           , RULE_DEPTH
		           , RULE_SRT
		           , DN_RULE_EXIST_YN
		           , RULE_TITLE
		           , RULE_TITLE_EN
		           , RULE_CONT
		           , RULE_CONT_EN
		           , REG_DT
		           , REG_ID
		           , REG_NM
		           , MOD_DT
		           , MOD_ID
		           , MOD_NM
		           , DEL_YN
		           , DEL_DT
		           , DEL_ID
		           , DEL_NM
		        FROM TN_CLM_PRCS_RULE
		       WHERE RULE_NO = :vo.rule_no
		       	#if(!$vo.session_auth_comp_cd.equals(""))
					AND COMP_CD IN ($vo.session_auth_comp_cd)
				#end
		    ]]>
		  </statement>
		</query>
				
	    <!-- 프로세스&규정지침서 수정 : 2011.09.01 : 신남원 -->		
		<query id="clm.admin.modifyRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         UPDATE TN_CLM_PRCS_RULE
				    SET RULE_CONT_EN 	= :vo.rule_cont_en 
				      , MOD_DT    		= GETDATE()
				      , MOD_ID    		= :vo.mod_id
				      , MOD_NM    		= :vo.mod_nm
				  WHERE RULE_NO   		= :vo.rule_no
				  	#if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
	    <!-- 프로세스&규정지침서 삭제 : 2011.09.01 : 신남원 -->		
		<query id="clm.admin.deleteRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         UPDATE TN_CLM_PRCS_RULE
				    SET DEL_YN  = 'Y' 
				      , DEL_DT  = GETDATE()
				      , DEL_ID  = :vo.del_id
				      , DEL_NM  = :vo.del_nm
				  WHERE RULE_NO = :vo.rule_no
				  	#if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
		<query id="clm.admin.maxRegulationNo" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT MAX(RULE_NO) AS MAX_RULE_NO
		          FROM TN_CLM_PRCS_RULE
		          	#if(!$vo.session_auth_comp_cd.equals(""))
						WHERE COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
		<!-- 프로세스&규정지침서 1단계 조회 : 2011.09.20 : dawn -->	
		<query id="clm.admin.listODepthRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT RULE_NO
		              , UP_RULE_NO
		              , RULE_DEPTH
		              , RULE_SRT
		              , DN_RULE_EXIST_YN
		              , RULE_TITLE
		              , RULE_CONT
				   FROM TN_CLM_PRCS_RULE
				  WHERE RULE_DEPTH = 1
				    AND RULE_SRT   = 1
				    #if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
				  ORDER BY UP_RULE_NO, RULE_DEPTH, RULE_SRT
		    ]]>
		  </statement>
		</query>
		
		<!-- 등록 화면 전체depth(selectbox)조회. : 2011.09.20 : dawn -->	
		<query id="clm.admin.listUpRule" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT * FROM
		         (SELECT RULE_NO
				      , UP_RULE_NO
				      , RULE_DEPTH
				      , RULE_SRT
				      , DN_RULE_EXIST_YN
				      , RULE_TITLE
				      , RULE_CONT
				      , REG_DT
				      , REG_ID
				      , REG_NM
				   FROM TN_CLM_PRCS_RULE
					#if(!$vo.session_auth_comp_cd.equals(""))
						WHERE COMP_CD IN ($vo.session_auth_comp_cd)
					#else
						WHERE 1=1
					#end
						AND DEL_YN = 'N'
						AND UP_RULE_NO IN (
							SELECT UP_RULE_NO FROM TN_CLM_PRCS_RULE
							WHERE DEL_YN = 'N'
							GROUP BY UP_RULE_NO HAVING COUNT(UP_RULE_NO) >1 
						)
				  	) A
				  	WHERE RULE_DEPTH = 1
				  	ORDER BY UP_RULE_NO, RULE_DEPTH, RULE_SRT
		    ]]>
		  </statement>
		</query>
		
		<!-- 규정번호 max값 조회  : 2011.09.21 : dawn -->	
		<query id="clm.admin.maxRuleNoRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT ISNULL(MAX(RULE_NO)+1, 1) MAX_RULE_NO
  				   FROM TN_CLM_PRCS_RULE
		    ]]>
		  </statement>
		</query>
		
		<!-- 최상위가 null 일 경우  : 2011.09.21 : dawn -->	
		<query id="clm.admin.maxUpRuleNoRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT ISNULL(MAX(UP_RULE_NO)+1, 1) MAX_UP_RULE_NO
  				   	FROM TN_CLM_PRCS_RULE
  				#if(!$vo.session_auth_comp_cd.equals(""))
					WHERE COMP_CD IN ($vo.session_auth_comp_cd)
				#end
		    ]]>
		  </statement>
		</query>
		
		<!-- 현재 상위 규정번호 조회.  : 2011.09.21 : dawn -->	
		<query id="clm.admin.nUpRuleNoRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT UP_RULE_NO
  				   FROM TN_CLM_PRCS_RULE
  				  WHERE RULE_NO = :vo.srch_rule_choice
  				  	#if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
		<!-- 규정단계 max 값 조회.  : 2011.09.21 : dawn -->	
		<query id="clm.admin.maxRuleDepthRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT MAX(RULE_DEPTH) MAX_RULE_DEPTH
				      , MAX(RULE_SRT) MAX_RULE_SRT
				   FROM TN_CLM_PRCS_RULE
				  WHERE UP_RULE_NO = :vo.up_rule_no
				  	#if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
		<!-- 규정단계 max 값 조회.  : 2011.09.21 : dawn -->	
		<query id="clm.admin.maxRuleDepthTwoRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         SELECT MAX(RULE_DEPTH) MAX_RULE_DEPTH
				      , MAX(RULE_SRT)+1 MAX_RULE_SRT
				   FROM TN_CLM_PRCS_RULE
				  WHERE UP_RULE_NO = :vo.up_rule_no
				  	#if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
		<!-- 규정단계 max 값 조회.  : 2011.09.21 : dawn -->	
		<query id="clm.admin.modifyDnRuleExistYnRegulation" isCamelCase="false">
		  <statement>
		    <![CDATA[
		         UPDATE TN_CLM_PRCS_RULE
				    SET DN_RULE_EXIST_YN = 'Y'
				  WHERE UP_RULE_NO 	= :vo.up_rule_no 
				    AND RULE_DEPTH 	= :vo.rule_depth
				    AND RULE_SRT   	= :vo.rule_srt
				    #if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
		    ]]>
		  </statement>
		</query>
		
    </queries>
</queryservice>