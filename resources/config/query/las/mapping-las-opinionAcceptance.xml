<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>
    	
    	<!-- 페이징 리스트 조회 -->
        <query id="las.board.listOpinionAcceptance" isCamelCase="false" isDynamic="true">
            <statement>
            <![CDATA[
                SELECT  *
                  FROM  (
                        SELECT  ROW_NUMBER() OVER(ORDER BY A.SEQNO DESC ) AS RN
                               ,COUNT(1) over() TOTAL_CNT
                               ,A.*
                          FROM  (
                                
									SELECT 
											   A.SEQNO
										      , A.TITLE
										      , A.CONT
										      , A.EXPIRE_DATE
										      , A.PART_MEMBER_CNT
										      , A.REG_ID
										      , A.REG_NM
										      , A.REG_JIGYUP_NM										      
										      , A.REG_DEPT_NM
										      , CASE WHEN A.REG_DT > GETDATE() - 14 THEN 'Y' ELSE '' END NEW_YN
										      , CONVERT(CHAR(10), A.REG_DT, 23) AS REG_DT 
										      , A.MOD_ID
										      , CONVERT(CHAR(10), A.MOD_DT, 23) AS MOD_DT 
										      , A.DEL_YN
											  , (SELECT COUNT(DISTINCT REG_ID) FROM TN_LAS_OPINION_SURVEY_REPLY WHERE REF_SEQNO = A.SEQNO AND DEL_YN = 'N' ) AS REPLY_CNT 
											  
								 
								 FROM  TN_LAS_OPINION_SURVEY A
								 
								 WHERE  
								 			A.DEL_YN   = 'N'
								 
											 AND ( ( :vo.session_user_id IN ( SELECT USER_ID FROM TN_LAS_OPINION_ACCEPTANCE_USER WHERE DEL_YN = 'N' AND SEQNO = A.SEQNO AND A.STATUS = 'SENT')  )
											OR :vo.session_user_id = A.REG_ID )
							
											#if (!$vo.srch_word.equals(""))
											    #if ($vo.srch_combo.equals("title"))
											       AND A.TITLE LIKE '%' + :vo.srch_word + '%'
											    #elseif ($vo.srch_combo.equals("reg_nm"))
											       AND A.REG_NM LIKE '%' + :vo.srch_word + '%'
											    #else
											    	#if($vo.session_user_locale == 'ko')
											       		AND A.CONT LIKE '%' + :vo.srch_word + '%'
											       	#end
											    #end
											#end
				                            
				                            #if ($vo.srch_start_dt && !$vo.srch_start_dt.equals(""))
				                               AND    A.REG_DT >= CONVERT(DATETIME, REPLACE( :vo.srch_start_dt ,'-',''), 112) /*YYYY-MM-DD*/
				                            #end
				                        
				                            #if ($vo.srch_end_dt && !$vo.srch_end_dt.equals(""))
				                               AND    A.REG_DT <= CONVERT(DATETIME, REPLACE( :vo.srch_end_dt ,'-',''), 112) + 1 /*YYYY-MM-DD*/
				                            #end
                            
                                 ) A ) B
                 WHERE  B.RN BETWEEN :vo.start_index AND :vo.end_index
                 ORDER  BY RN
            ]]>
            </statement>
        </query>
        
        <!-- 상세 조회 -->
        <query id="las.board.detailOpinionAcceptance" isCamelCase="false">
            <statement>
            <![CDATA[
            
            		SELECT 
							   A.SEQNO
						      , A.TITLE
						      , A.CONT
						      , A.EXPIRE_DATE
						      , A.PART_MEMBER_CNT
						      , A.REG_ID
						      , A.REG_NM
					          , A.REG_JIGYUP_NM
					          , A.REG_DEPT_NM
						      , CASE WHEN A.REG_DT > GETDATE() - 14 THEN 'Y' ELSE '' END NEW_YN
						      , CONVERT(CHAR(10), A.REG_DT, 23) AS REG_DT 
						      , A.MOD_ID
						      , CONVERT(CHAR(10), A.MOD_DT, 23) AS MOD_DT 
						      , A.DEL_YN
						      , (SELECT COUNT(FILE_ID) FROM TN_COM_ATTACH where REF_KEY = A.SEQNO AND FILE_BIGCLSFCN = 'F007' AND FILE_MIDCLSFCN = 'ACC' ) AS ATT_CNT
		      				  , CASE 
							  		WHEN :vo.session_user_id = A.REG_ID THEN 'Y' 
							  		ELSE 'N'
							  END AS AUTH_YN
							  , A.STATUS
								 
				 	FROM  	
					 			TN_LAS_OPINION_SURVEY A 
					 			LEFT OUTER JOIN
					  			TB_COM_USER B
				 				ON A.REG_ID = B.USER_ID
				 				
                 
                 WHERE  
                 			A.SEQNO = :vo.seqno
                   AND	A.DEL_YN   = 'N'
            ]]>
            </statement> 
        </query>               
                
        <!-- 하단 답변 리스트 조회 -->
        <query id="las.board.detailListOpinionAcceptance" isCamelCase="false">
            <statement>
            <![CDATA[
							SELECT  
										ROW_NUMBER() OVER (ORDER  BY RE_SEQNO DESC ) RN
										,A.RE_SEQNO
										,A.REF_SEQNO
										,A.TITLE
										,A.CONT
										,CONVERT(CHAR(10), A.REG_DT, 23) AS REG_DT
										,A.REG_ID
										,A.REG_NM
										,A.REG_JIGYUP_NM
										,A.REG_DEPT_NM
										,CONVERT(CHAR(10), A.MOD_DT, 23) AS MOD_DT
										,A.MOD_ID
							FROM  
										TN_LAS_OPINION_SURVEY_REPLY A
							WHERE  
										A.DEL_YN   = 'N' 
							AND   
										A.REF_SEQNO = :vo.seqno
							
							ORDER BY RN
            ]]>
            </statement>
        </query>        
        
        <!-- 수정용 답변 내용 조회 -->
        <query id="las.board.detailOpinionAcceptanceReply" isCamelCase="false">
            <statement>
            <![CDATA[
							SELECT  
										A.RE_SEQNO
										,A.REF_SEQNO
										,A.TITLE
										,A.CONT
										,CONVERT(CHAR(10), A.REG_DT, 23) AS REG_DT
										,A.REG_ID
										,A.REG_NM
										,A.REG_JIGYUP_NM
										 ,A.REG_DEPT_NM
										,CONVERT(CHAR(10), A.MOD_DT, 23) AS MOD_DT
										,A.MOD_ID
										,A.MOD_DT
							FROM  
										TN_LAS_OPINION_SURVEY_REPLY A
							WHERE  
										A.DEL_YN   = 'N' 
							AND   
										A.RE_SEQNO = :vo.re_seqno					
            ]]>
            </statement>
        </query>        
        
        <!-- 등록 -->
        <query id="las.board.insertOpinionAcceptance" isCamelCase="false">
            <statement>
            <![CDATA[
                INSERT  INTO  TN_LAS_OPINION_SURVEY (
					           SEQNO
					           ,TITLE
					           ,CONT
					           ,EXPIRE_DATE
					           ,PART_MEMBER_CNT
					           ,REG_ID
					           ,REG_NM
					           ,REG_JIGYUP_NM
					           ,REG_DEPT_NM
					           ,REG_DT
					           ,DEL_YN
					           ,STATUS
						)
                VALUES (
                        CAST(:vo.seqno AS NUMERIC ),
				   		:vo.title,
                        :vo.cont,
                        :vo.expire_date,
                        :vo.part_member_cnt,
                        :vo.session_user_id,
                        :vo.session_user_nm,
                        :vo.session_jikgup_nm,
                        :vo.session_dept_nm,
                        GETDATE(),
                        'N',
                        'SAVED'                       
                       )
            ]]>
            </statement>
        </query>
		
		<!-- 수정 -->
		<query id="las.board.modifyOpinionAcceptance" isCamelCase="false">
			<statement>
			    <![CDATA[
			         UPDATE TN_LAS_OPINION_SURVEY
			          SET TITLE = :vo.title
			              , CONT = :vo.cont
			              , PART_MEMBER_CNT =  :vo.part_member_cnt
			              , MOD_DT = GETDATE() 
			              , MOD_ID = :vo.session_user_id 
			          WHERE  SEQNO = :vo.seqno
			    ]]>
			</statement>
		</query>
		
		<!-- 과제 답변 대상자 메일 발송 /  과제 스테이터스 변경 -->
		<query id="las.board.sendRequestReplyOpinion" isCamelCase="false">
			<statement>
			    <![CDATA[
			         UPDATE TN_LAS_OPINION_SURVEY
			          SET STATUS = 'SENT'
			              , MOD_DT = GETDATE() 
			              , MOD_ID = :vo.session_user_id 
			          WHERE  SEQNO = :vo.seqno
			    ]]>
			</statement>
		</query>		
        
         <!-- 답변 등록 -->
        <query id="las.board.insertOpinionAcceptanceReply" isCamelCase="false">
            <statement>
            <![CDATA[
                INSERT  INTO  TN_LAS_OPINION_SURVEY_REPLY (
					            RE_SEQNO
					           ,REF_SEQNO
					           ,TITLE
					           ,CONT
					           ,REG_ID
					           ,REG_NM
					           ,REG_JIGYUP_NM
					           ,REG_DEPT_NM
					           ,REG_DT
					           ,DEL_YN
						)
                VALUES (
                		CAST(:vo.re_seqno AS NUMERIC ),
                        :vo.seqno,
				   		:vo.title,
                        :vo.cont,
                        :vo.session_user_id,
                        :vo.session_user_nm,
                        :vo.session_jikgup_nm,
                        :vo.session_dept_nm,
                        GETDATE(),
                        'N'                        
                       )
            ]]>
            </statement>
        </query> 
        
         <!-- 답변 등록시 유저리스트에 답변 유무 갱신 -->
        <query id="las.board.insertOpinionAcceptanceReplyYN" isCamelCase="false">
            <statement>
            <![CDATA[
			         UPDATE  TN_LAS_OPINION_ACCEPTANCE_USER 
			          SET REPLY_YN = :vo.reply_yn 
			          WHERE SEQNO = :vo.seqno 
			          AND USER_ID =  :vo.session_user_id
            ]]>
            </statement>
        </query> 
        
        <!-- 답변 삭제 시 유저리스트에 답변 유무 갱신 -->
        <query id="las.board.insertOpinionAcceptanceReplyCnt" isCamelCase="false">
            <statement>
            <![CDATA[
              	SELECT COUNT(RE_SEQNO) AS ANS_CNT FROM TN_LAS_OPINION_SURVEY_REPLY 
              	WHERE DEL_YN = 'N' 
              	AND REF_SEQNO = :vo.seqno  
              	AND REG_ID =:vo.session_user_id
            ]]>
            </statement>
        </query>         
        
        <!-- 수정 -->
		<query id="las.board.modifyOpinionAcceptanceReply" isCamelCase="false">
			<statement>
			    <![CDATA[
			         UPDATE TN_LAS_OPINION_SURVEY_REPLY
			          SET TITLE = :vo.title
			              , CONT = :vo.cont
			              , MOD_DT = GETDATE() 
			              , MOD_ID = :vo.session_user_id 
			          WHERE  RE_SEQNO = :vo.re_seqno
			    ]]>
			</statement>
		</query>
		
		<!-- 초기 참여자 리스트 조회 ( 법인 전체 LEGAL ADMIN / 검토자(RA02) -->
        <query id="las.board.getOpinionAcceptanceUser" isCamelCase="false">
			<statement>
    		<![CDATA[
    		
    		SELECT * FROM (
			
			   SELECT 
	 					DISTINCT A.USER_ID
						,A.SINGLE_ID
						,A.EMAIL		
						,A.USER_NM 
						,A.USER_NM_ENG
						,A.DEPT_NM
						,A.DEPT_NM_ENG
						,A.JIKGUP_NM
						,A.JIKGUP_NM_ENG
						,A.COMP_NM		
						,A.COMP_NM_ENG
						,A.OFFICE_TEL_NO
						,A.MOBILE_NO			

				FROM 
						TB_COM_USER A,
						TB_COM_ROLE_USER B
				WHERE 
					 A.USER_ID = B.USER_ID 

				AND B.ROLE_CD = 'RA01'
						AND A.COMP_NM <> ''
						AND A.DEPT_NM <> ''
						AND A.JIKGUP_NM <> ''

				UNION 

				SELECT 
	 					DISTINCT A.USER_ID
						,A.SINGLE_ID
						,A.EMAIL		
						,A.USER_NM 
						,A.USER_NM_ENG
						,A.DEPT_NM
						,A.DEPT_NM_ENG
						,A.JIKGUP_NM
						,A.JIKGUP_NM_ENG
						,A.COMP_NM		
						,A.COMP_NM_ENG
						,A.OFFICE_TEL_NO
						,A.MOBILE_NO	
									
				FROM 
						TB_COM_USER A,
						TB_COM_ROLE_USER B
				WHERE 
					 A.USER_ID = B.USER_ID 

				AND B.ROLE_CD = 'RA02'
						AND A.COMP_NM <> ''
						AND A.DEPT_NM <> ''
						AND A.JIKGUP_NM <> ''
						
				) Z 
				
				ORDER BY COMP_NM

             ]]>
			</statement>
		</query>   
	
  		<!-- 참여자 등록 -->
		<query id="las.board.insertOpinionAcceptanceUser" isCamelCase="false">
			<statement>
			<![CDATA[
				 INSERT INTO TN_LAS_OPINION_ACCEPTANCE_USER 
				        (
				         USER_SEQNO
				         ,USER_ID
				         ,SINGLE_ID
				         ,EMAIL
				         ,USER_NM
				         ,DEPT_NM
				         ,JIKGUP_NM
				         ,COMP_NM
				         ,MIS_ID
				         ,REG_DT
						 ,REG_ID
						 ,SEQNO
						 ,REPLY_YN
						 ,DEL_YN
				         ) 
				        VALUES
				        (
				         :vo.userSeqno
				         , RTRIM(LTRIM( :vo.userEpid ))
				         , RTRIM(LTRIM( :vo.userSingleId ))
				         , RTRIM(LTRIM( :vo.userEmail ))
				         , RTRIM(LTRIM( :vo.userName ))
				         , RTRIM(LTRIM( :vo.userDeptNm ))
				         , RTRIM(LTRIM( :vo.userJikupNm ))
				         , RTRIM(LTRIM( :vo.userCompNm ))
				         ,''
				         ,GETDATE()
				         ,:vo.reg_id
				         ,:vo.seqno
				         ,'N'
				         ,'N'
				         )
			]]>
			</statement>
		</query>
		
		<!-- 참여자 리스트 상세조회 -->
        <query id="las.board.listOpinionAcceptanceUser" isCamelCase="false">
			<statement>
    		<![CDATA[
    			SELECT  A.USER_SEQNO
    					,A.USER_ID
    					,A.SINGLE_ID
    					,A.EMAIL
    					,A.USER_NM
    					,A.DEPT_NM
    					,A.JIKGUP_NM 
    					,A.COMP_NM
    					,A.MIS_ID
    					,A.REG_DT
    					,A.REG_ID
    					,A.SEQNO
    					    					,A.REPLY_YN
                  FROM  TN_LAS_OPINION_ACCEPTANCE_USER A
                 WHERE  A.SEQNO = :vo.seqno        
             ]]>
			</statement>
		</query> 
		
		<!-- 참여자 전체 삭제 -->
		<query id="las.board.deleteAllOpinionAcceptance" isCamelCase="false">
			<statement>
			<![CDATA[
				 DELETE FROM TN_LAS_OPINION_ACCEPTANCE_USER WHERE SEQNO = :vo.seqno 
			]]>
			</statement>
		</query>	       
		
		<!-- MAX ACC_NO을 조회 -->
		<query id="las.board.bbs.getNextAccno" isCamelCase="false">
			<statement>
	            <![CDATA[
					SELECT	ISNULL(MAX(SEQNO)+1,1) NEXT_ACC_NO
					  FROM	TN_LAS_OPINION_SURVEY
	            ]]>
			</statement>
		</query>
		
		<!-- MAX TOTAL_SEQNO을 조회 -->
		<query id="las.board.bbs.getNextRefSeqno" isCamelCase="false">
			<statement>
	            <![CDATA[
					SELECT	ISNULL(MAX(RE_SEQNO)+1,1) NEXT_RE_SEQNO
					  FROM	TN_LAS_OPINION_SURVEY_REPLY
	            ]]>
			</statement>
		</query>	
	        
        <!-- 과제 삭제-->
        <query id="las.board.deleteOpinionAcceptance" isCamelCase="false">
            <statement>
            <![CDATA[
                UPDATE  TN_LAS_OPINION_SURVEY
                   SET  DEL_YN = 'Y'
                       ,MOD_DT = GETDATE()
                       ,MOD_ID = :vo.session_user_id
                 WHERE  SEQNO = :vo.seqno
            ]]>
            </statement>
        </query>
        
        <!-- 답변 삭제-->
        <query id="las.board.deleteOpinionAcceptanceReply" isCamelCase="false">
            <statement>
            <![CDATA[
                UPDATE  TN_LAS_OPINION_SURVEY_REPLY
                   SET  DEL_YN = 'Y'
                       ,MOD_DT = GETDATE()
                       ,MOD_ID = :vo.session_user_id
                 WHERE  RE_SEQNO = :vo.re_seqno
            ]]>
            </statement>
        </query>
        
        <!-- 과제 권한 체크-->
        <query id="las.board.authOpinionAcceptance" isCamelCase="false">
            <statement>
            <![CDATA[
					SELECT SEQNO FROM TN_LAS_OPINION_SURVEY  
					WHERE SEQNO = :vo.seqno 
					AND REG_ID = :vo.session_user_id
            ]]>
            </statement>
        </query>
        
        <!-- 답변 권한 체크-->
        <query id="las.board.authOpinionAcceptanceReply" isCamelCase="false">
            <statement>
            <![CDATA[
					SELECT re_seqno FROM TN_LAS_OPINION_SURVEY_REPLY  
					WHERE RE_SEQNO = :vo.re_seqno 
					AND REG_ID = :vo.session_user_id
            ]]>
            </statement>
        </query>
		
    </queries>
</queryservice>
