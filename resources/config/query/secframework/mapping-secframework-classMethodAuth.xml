<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
	<queries>
		<!-- 페이징 리스트 조회 -->
		<query id="secfw.classmethodauth.listPage" isCamelCase="false">
			<statement>
            <![CDATA[
            	SELECT *
                  FROM(
                    SELECT ROWNUM RM
                          ,COUNT(1) OVER() TOTAL_CNT
                          ,A.*
                      FROM (
                    		SELECT SYS_CD 
                    			  ,CLASS_NM 
                    		  	  ,METHOD_NM
                    		  	  ,CHECK_YN
                    		  	  ,SYS_CD || ':' || CLASS_NM || ':' || METHOD_NM AS DELETE_KEY
        				  	  FROM TB_COM_CLASS_METHOD
        				  	 WHERE SYS_CD = :vo.sys_cd 
        				  	 	#if($vo.class_srch_word.length() > 0)
        				  	 AND CLASS_NM LIKE '%' || :vo.class_srch_word || '%'
        				  	 	#end
        				  	 	#if($vo.method_srch_word.length() > 0)
        				  	 AND METHOD_NM LIKE '%' || :vo.method_srch_word || '%'
        				  	 	#end
        				  	 	#if(!$vo.srch_type.equals("ALL"))
        					 AND CHECK_YN = :vo.srch_type
        					 	#end
                           ORDER BY CLASS_NM, METHOD_NM ) A
				    ) B
				WHERE B.RM BETWEEN :vo.start_index and :vo.end_index
				 	 
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD 테이블 row 삭제 -->
		<query id="secfw.classmethodauth.delete" isCamelCase="false">
			<statement>
            <![CDATA[
            DELETE 
              FROM TB_COM_CLASS_METHOD
              WHERE SYS_CD = :vo.sys_cd
              AND CLASS_NM = :vo.class_nm
              AND METHOD_NM = :vo.method_nm
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 row 삭제(메소드 전체)  -->
		<query id="secfw.classmethodauth.deleteRole" isCamelCase="false">
			<statement>
            <![CDATA[
            DELETE 
              FROM TB_COM_CLASS_METHOD_AUTH
              WHERE SYS_CD = :vo.sys_cd
              AND CLASS_NM = :vo.class_nm
              AND METHOD_NM = :vo.method_nm
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 row 삭제(auth_cd기준)  -->
		<query id="secfw.classmethodauth.deleteRole2" isCamelCase="false">
			<statement>
            <![CDATA[
            DELETE 
              FROM TB_COM_CLASS_METHOD_AUTH
              WHERE SYS_CD = :vo.sys_cd
              AND CLASS_NM = :vo.class_nm
              AND METHOD_NM = :vo.method_nm
              AND AUTH_CD = :vo.auth_cd
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD detail  -->
		<query id="secfw.classmethodauth.detail" isCamelCase="false">
			<statement>
            <![CDATA[
            SELECT *
              FROM TB_COM_CLASS_METHOD
              WHERE SYS_CD = :vo.sys_cd
              AND CLASS_NM = :vo.class_nm
              AND METHOD_NM = :vo.method_nm
            ]]>
			</statement>
		</query>

		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 메소드별 role 검색  -->
		<query id="secfw.classmethodauth.listRole" isCamelCase="false">
			<statement>
            <![CDATA[
            SELECT AUTH_CD
              FROM TB_COM_CLASS_METHOD_AUTH
              WHERE SYS_CD = :vo.sys_cd
              AND CLASS_NM = :vo.class_nm
              AND METHOD_NM = :vo.method_nm
              ORDER BY AUTH_CD
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 메소드별 AUTH 검색  -->
		<query id="secfw.classmethodauth.listAuth" isCamelCase="false">
			<statement>
            <![CDATA[
            SELECT A.AUTH_CD, B.AUTH_NM
              FROM TB_COM_CLASS_METHOD_AUTH A, TB_COM_AUTH B
              WHERE A.SYS_CD = :vo.sys_cd
              AND A.SYS_CD = B.SYS_CD
              AND A.CLASS_NM = :vo.class_nm
              AND A.METHOD_NM = :vo.method_nm
              AND A.AUTH_CD = B.AUTH_CD
              ORDER BY A.AUTH_CD
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 메소드별 role 검색  -->
		<query id="secfw.classmethodauth.listNotRole" isCamelCase="false">
			<statement>
            <![CDATA[
            SELECT AUTH_CD
              FROM TB_COM_ROLE
             WHERE AUTH_CD NOT IN(SELECT AUTH_CD
              					  FROM TB_COM_CLASS_METHOD_AUTH
              					  WHERE SYS_CD = :vo.sys_cd
              					  AND CLASS_NM = :vo.class_nm
              					  AND METHOD_NM = :vo.method_nm
              					  )
             ORDER BY AUTH_CD
            ]]>
			</statement>
		</query>	
		
		<!-- TB_COM_CLASS_METHOD_AUTH 테이블 메소드별 AUTH 검색  -->
		<query id="secfw.classmethodauth.listNotAuth" isCamelCase="false">
			<statement>
            <![CDATA[
            SELECT AUTH_CD, AUTH_NM
              FROM TB_COM_AUTH
             WHERE
             	SYS_CD = :vo.sys_cd
             	AND AUTH_CD NOT IN(SELECT AUTH_CD
              					  FROM TB_COM_CLASS_METHOD_AUTH
              					  WHERE SYS_CD = :vo.sys_cd
              					  AND CLASS_NM = :vo.class_nm
              					  AND METHOD_NM = :vo.method_nm
              					  )
             ORDER BY AUTH_CD
            ]]>
			</statement>
		</query>	

		<!-- TB_COM_CLASS_METHOD 테이블 삽입-->
		<query id="secfw.classmethodauth.insert" isCamelCase="false">
			<statement>
            <![CDATA[
            INSERT INTO TB_COM_CLASS_METHOD 
                      ( SYS_CD
					   ,CLASS_NM
            	       ,METHOD_NM
            	       ,CHECK_YN
            	       ,REG_ID
            	       ,REG_NM
            	       ,REG_JIKGUP_NM
            	       ,REG_DEPT_NM
            	       ,REG_DT
            	       ,MOD_ID
            	       ,MOD_NM
            	       ,MOD_JIKGUP_NM
            	       ,MOD_DEPT_NM
            	   	   ,MOD_DT )
           		VALUES( :vo.sys_cd
           		       ,:vo.class_nm
           		       ,:vo.method_nm
           		       ,:vo.check_yn
           		       ,:vo.reg_id
           		       ,:vo.reg_nm
           		       ,:vo.reg_jikgup_nm
           		       ,:vo.reg_dept_nm
           		       ,sysdate
           		       ,:vo.mod_id
           		       ,:vo.mod_nm
           		       ,:vo.mod_jikgup_nm
           		       ,:vo.mod_dept_nm
           		       ,sysdate )
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD 테이블 수정-->
		<query id="secfw.classmethodauth.modify" isCamelCase="false">
			<statement>
            <![CDATA[
            UPDATE TB_COM_CLASS_METHOD
               SET CHECK_YN = :vo.check_yn
            	   ,MOD_ID = :vo.mod_id
                   ,MOD_NM = :vo.mod_nm
            	   ,MOD_JIKGUP_NM = :vo.mod_jikgup_nm
            	   ,MOD_DEPT_NM = :vo.mod_dept_nm
            	   ,MOD_DT = sysdate
       	     WHERE  SYS_CD = :vo.sys_cd
               		AND CLASS_NM = :vo.class_nm
               		AND METHOD_NM = :vo.method_nm 
            ]]>
			</statement>
		</query>
		
		<!-- TB_COM_CLASS_METHOD_ROLE 테이블 삽입 및 수정  -->
		<query id="secfw.classmethodauth.insertRole" isCamelCase="false">
			<statement>
            <![CDATA[
            MERGE INTO TB_COM_CLASS_METHOD_AUTH A
            USING
            ON( A.SYS_CD = :vo.sys_cd
               AND A.CLASS_NM = :vo.class_nm
               AND A.METHOD_NM = :vo.method_nm
               AND A.AUTH_CD = :vo.auth_cd
              )
            WHEN MATCHED THEN
           		UPDATE SET
            	   MOD_ID = :vo.mod_id
                   ,MOD_NM = :vo.mod_nm
            	   ,MOD_JIKGUP_NM = :vo.mod_jikgup_nm
            	   ,MOD_DEPT_NM = :vo.mod_dept_nm
            	   ,MOD_DT = sysdate
            WHEN NOT MATCHED THEN
            	INSERT( SYS_CD
            	       ,CLASS_NM
            	       ,METHOD_NM
            	       ,AUTH_CD
            	       ,REG_ID
            	       ,REG_NM
            	       ,REG_JIKGUP_NM
            	       ,REG_DEPT_NM
            	       ,REG_DT
            	       ,MOD_ID
            	       ,MOD_NM
            	       ,MOD_JIKGUP_NM
            	       ,MOD_DEPT_NM
            	   	   ,MOD_DT )
           		VALUES( :vo.sys_cd
           		       ,:vo.class_nm
           		       ,:vo.method_nm
           		       ,:vo.auth_cd
           		       ,:vo.reg_id
           		       ,:vo.reg_nm
           		       ,:vo.reg_jikgup_nm
           		       ,:vo.reg_dept_nm
           		       ,sysdate
           		       ,:vo.mod_id
           		       ,:vo.mod_nm
           		       ,:vo.mod_jikgup_nm
           		       ,:vo.mod_dept_nm
           		       ,sysdate )
            ]]>
			</statement>
		</query>
        
        <!-- 메소드 권한 리스트(ROLE) -->
        <query id="shri.method.listAuth" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT  B.AUTH_CD
                       ,A.CHECK_YN
                  FROM  TB_COM_CLASS_METHOD A
                       ,TB_COM_CLASS_METHOD_AUTH B
                 WHERE  A.SYS_CD = B.SYS_CD(+)
                   AND  A.CLASS_NM = B.CLASS_NM(+)
                   AND  A.METHOD_NM = B.METHOD_NM(+)
                   AND  A.CLASS_NM = :vo.class_nm
                   AND  A.METHOD_NM = :vo.method_nm
            ]]>
            </statement>
        </query>
        
        <!-- 메소드 권한 리스트 -->
        <query id="clms.method.listMethodAuth" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT  B.AUTH_CD
                       ,A.CHECK_YN
                  FROM  TB_COM_CLASS_METHOD A
                       ,TB_COM_CLASS_METHOD_AUTH B
                 WHERE  
                   A.SYS_CD = :vo.sys_cd
                   AND  A.SYS_CD = B.SYS_CD(+)
                   AND  A.CLASS_NM = B.CLASS_NM(+)
                   AND  A.METHOD_NM = B.METHOD_NM(+)
                   AND  A.CLASS_NM = :vo.class_nm
                   AND  A.METHOD_NM =:vo.method_nm
            ]]>
            </statement>
        </query>
        
        <!-- 메서드권한 로그 남기기 -->
        <query id="secfw.classmethodauth.insertLog" isCamelCase="false">
            <statement>
            <![CDATA[
                INSERT INTO TN_COM_ACTION_STAT2
                	  ( SYS_CD
                	   ,USER_ID
                	   ,EMP_NO
                	   ,SINGLE_ID
                       ,SINGLE_EPID
                       ,USER_NM
                       ,JIKGUP_CD
                       ,JIKGUP_NM
                       ,DEPT_CD
                       ,DEPT_NM
                       ,COMP_CD
                       ,COMP_NM
                       ,MENU_ID
                       ,MENU_NM
                       ,MENU_URL
                       ,YEAR
                       ,MONTH
                       ,DAY
                       ,HOUR
                       ,CLASS_NM
                       ,METHOD_NM
                       ,PARAMETER
                       ,ACTION_DT
                   	  )
               VALUES
               		  (
               		    :sys_cd
               		   ,:user_id
               		   ,:emp_no
               		   ,:single_id
               		   ,:single_id
               		   ,:user_nm
               		   ,:jikgup_cd
               		   ,:jikgup_nm
               		   ,:dept_cd
               		   ,:dept_nm
               		   ,:comp_cd
               		   ,:comp_nm
               		   ,:menu_id
               		   ,:menu_nm
               		   ,:menu_url
               		   ,CAST(YEAR(GETDATE()) AS VARCHAR(4))   /*YYYY*/               	
					   ,RIGHT('0'+CAST(MONTH(GETDATE() ) AS VARCHAR(2)) ,2) /*MM*/
					   ,RIGHT('0'+CAST(DAY(GETDATE() ) AS VARCHAR(2)) ,2) /*DD*/
				       ,REPLACE(CONVERT(VARCHAR(10),GETDATE(),24),':','') /*HH24MISS*/
               		   ,:class_nm
               		   ,:method_nm
               		   ,:parameter
               		   ,GETDATE()
               		  )
            ]]>
            </statement>
        </query>
	</queries>
</queryservice>