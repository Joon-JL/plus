<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>

        <!-- ######################################################################### -->
        <!-- ##########                  메일내역 조회                      ########## -->
        <!-- ######################################################################### -->
        <!-- 메일 발송내역 조회 -->
        <query id="secfw.singleIF.mail.listMail" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT *
                  FROM (
                        SELECT ROW_NUMBER() OVER (ORDER BY CREATE_DATE DESC) RN
                             , T.*
                             , COUNT(1) OVER() TOTAL_CNT
                          FROM (
                             -- Business Logic
                                SELECT MODULE_ID
                                     , MIS_ID
                                     , MSG_KEY
                                     , SUBJECT
                                     , BODY
                                     , MSG_TYPE
                                     , BHTML_CONTENT_CHECK
                                     , IFILE_COUNT
                                     , TIME_ZONE
                                     , IS_DST
                                     , SENDER_MAIL_ADDR
                                     , STATUS
                                     , LEFT( CREATE_DATE ,8)+' '+	SUBSTRING( CREATE_DATE ,9,2)
                                     	+':'+ SUBSTRING( CREATE_DATE ,11,2)+':'+RIGHT( CREATE_DATE ,2)  AS CREATE_DATE
                                  FROM TB_COM_HEADER_HELPER_CSVO
                                 WHERE 1 = 1
                                   AND CREATE_DATE BETWEEN :vo.srch_start_ymd + '000000' AND :vo.srch_end_ymd + '999999'
                        #if ($vo.srch_user_level && !$vo.srch_user_level.equals("A"))
                                   AND SENDER_SINGLE_ID = :vo.srch_single_id
                        #end
                        #if ($vo.srch_status && !$vo.srch_status.equals(""))
                                   AND STATUS = :vo.srch_status
                        #end
                                -- Business Logic
                               ) T
                       ) TA
                 WHERE RN BETWEEN :vo.start_index AND :vo.end_index
                 ORDER BY RN
            ]]>
            </statement>
        </query>

        <!-- 메일상태가 진행중인건을 가져온다. -->
        <query id="secfw.singleIF.mail.listTargetList" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MIS_ID
                     , IFILE_COUNT
                     , BODY
                     , BHTML_CONTENT_CHECK
                     , COUNT(*) OVER() AS TOTAL_CNT
                  FROM TB_COM_HEADER_HELPER_CSVO
                 WHERE STATUS = :status
                 ORDER BY CREATE_DATE ASC
            ]]>
            </statement>
        </query>

        <!-- 메일 Header 정보를 가져온다. -->
        <query id="secfw.singleIF.mail.getMailHeader" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MSG_KEY
                     , SUBJECT
                     , BODY
                     , MSG_TYPE
                     , BHTML_CONTENT_CHECK
                     , IFILE_COUNT
                     , TIME_ZONE
                     , IS_DST
                     , SENDER_MAIL_ADDR
                     , SENDER_SINGLE_ID
                     , CREATE_DATE
                  FROM TB_COM_HEADER_HELPER_CSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 보안메일 정보를 가져온다. -->
        <query id="secfw.singleIF.mail.getDrmInfo" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MSG_KEY
                     , DRM_TYPE
                     , DRM_CAN_PRINT
                     , DRM_CAN_SAVE
                     , DRM_USE_COUNT
                     , DRM_PC_COUNT
                     , DRM_VALID_DAYS
                     , DRM_CONFIRM_MAIL4INT
                     , DRM_CONFIRM_MAIL4EXT
                     , DRM_CAN_VIEW_RCPT
                  FROM TB_COM_HEADER_HELPER_CSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 발신자 정보를 가져온다. -->
        <query id="secfw.singleIF.mail.getMailResource" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , EMAIL
                     , LOCALE
                     , ENCODING
                     , PASSWORD
                  FROM TB_COM_RESOURCE_CSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 수신자 정보를 가져온다. -->
        <!-- 2014-02-13 Kevin. 허. 참...어이가 없다. 메일 주소 가져오려고 평균 15초를 돈다. 헐~~ 이런 쿼리는 개나 줘 버려... 그래서 아래 쿼리로 수정함.
        <query id="secfw.singleIF.mail.listMailRecipient" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , MIS_ID
                     , ISEQ_ID
                     , REC_TYPE
                     , REC_ADDR
                     , NAME
                     , POSITION
                     , DEPARTMENT
                     , COMPANY
                     , EPID
                     , SEND_TIME
                     , DELV_TIME
                     , SEEN_TIME
                     , STATUS
                     , COUNT(*) OVER() AS TOTAL_CNT
                  FROM TB_COM_RECIPIENT_ETY_CSVO A
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
                   /* TB_COM_USER에 없는 사용자인 경우 메일발송하게 하고 TB_COM_USER에 있는 사용자인 경우 수신여부(EMAIL_RCV_YN)를 체크한다.  */ 
                   AND EXISTS
		                (SELECT 'E'
		                   FROM TB_COM_USER
		                  WHERE    0 = (SELECT COUNT (*)
		                                  FROM TB_COM_USER
		                                 WHERE EMAIL = A.REC_ADDR)
		                        OR (EMAIL = A.REC_ADDR AND EMAIL_RCV_YN = 'Y'))
                 ORDER BY ISEQ_ID ASC
            ]]>
            </statement>
        </query>
 		-->
 		<!-- 2014-02-13 Kevin 성능 개선으로 새로 변경 된 쿼리. -->
 		<query id="secfw.singleIF.mail.listMailRecipient" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT A.MODULE_ID, A.MIS_ID, A.ISEQ_ID, A.REC_TYPE, A.REC_ADDR, A.NAME, A.POSITION, A.DEPARTMENT, A.COMPANY, A.EPID, A.SEND_TIME, A.DELV_TIME, A.SEEN_TIME, B.STATUS, COUNT(*) OVER () AS TOTAL_CNT
				FROM TB_COM_RECIPIENT_ETY_CSVO A
				INNER JOIN TB_COM_USER AS B ON A.REC_ADDR = B.EMAIL AND B.EMAIL_RCV_YN = 'Y'
				WHERE A.MODULE_ID = :module_id AND A.MIS_ID = :mis_id 
            ]]>
            </statement>
        </query>
        
        
        <!-- 첨부파일 정보를 가져온다. : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원 -->
        <query id="secfw.singleIF.mail.listMailAttach" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT MODULE_ID
                     , ISEQ_ID
                     , FILE_NAME
                     , LOCAL_PATH
                     , COUNT(*) OVER() AS TOTAL_CNT
                  FROM TB_COM_ATTACH_ETY_CSVO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
                 ORDER BY ISEQ_ID ASC
            ]]>
            </statement>
        </query>

        <!-- ######################################################################### -->
        <!-- ##########                  메일 정보 등록                     ########## -->
        <!-- ######################################################################### -->

        <!-- 메일내역 등록 -->
        <query id="secfw.singleIF.mail.insertMailHeader">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_HEADER_HELPER_CSVO (
                        MODULE_ID
                      , MIS_ID
                      , MSG_KEY
                      , SUBJECT
                      , BODY
                      , MSG_TYPE
                      , BHTML_CONTENT_CHECK
                      , IFILE_COUNT
                      , TIME_ZONE
                      , IS_DST
                      , SENDER_MAIL_ADDR
                      , SENDER_SINGLE_ID
                      , STATUS
                      , CREATE_DATE
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.msg_key
                      , :vo.subject
                      , :vo.body
                      , :vo.msg_type
                      , :vo.bhtml_content_check
                      , :vo.ifile_count
                      , :vo.time_zone
                      , :vo.is_dst
                      , :vo.sender_mail_addr
                      , :vo.sender_single_id
                      , :vo.status
                      , :vo.create_date
                  )
            ]]>
            </statement>
        </query>

        <!-- 메일 송신자 내역 등록 -->
        <query id="secfw.singleIF.mail.insertMailResource">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_RESOURCE_CSVO (
                        MODULE_ID
                      , MIS_ID
                      , EMAIL
                      , LOCALE
                      , ENCODING
                      , PASSWORD
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.sender_mail_addr
                      , ISNULL((SELECT TOP 1 CASE WHEN LEN(ISNULL(LAST_LOCALE, 'en')) >= 2 THEN SUBSTRING(ISNULL(LAST_LOCALE, 'en'), 0, 2)
                                                                                  ELSE 'en'
                                    END
                               FROM TB_COM_USER WHERE EMAIL = :vo.sender_mail_addr ),'en')
                      ,:vo.encoding
                      ,:vo.password
                  )
            ]]>
            </statement>
        </query>

        <!-- 메일 수신자 내역 등록 -->
        <query id="secfw.singleIF.mail.insertMailRecipient">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_RECIPIENT_ETY_CSVO (
                        MODULE_ID
                      , MIS_ID
                      , ISEQ_ID
                      , REC_TYPE
                      , REC_ADDR
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.iseq_id
                      , :vo.rec_type
                      , :vo.rec_addr
                  )
            ]]>
            </statement>
        </query>

        <!-- 메일 첨부파일 내역 등록 : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원 -->
        <!--
        <query id="secfw.singleIF.mail.insertMailAttach">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_ATTACH_ETY_CSVO (
                        MODULE_ID
                      , MIS_ID
                      , ISEQ_ID
                      , FILE_NAME
                      ,LOCAL_PATH
                  ) VALUES (
                        :vo.module_id
                      , :vo.mis_id
                      , :vo.ifseq_id
                      , :vo.file_name
                      , :vo.local_path
                  )
            ]]>
            </statement>
        </query>
        -->

        <!-- 메일내역 수정 -->
        <query id="secfw.singleIF.mail.modifyMailHeader">
            <statement>
            <![CDATA[
                UPDATE TB_COM_HEADER_HELPER_CSVO
                   SET SUBJECT             = :vo.subject
                     , BODY                = :vo.body
                     , MSG_TYPE            = :vo.msg_type
                     , BHTML_CONTENT_CHECK = :vo.bhtml_content_check
                     , IFILE_COUNT         = :vo.ifile_count
                     , TIME_ZONE           = :vo.time_zone
                     , IS_DST              = :vo.is_dst
                     , SENDER_MAIL_ADDR    = :vo.sender_mail_addr
                     , STATUS              = :vo.status
                     , CREATE_DATE         = :vo.create_date
                 WHERE MODULE_ID = :vo.module_id
                  AND MIS_ID     = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- ######################################################################### -->
        <!-- ##########                  메일정보 삭제                      ########## -->
        <!-- ######################################################################### -->

        <!-- 메일 Header 정보 삭제 -->
        <query id="secfw.singleIF.mail.deleteMailHeader">
            <statement>
            <![CDATA[
                DELETE TB_COM_HEADER_HELPER_CSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- 발신자 정보 삭제 -->
        <query id="secfw.singleIF.mail.deleteMailResource">
            <statement>
            <![CDATA[
                DELETE TB_COM_RESOURCE_CSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- 수신자 정보 삭제 -->
        <query id="secfw.singleIF.mail.deleteMailRecipient">
            <statement>
            <![CDATA[
                DELETE TB_COM_RECIPIENT_ETY_CSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>

        <!-- 첨부파일 정보 삭제 : 첨부파일 변경으로 인하여 사용하지 않음 : 2011.09.21 : 신남원-->
        <!--
        <query id="secfw.singleIF.mail.deleteMailAttach">
            <statement>
            <![CDATA[
                DELETE TB_COM_ATTACH_ETY_CSVO
                 WHERE MODULE_ID = :vo.module_id
                   AND MIS_ID    = :vo.mis_id
            ]]>
            </statement>
        </query>
        -->

        <!-- ######################################################################### -->
        <!-- ##########                  메일 전송결과 처리                 ########## -->
        <!-- ######################################################################### -->

        <!-- 메일 전송결과를 업데이트 한다. -->
        <query id="secfw.singleIF.mail.modifyStatus">
            <statement>
            <![CDATA[
                UPDATE TB_COM_HEADER_HELPER_CSVO
                   SET STATUS    = :status
                #if ($msg_key && !$msg_key.equals(""))
                     , MSG_KEY   = :msg_key
                #end
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 메일 수신현황 정보를 업데이트 한다. -->
        <query id="secfw.singleIF.mail.modifyMailRecipient">
            <statement>
            <![CDATA[
                UPDATE TB_COM_RECIPIENT_ETY_CSVO
                   SET NAME       = :name
                     , POSITION   = :position
                     , DEPARTMENT = :department
                     , COMPANY    = :company
                     , EPID       = :epid
                     , SEND_TIME  = :send_time
                     , DELV_TIME  = :delv_time
                     , SEEN_TIME  = :seen_time
                     , STATUS     = :status
                 WHERE MODULE_ID  = :module_id
                   AND MIS_ID     = :mis_id
                   AND REC_ADDR   = :rec_addr
            ]]>
            </statement>
        </query>

        <!-- 메일 발신취소 -->
        <query id="secfw.singleIF.mail.cancelMail">
            <statement>
            <![CDATA[
                UPDATE TB_COM_RECIPIENT_ETY_CSVO
                   SET STATUS     = :status
                 WHERE MODULE_ID  = :module_id
                   AND MIS_ID     = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 에러순번을 생성한다. -->
        <query id="secfw.singleIF.mail.genErrorSeq" isCamelCase="false">
            <statement>
            <![CDATA[
                SELECT ISNULL(MAX(SEQUENCE),0) + 1 AS SEQ
                  FROM TB_COM_ESB_FAULT_VO
                 WHERE MODULE_ID = :module_id
                   AND MIS_ID    = :mis_id
            ]]>
            </statement>
        </query>

        <!-- 에러메세지를 남긴다. -->
        <query id="secfw.singleIF.mail.insertError">
            <statement>
            <![CDATA[
                INSERT INTO TB_COM_ESB_FAULT_VO (
                        MODULE_ID
                      , MIS_ID
                      , SEQUENCE
                      , FAULT_ACTOR1
                      , FAULT_CODE1
                      , FAULT_STRING1
                      , FAULT_MESSAGE
                      , CREATE_DATE
                  ) VALUES (
                        :module_id
                      , :mis_id
                      , :sequence
                      , :fault_actor1
                      , :fault_code1
                      , :fault_string1
                      , :fault_message
                      , CONVERT(CHAR(8), GETDATE(), 112)+REPLACE(CONVERT(VARCHAR(10),GETDATE(),24),':','') 
                  )
            ]]>
            </statement>
        </query>

    </queries>
</queryservice>