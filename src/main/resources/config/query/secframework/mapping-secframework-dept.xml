<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
	<queries>
	
		<!-- 부서목록조회(Tree) -->
		<query id="secfw.dept.listDeptTree" isCamelCase="false">
			<statement>
			<![CDATA[
			SELECT LVL
                  ,DEPT_CD
		          ,DEPT_NM
		          ,DEPT_NM_ENG
		          ,DEPT_LEVEL
		          ,DEPT_ORDER
		          ,IN_DEPT_CD
		          ,UP_DEPT_NM
		          ,UP_DEPT_CD
		          ,COMP_NM
		          ,COMP_CD
		          ,BUSINESS_CD
		          ,BUSINESS_NM
		          ,DOWN_DEPT_YN
		          ,DEPT_MGR_EMP_NO
		          ,DEPT_MGR_NM
		          ,DEPT_MGR_JIKGUP_NM
		          ,ISLEAF
		          ,DEPT_CD         AS TREE_KEY
                  ,DEPT_NM         AS TREE_TITLE
                  ,DEPT_NM_ENG     AS TREE_TITLE_ENG
                  ,UP_DEPT_CD      AS TREE_UP_KEY
                  ,LVL             AS TREE_LEVEL
                  ,ISLEAF          AS TREE_ISLEAF
                  ,(MAX(LVL) OVER() - (MAX(LVL) OVER() - (LVL - MIN(LVL) OVER()))) AS ARRAY_LOC
                  ,MAX(LVL) OVER() AS TREE_MAX_LEVEL
		     FROM ( SELECT LEVEL AS LVL
                          ,DEPT_CD
				          ,DEPT_NM
				          ,DEPT_NM_ENG
				          ,DEPT_LEVEL
				          ,DEPT_ORDER
				          ,IN_DEPT_CD
				          ,UP_DEPT_NM
				          ,UP_DEPT_CD
				          ,COMP_NM
				          ,COMP_CD
				          ,BUSINESS_CD
				          ,BUSINESS_NM
				          ,DOWN_DEPT_YN
				          ,DEPT_MGR_EMP_NO
				          ,DEPT_MGR_NM
				          ,DEPT_MGR_JIKGUP_NM
				      #if ($vo.dbType && $vo.dbType.equals("DB2"))
				          ,CASE WHEN LEAD(LEVEL) OVER(ORDER BY LEVEL, IN_DEPT_CD) < LEVEL THEN 'Y' ELSE 'N' END  AS ISLEAF
                      #elseif ($vo.dbType && $vo.dbType.equals("ORA"))
				          ,DBO.DECODE3(CONNECT_BY_ISLEAF, '1', 'Y', 'N') AS ISLEAF
                      #else
				          ,DBO.DECODE3(CONNECT_BY_ISLEAF, '1', 'Y', 'N') AS ISLEAF
                      #end
				    FROM (SELECT * 
					    FROM TB_COM_DEPT)
				   START WITH DEPT_CD = :vo.tree_dept_cd
				 CONNECT BY PRIOR DEPT_CD = UP_DEPT_CD
				 ORDER SIBLINGS BY IN_DEPT_CD	
			)
			]]>
			</statement>
		</query>

		<!-- 부서목록조회(Tree) -->
		<query id="secfw.dept.listChildDept" isCamelCase="false">
			<statement>
			<![CDATA[
            SELECT DEPT_CD         AS TREE_KEY
                  ,DEPT_NM         AS TREE_TITLE
                  ,DEPT_NM_ENG     AS TREE_TITLE_ENG
                  ,UP_DEPT_CD      AS TREE_UP_KEY
                  ,LVL             AS TREE_LEVEL
                  ,ISLEAF          AS TREE_ISLEAF
             FROM (SELECT LEVEL AS LVL
                         ,DEPT_CD, DEPT_NM, DEPT_NM_ENG, UP_DEPT_CD, IN_DEPT_CD 
					#if ($vo.dbType && $vo.dbType.equals("DB2"))
                         ,CASE WHEN LEAD(LEVEL) OVER(ORDER BY LEVEL, IN_DEPT_CD) < LEVEL THEN 'Y' ELSE 'N' END  AS ISLEAF
					#elseif ($vo.dbType && $vo.dbType.equals("ORA"))
                         ,DBO.DECODE3(CONNECT_BY_ISLEAF, '1', 'Y', 'N') AS ISLEAF 
                    #else
                         ,DBO.DECODE3(CONNECT_BY_ISLEAF, '1', 'Y', 'N') AS ISLEAF 
                    #end
                     FROM TB_COM_DEPT
                    START WITH DEPT_CD = :vo.tree_dept_cd
				  CONNECT BY PRIOR DEPT_CD = UP_DEPT_CD
                  )
            WHERE UP_DEPT_CD = :vo.tree_dept_cd
            ORDER BY IN_DEPT_CD		
			]]>
			</statement>
		</query>

		<!-- 부서(Temp Table) 데이타삭제 -->
		<query id="secfw.dept.deleteDeptTemp">
			<statement>
			<![CDATA[
			TRUNCATE TABLE TB_COM_DEPT_TEMP
			]]>
			</statement>
		</query>

		<!-- 부서(Temp Table) 데이타입력 -->
		<query id="secfw.dept.insertDeptTemp">
			<statement>
			<![CDATA[
			INSERT INTO TB_COM_DEPT_TEMP 
  			   (DEPT_CD, DEPT_NM, DEPT_NM_ENG, DEPT_LEVEL, DEPT_ORDER,
				IN_DEPT_CD, UP_DEPT_CD, UP_DEPT_NM, UP_DEPT_NM_ENG, COMP_CD,
				COMP_NM, COMP_NM_ENG, BUSINESS_CD, BUSINESS_NM, DOWN_DEPT_YN,
				DEPT_MGR_EMP_NO, DEPT_MGR_NM, DEPT_MGR_JIKGUP_NM, DEPT_MGR_JIKGUP_NM_ENG,
				LOAD_VERSION )
			VALUES (:vo.dept_cd, :vo.dept_nm, :vo.dept_nm_eng, :vo.dept_level, :vo.dept_order,
				:vo.in_dept_cd, :vo.up_dept_cd, :vo.up_dept_nm, :vo.up_dept_nm_eng, :vo.comp_cd,
				:vo.comp_nm, :vo.comp_nm_eng, :vo.business_cd, :vo.business_nm, :vo.down_dept_yn,
				:vo.dept_mgr_emp_no, :vo.dept_mgr_nm, :vo.dept_mgr_jikgup_nm, :vo.dept_mgr_jikgup_nm_eng,
				GETDATE())
			]]>
			</statement>
		</query>
		
		<!-- 부서(Real Table) 데이타삭제 -->
		<query id="secfw.dept.deleteDept">
			<statement>
			<![CDATA[
			TRUNCATE TABLE TB_COM_DEPT
			]]>
			</statement>
		</query>

		<!-- 운영테이블로 데이타 이관 (Temp Table -> Real Table) -->
		<query id="secfw.dept.insertDept">
			<statement>
			<![CDATA[
			INSERT INTO TB_COM_DEPT
  			   (DEPT_CD, DEPT_NM, DEPT_NM_ENG, DEPT_LEVEL, DEPT_ORDER,
				IN_DEPT_CD, UP_DEPT_CD, UP_DEPT_NM, UP_DEPT_NM_ENG, COMP_CD,
				COMP_NM, COMP_NM_ENG, BUSINESS_CD, BUSINESS_NM, DOWN_DEPT_YN,
				DEPT_MGR_EMP_NO, DEPT_MGR_NM, DEPT_MGR_JIKGUP_NM, DEPT_MGR_JIKGUP_NM_ENG,
				LOAD_VERSION )
			SELECT DEPT_CD, DEPT_NM, DEPT_NM_ENG, DEPT_LEVEL, DEPT_ORDER,
				IN_DEPT_CD, UP_DEPT_CD, UP_DEPT_NM, UP_DEPT_NM_ENG, COMP_CD,
				COMP_NM, COMP_NM_ENG, BUSINESS_CD, BUSINESS_NM, DOWN_DEPT_YN,
				DEPT_MGR_EMP_NO, DEPT_MGR_NM, DEPT_MGR_JIKGUP_NM, DEPT_MGR_JIKGUP_NM_ENG,
				LOAD_VERSION
		      FROM TB_COM_DEPT_TEMP
			]]>
			</statement>
		</query>
																			
	</queries>
</queryservice>
