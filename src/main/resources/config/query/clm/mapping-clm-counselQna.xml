<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>
    
    	<!-- QNA 목록 조회 : 2011.09.06 : 정다운 -->
		<query id="clm.counsel.listQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		    SELECT D.* FROM (
		        SELECT RN, ROWNUM AS RN2, C.*, COUNT(1) OVER() TOTAL_CNT
				  FROM (SELECT B.*, B1.RN
				          FROM (
						SELECT TCB.SEQNO
						     , TCB.UP_SEQNO
						     , TCB.POSTUP_SRT
						     , TCB.POSTUP_DEPTH
						     , TCB.BBS_KND
						     , (SELECT CD_NM FROM TB_COM_CD 
						         WHERE SYS_CD = 'CLM' 
						           AND GRP_CD = 'C014' 
						           AND CD     = TCB.BBS_KND 
						           AND USE_YN = 'Y') BBS_KND_NM
						     , TCB.TITLE
						     , TCB.CONT
						     , TCB.RDCNT
						     , TO_CHAR(TCB.REG_DT, 'YYYY-MM-DD') REG_DT
						     , TCB.REG_NM
						     , TCB.REG_DEPT_NM
						     , TCB.REGMAN_JIKGUP_NM
						     , TCB.DEL_YN
						     , TCB.PRGRS_STATUS
						     , (SELECT CD_NM FROM TB_COM_CD 
						         WHERE SYS_CD = 'CLM' 
						           AND GRP_CD = 'C017' 
						           AND CD     = TCB.PRGRS_STATUS 
						           AND USE_YN = 'Y') PRGRS_STATUS_NM
						     , CASE WHEN TCB.REG_DT > SYSDATE-14 THEN 'Y' ELSE 'N' END NEW_YN
						     
						  FROM TN_CLM_BBS TCB, (SELECT USER_ID, BLNGT_ORGNZ FROM TB_COM_USER) TCU
						  					  
						 WHERE TCB.DEL_YN = 'N'
						   AND TCB.REG_ID= TCU.USER_ID
						   
						   --RD01도 리스트에 보이게 함 12/02/02 서유강 대리 요청
						   --#if($vo.top_role.equals("RD01"))
					   	   --	   AND TCU.BLNGT_ORGNZ = :vo.session_blngt_orgnz
						   --#end
						   
						   #if($vo.top_role.equals("RZ00") + $vo.top_role.equals("RD02"))
					   		   AND (TCB.REG_ID = :vo.session_user_id AND UP_SEQNO = 0 OR UP_SEQNO != 0)
						   #end
						   
						   #if($vo.srch_prgrs_status && !$vo.srch_prgrs_status.equals(""))
						       AND TCB.PRGRS_STATUS = :vo.srch_prgrs_status
						   #end
						   
						   #if ($vo.srch_start_dt && !$vo.srch_start_dt.equals(""))
                               /* AND TCB.REG_DT >= TO_DATE(:vo.srch_start_dt) */
                               AND TCB.REG_DT >= CONVERT(DATE, :vo.srch_start_dt, 23)
                           #end
                           #if ($vo.srch_end_dt && !$vo.srch_end_dt.equals(""))
                               /* AND TCB.REG_DT <= TO_DATE(:vo.srch_end_dt) + 1 */
                               AND TCB.REG_DT <= TO_DATE(:vo.srch_end_dt) + 1
                           #end
						 
						 ORDER BY SEQNO DESC
					  ) B, (SELECT SEQNO, COUNT(1) OVER() - ROWNUM+1 AS RN FROM TN_CLM_BBS WHERE UP_SEQNO = 0 ORDER BY SEQNO DESC) B1
					  WHERE B.SEQNO = B1.SEQNO(+)
					  START WITH UP_SEQNO = 0
					  CONNECT BY PRIOR B.SEQNO = UP_SEQNO					   
					  ORDER SIBLINGS BY POSTUP_DEPTH
					  
				  ) C 
				  WHERE 1 = 1
				
				  #if($vo.srch_select_title.equals("title"))
				  	  AND TITLE LIKE '%'+ :vo.srch_title +'%'
				  #elseif($vo.srch_select_title.equals("regNm"))
				 	  AND REG_NM LIKE '%'+ :vo.srch_title +'%'
				  #elseif($vo.srch_select_title.equals("cont"))
					  AND CONT LIKE '%'+ :vo.srch_title +'%'
				  #end
				  
				  ) D
				 WHERE RN2 BETWEEN :vo.start_index AND :vo.end_index
				   
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 게시물 번호 : 2012.04.06 : 김현구 -->
		<query id="clm.counsel.countQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		    	SELECT COUNT(1) OVER() - ROWNUM+1 AS RN
				  FROM TN_CLM_BBS TCB, (SELECT USER_ID, BLNGT_ORGNZ FROM TB_COM_USER) TCU
				 WHERE TCB.DEL_YN = 'N'
					   AND TCB.REG_ID= TCU.USER_ID
					   AND TCB.UP_SEQNO = 0

					   --RD01도 리스트에 보이게 함 12/02/02 서유강 대리 요청
					   --#if($vo.top_role.equals("RD01"))
				   	   --	   AND TCU.BLNGT_ORGNZ = :vo.session_blngt_orgnz
					   --#end
						   
					   #if($vo.top_role.equals("RZ00") + $vo.top_role.equals("RD02"))
				   		   AND TCB.REG_ID = :vo.session_user_id
					   #end
						
					   #if($vo.srch_prgrs_status && !$vo.srch_prgrs_status.equals(""))
					       AND TCB.PRGRS_STATUS = :vo.srch_prgrs_status
					   #end
						   
					   #if ($vo.srch_start_dt && !$vo.srch_start_dt.equals(""))
                           /* AND TCB.REG_DT >= TO_DATE(:vo.srch_start_dt) */
                           AND TCB.REG_DT >= CONVERT(DATE, :vo.srch_start_dt, 23)
                       #end

                       #if ($vo.srch_end_dt && !$vo.srch_end_dt.equals(""))
                        /* AND TCB.REG_DT <= TO_DATE(:vo.srch_end_dt) + 1 */
                           AND TCB.REG_DT <= TO_DATE(:vo.srch_end_dt) + 1
                       #end
                       
                       #if($vo.srch_select_title.equals("title"))
					  	   AND TCB.TITLE LIKE '%'+ :vo.srch_title +'%'
					   #elseif($vo.srch_select_title.equals("regNm"))
					 	   AND TCB.REG_NM LIKE '%'+ :vo.srch_title +'%'
					   #else
						   AND TCB.CONT LIKE '%'+ :vo.srch_title +'%'
					   #end
				
		    ]]>
		  </statement>
		</query>
		
				
		<!-- QNA 상세 목록 조회 : 2011.09.07 : 정다운 -->
		<query id="clm.counsel.detailQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
				SELECT A.SEQNO
				     , A.UP_SEQNO
				     , A.POSTUP_SRT
				     , A.POSTUP_DEPTH
				     , A.BBS_KND
				     , A.TITLE
				     , A.CONT
				     , A.RDCNT
				     , TO_CHAR(A.REG_DT, 'YYYY-MM-DD') REG_DT
				     , A.REG_ID
				     , A.REG_NM
				     , A.REG_DEPT
				     , A.REG_DEPT_NM
				     , A.REGMAN_JIKGUP_NM
				     , A.MOD_DT
				     , A.MOD_ID
				     , A.MOD_NM
				     , A.DEL_YN
				     , A.DEL_DT
				     , A.DEL_ID
				     , A.DEL_NM
				     , A.PRGRS_STATUS
				  FROM TN_CLM_BBS A
				 WHERE A.UP_SEQNO = :vo.up_seqno
				   AND A.SEQNO    = :vo.seqno
				   AND A.DEL_YN   = 'N'
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 상세화면 댓글목록 : 2011.09.15 : 정다운 -->
		<query id="clm.counsel.detailReplyQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		    SELECT *
		      FROM (
				SELECT ROWNUM RN
				     , A.SEQNO
				     , A.UP_SEQNO
				     , A.POSTUP_SRT
				     , A.POSTUP_DEPTH
				     , A.BBS_KND
				     , A.TITLE
				     , TO_CHAR(A.REG_DT, 'YYYY-MM-DD') REG_DT
				     , A.REG_ID
				     , A.REG_NM
				     , A.REG_DEPT
				     , A.REG_DEPT_NM
				     , A.REGMAN_JIKGUP_NM
				     , A.PRGRS_STATUS
				     , (SELECT CD_NM FROM TB_COM_CD 
			             WHERE SYS_CD = 'CLM' 
			               AND GRP_CD = 'C017' 
			               AND CD     = A.PRGRS_STATUS 
			               AND USE_YN = 'Y') PRGRS_STATUS_NM
				  FROM TN_CLM_BBS A
				 WHERE A.DEL_YN   = 'N'
				 
				 #if($vo.postup_depth == 0)
				   AND SEQNO = :vo.seqno 
				    OR UP_SEQNO = :vo.seqno
				 #else
				   AND SEQNO = :vo.up_seqno
				    OR UP_SEQNO = :vo.up_seqno
				 #end
				 
				 ORDER BY POSTUP_DEPTH
				 
				 )
			

		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 상세 목록 조회수 UPDATE : 2011.09.07 : 정다운 -->
		<query id="clm.counsel.modifyRdcntQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
				UPDATE TN_CLM_BBS
				   SET RDCNT = RDCNT + 1
				 WHERE UP_SEQNO = :vo.up_seqno
				   AND SEQNO    = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 수정 : 2011.09.07 : 정다운 -->
		<query id="clm.counsel.modifyQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET TITLE    = :vo.title
		             , CONT     = :vo.cont
		             , MOD_ID   = :vo.mod_id
		             , MOD_NM   = :vo.mod_nm
		             , MOD_DT   = SYSDATE
		             , PUB_YN   = :vo.pub_yn
		         WHERE UP_SEQNO = :vo.up_seqno
		           AND SEQNO    = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 삭제 : 2011.09.07 : 정다운 -->
		<query id="clm.counsel.deleteQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET DEL_ID   = :vo.del_id
		             , DEL_NM   = :vo.del_nm
		             , DEL_DT   = SYSDATE
		             , DEL_YN   = 'Y'
		         WHERE UP_SEQNO = :vo.up_seqno
		           AND SEQNO    = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!--QNA seqNo Max값 구하기 by khg-->
		<query id="clm.counsel.maxSeqNoQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT ISNULL(MAX(SEQNO)+1, 1) AS MAX_SEQNO
		          FROM TN_CLM_BBS
		    ]]>
		  </statement>
		</query>
		
		<!--QNA up_seqNo Max값 구하기 by khg-->
		<query id="clm.counsel.maxUpSeqNoQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT ISNULL(MAX(UP_SEQNO)+1, 0) AS MAX_UP_SEQNO
		          FROM TN_CLM_BBS
		         WHERE SEQNO = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!--QNA 질문 답변 갯수 카운트 by khg-->
		<query id="clm.counsel.countReplyQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT COUNT(1) COUNT_REPLY
		          FROM TN_CLM_BBS
		         WHERE UP_SEQNO = :vo.seqno
		           AND DEL_YN = 'N'
		    ]]>
		  </statement>
		</query>
		
		<!-- POSTUP_DEPTH 값 업데이트 by khg -->
		<query id="clm.counsel.updatePostUpDepthQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET POSTUP_DEPTH = :vo.postup_depth
		         WHERE SEQNO = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- 상태값 업데이트 by khg -->
		<query id="clm.counsel.updatePrgrsStatusQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET PRGRS_STATUS = :vo.prgrs_status
		         WHERE SEQNO = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- 답변 삭제 시 기존 문의내용 상태값 문의로.. by khg -->
		<query id="clm.counsel.updatePrgrsStatusQna2" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET PRGRS_STATUS = :vo.prgrs_status
		         WHERE SEQNO = :vo.up_seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- Q&A 이관 by khg -->
		<query id="clm.counsel.transferQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
		           SET PRGRS_STATUS = 'C01703'
		              ,TRANS_DT = SYSDATE
		              ,TRANS_DEMND_CONT = :vo.trans_demnd_cont
		         WHERE SEQNO = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 저장-->
		<query id="clm.counsel.insertQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        INSERT INTO TN_CLM_BBS ( 
		            SEQNO
		           ,UP_SEQNO
		           ,POSTUP_SRT
				   ,POSTUP_DEPTH
				   ,BBS_KND
				   ,TITLE
				   ,CONT
				   ,RDCNT
				   ,REG_DT
				   ,REG_ID
				   ,REG_NM
				   ,REG_DEPT
				   ,REG_DEPT_NM
				   ,REGMAN_JIKGUP_NM
				   ,DEL_YN
				   ,PRGRS_STATUS
				   ,PUB_YN
				 ) VALUES
				 ( :vo.seqno
				  ,:vo.up_seqno
				  ,:vo.postup_srt
			 	  ,:vo.postup_depth
			 	  ,:vo.bbs_knd
			 	  ,:vo.title
				  ,:vo.cont
				  ,:vo.rdcnt
				  ,SYSDATE
				  ,:vo.reg_id
				  ,:vo.reg_nm
				  ,:vo.reg_dept
			 	  ,:vo.reg_dept_nm
			 	  ,:vo.regman_jikgup_nm
			 	  ,'N'
			 	  ,:vo.prgrs_status
				  ,'N')
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 권한체크-->
		<query id="clm.counsel.authQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT TCB.REG_ID
		        	 , TCB.PRGRS_STATUS
		             , TCU.BLNGT_ORGNZ
				  FROM TN_CLM_BBS TCB, TB_COM_USER TCU
				 WHERE TCB.REG_ID = TCU.USER_ID
				   AND TCB.UP_SEQNO = :vo.up_seqno
				   AND TCB.SEQNO    = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 게시순서 update 할 MAX값 구하기 : 2011.09.14 : 정다운 -->
		<query id="clm.counsel.modifyReplyMaxPostupSrtQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT MAX(POSTUP_SRT) MAX_POSTUP_SRT
				  FROM TN_CLM_BBS
				 WHERE UP_SEQNO = :vo.up_seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 게시순서 update : 2011.09.14 : 정다운 -->
		<query id="clm.counsel.modifyReplyPostupSrtQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
				   SET POSTUP_SRT = ISNULL(:vo.max_postup_srt, 0)+1
				 WHERE UP_SEQNO   = :vo.up_seqno
				   AND SEQNO      = :vo.seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 게시순서  MAX값 구하기: 2011.09.14 : 정다운 -->
		<query id="clm.counsel.modifyReplyMaxPostupSrt2Qna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT MAX(POSTUP_SRT) MAX_POSTUP_SRT
		          FROM TN_CLM_BBS
				 WHERE UP_SEQNO   = :vo.up_seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 게시단계 update 할 MAX값 구하기 : 2011.09.14 : 정다운 -->
		<query id="clm.counsel.modifyReplyMaxPostupDepthQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT MAX(POSTUP_DEPTH) MAX_POSTUP_DEPTH
				  FROM TN_CLM_BBS
				 WHERE UP_SEQNO   = :vo.up_seqno
				   AND POSTUP_SRT = :vo.max_postup_srt
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 게시단계 update : 2011.09.14 : 정다운 -->
		<query id="clm.counsel.modifyReplyPostupDepthQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
				   SET POSTUP_DEPTH = ISNULL(:vo.max_postup_depth, 0)+1
				 WHERE UP_SEQNO     = :vo.up_seqno
				   AND SEQNO        = :vo.seqno
				   AND POSTUP_SRT   = :vo.max_postup_srt
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 댓글등록 후 진행상태 update : 2011.09.16 : 정다운 -->
		<query id="clm.counsel.modifyPrgrsStatusQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        UPDATE TN_CLM_BBS
				   SET PRGRS_STATUS = :vo.prgrs_status
				 WHERE UP_SEQNO     = :vo.up_seqno
		    ]]>
		  </statement>
		</query>
		
		<!-- QNA 사용자권한 조회 : 2011.10.10 : dawn -->
		<query id="clm.admin.roleCdQna" isCamelCase="false">
		  <statement>
		    <![CDATA[
		        SELECT A.USER_ID
				     , B.ROLE_CD
				  FROM TB_COM_USER A
				     , TB_COM_ROLE_USER B
				 WHERE A.USER_ID = B.USER_ID
				   AND B.SYS_CD  = :vo.sys_cd
				   AND A.USER_ID = :vo.session_user_id
				 ORDER BY B.ROLE_CD
		    ]]>
		  </statement>
		</query>
		
    </queries>
</queryservice>