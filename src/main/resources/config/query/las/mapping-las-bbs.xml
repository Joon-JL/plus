<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE queryservice PUBLIC "-//ANYFRAME//DTD QUERYSERVICE//EN"
"http://www.anyframejava.org/dtd/anyframe-core-query-mapping-3.1.dtd">

<queryservice>
    <queries>
<!-- 리스트 검색 -->
	<query id="las.board.bbs.listBbs" isCamelCase="false">
		<statement>
    	<![CDATA[
    	     SELECT *
              FROM ( SELECT ROW_NUMBER() OVER (ORDER BY GRP_NO DESC , POSTUP_SRT ASC) RN, 
              		t.*, CAST(COUNT(1) over() AS NUMERIC) TOTAL_CNT
                     FROM (
   							SELECT 
										 GRP_NO
								        ,GRP_SEQNO
								        ,POSTUP_SRT
								        ,POSTUP_DEPTH
								        ,BBS_KND
								        ,CASE WHEN REG_DT > GETDATE()-14 THEN 'Y' ELSE '' END NEW_YN
								        ,TITLE
								        ,CONT
								        ,RDCNT
								        ,TOTAL_SEQNO
								        ,CONVERT(CHAR(10), REG_DT, 23) AS REG_DT /*YYYY-MM-DD*/
								        ,REG_ID
								        ,REG_NM
								        ,REG_DEPT
								        ,REG_DEPT_NM
								        ,CONVERT(CHAR(10), MOD_DT, 23) AS MOD_DT /*YYYY-MM-DD*/
								        ,MOD_ID
								        ,MOD_NM
								        ,DEL_YN
								        ,CONVERT(CHAR(10), DEL_DT, 23) AS DEL_DT /*YYYY-MM-DD*/
								        ,DEL_ID
								        ,DEL_NM
								    FROM TN_LAS_BBS 
								   WHERE DEL_YN = 'N'
								   	 AND BBS_KND = :vo.bbs_knd 
								   	 #if(!$vo.session_auth_comp_cd.equals(""))
								   	 	#if($vo.bbs_knd.equals("C01217") && ($vo.session_user_id.equals("M081216010319D800902") + $vo.session_user_id.equals("M110218062915C604757") + $vo.session_user_id.equals("D120924171919C609299")))
										--$vo.session_user_id
										--AND COMP_CD IN ($vo.session_auth_comp_cd)
										#else
											#if(!($vo.bbs_knd.equals("C01214") || $vo.bbs_knd.equals("C01215")) )
											AND COMP_CD IN ($vo.session_auth_comp_cd)
											#end
										#end
									#end
			                         #if (!$vo.srch_start_dt.equals(""))
										AND REG_DT >= CONVERT(DATETIME, REPLACE( :vo.srch_start_dt ,'-',''), 112) /*YYYY-MM-DD*/
									 #end
			                         #if (!$vo.srch_end_dt.equals(""))
										AND REG_DT <= CONVERT(DATETIME, REPLACE( :vo.srch_end_dt ,'-',''), 112)+1 /*YYYY-MM-DD*/
			                         #end 
								 	 #if (!$vo.srch_word.equals(""))
				                         #if ($vo.srch_type.equals("title"))
				                            AND TITLE LIKE '%' + :vo.srch_word + '%'
				                         #end
				                         #if ($vo.srch_type.equals("reg_nm"))
				                            AND REG_NM LIKE '%' + :vo.srch_word + '%'
				                         #end
				                         #if ($vo.srch_type.equals("cont"))
				                            AND CONT LIKE '%' + :vo.srch_word + '%'
				                         #end
			                     	#end 
                         ) t
            		)TA
            WHERE RN between :vo.start_index and :vo.end_index
            ORDER BY GRP_NO DESC, GRP_SEQNO	/* Sungwoo Replaced sort option */
    ]]>
		</statement>
	</query>
	
	<query id="las.board.bbs.listPds" isCamelCase="false">
		<statement>
    	<![CDATA[
    	     SELECT *
              FROM ( SELECT ROW_NUMBER() OVER (ORDER BY GRP_NO DESC , POSTUP_SRT ASC) RN, 
              		t.*, CAST(COUNT(1) over() AS NUMERIC) TOTAL_CNT
                     FROM (
   							SELECT 
									GRP_NO
								        ,GRP_SEQNO
								        ,POSTUP_SRT
								        ,POSTUP_DEPTH
								        ,BBS_KND
								        ,TITLE
								        ,CONT
								        ,RDCNT
								        ,TOTAL_SEQNO
								        ,CONVERT(CHAR(10), REG_DT, 23) AS REG_DT /*YYYY-MM-DD*/
								        ,REG_ID
								        ,REG_NM
								        ,REG_DEPT
								        ,REG_DEPT_NM
								        ,CONVERT(CHAR(10), MOD_DT, 23) AS MOD_DT /*YYYY-MM-DD*/
								        ,MOD_ID
								        ,MOD_NM
								        ,DEL_YN
								        ,CONVERT(CHAR(10), DEL_DT, 23) AS DEL_DT /*YYYY-MM-DD*/
								        ,DEL_ID
								        ,DEL_NM
								        ,CASE WHEN BBS_KND IN ('C01204','C01206','C01208','C01210','C01212') THEN 'Y'
								              ELSE 'N' END DMSTFRGN_GBN
								        ,JIKGUP_NM AS REG_JIKGUP_NM
								    FROM TN_LAS_BBS A, (SELECT USER_ID, JIKGUP_NM FROM TB_COM_USER) B
								   WHERE DEL_YN = 'N'
								     AND A.REG_ID = B.USER_ID
								     #if(!$vo.session_auth_comp_cd.equals(""))
										AND A.COMP_CD IN ($vo.session_auth_comp_cd)
									#end
								   	 #if (!$vo.isPds.equals("Y"))
								   	 	AND BBS_KND = :vo.bbs_knd
								   	 #else
								   	    #if ($vo.bbs_knd.equals("C01204") + $vo.bbs_knd.equals("C01205"))
								   	    	#if ($vo.srch_dmstfrgn_gbn.equals("dmst"))
								   	    	   AND BBS_KND = 'C01204'
								   	    	#elseif ($vo.srch_dmstfrgn_gbn.equals("frgn"))
								   	    	   AND BBS_KND = 'C01205'
								   	    	#else
								   	    	   AND BBS_KND IN ('C01204', 'C01205')
								   	    	#end
								   	    #elseif ($vo.bbs_knd.equals("C01206") + $vo.bbs_knd.equals("C01207"))
								   	    	#if ($vo.srch_dmstfrgn_gbn.equals("dmst"))
								   	    	   AND BBS_KND = 'C01206'
								   	    	#elseif ($vo.srch_dmstfrgn_gbn.equals("frgn"))
								   	    	   AND BBS_KND = 'C01207'
								   	    	#else
								   	    	   AND BBS_KND IN ('C01206', 'C01207')
								   	    	#end
								   	    #elseif ($vo.bbs_knd.equals("C01208") + $vo.bbs_knd.equals("C01209"))
								   	    	#if ($vo.srch_dmstfrgn_gbn.equals("dmst"))
								   	    	   AND BBS_KND = 'C01208'
								   	    	#elseif ($vo.srch_dmstfrgn_gbn.equals("frgn"))
								   	    	   AND BBS_KND = 'C01209'
								   	    	#else
								   	    	   AND BBS_KND IN ('C01208', 'C01209')
								   	    	#end
								   	    #elseif ($vo.bbs_knd.equals("C01210") + $vo.bbs_knd.equals("C01211"))
								   	    	#if ($vo.srch_dmstfrgn_gbn.equals("dmst"))
								   	    	   AND BBS_KND = 'C01210'
								   	    	#elseif ($vo.srch_dmstfrgn_gbn.equals("frgn"))
								   	    	   AND BBS_KND = 'C01211'
								   	    	#else
								   	    	   AND BBS_KND IN ('C01210', 'C01211')
								   	    	#end
								   	    #elseif ($vo.bbs_knd.equals("C01212") + $vo.bbs_knd.equals("C01213"))
								   	    	#if ($vo.srch_dmstfrgn_gbn.equals("dmst"))
								   	    	   AND BBS_KND = 'C01212'
								   	    	#elseif ($vo.srch_dmstfrgn_gbn.equals("frgn"))
								   	    	   AND BBS_KND = 'C01213'
								   	    	#else
								   	    	   AND BBS_KND IN ('C01212', 'C01213')
								   	    	#end
								   	    #end
								   	 #end
								   	  
			                       
			                         #if (!$vo.srch_start_dt.equals(""))
										AND REG_DT >= CONVERT(DATETIME, REPLACE( :vo.srch_start_dt ,'-',''), 112) /*YYYY-MM-DD*/
			                         #end
			                         #if (!$vo.srch_end_dt.equals(""))
										AND REG_DT <= CONVERT(DATETIME, REPLACE( :vo.srch_end_dt ,'-',''), 112)+1 /*YYYY-MM-DD*/
			                         #end 
								 	 #if (!$vo.srch_word.equals(""))
				                         #if ($vo.srch_type.equals("title"))
				                            AND TITLE LIKE '%' + :vo.srch_word + '%'
				                         #end
				                         #if ($vo.srch_type.equals("reg_nm"))
				                            AND REG_NM LIKE '%' + :vo.srch_word + '%'
				                         #end
				                         #if ($vo.srch_type.equals("cont"))
				                            AND CONT LIKE '%' + :vo.srch_word + '%'
				                         #end
			                     	#end 
                         ) t
            		) TA
            WHERE RN between :vo.start_index and :vo.end_index
            ORDER BY RN 
    ]]>
		</statement>
	</query>
	
<!-- 상세 조회 -->
        <query id="las.board.bbs.detailBbs" isCamelCase="false">
            <statement>
            <![CDATA[
				SELECT  GRP_NO
						,GRP_SEQNO
						,POSTUP_SRT
						,POSTUP_DEPTH
						,BBS_KND						
						,TITLE
						,CONT
						,RDCNT
						,TOTAL_SEQNO
						,CONVERT(CHAR(10), A.REG_DT, 23) AS REG_DT /*YYYY-MM-DD*/
						,REG_ID
						,REG_NM
						,JIKGUP_NM
				  		,DEPT_NM
						,REG_DEPT
						,REG_DEPT_NM
						,CONVERT(CHAR(10), MOD_DT, 23) AS MOD_DT /*YYYY-MM-DD*/
						,MOD_ID
						,MOD_NM
						,DEL_YN
						,CONVERT(CHAR(10), DEL_DT, 23) AS DEL_DT /*YYYY-MM-DD*/
						,DEL_ID
						,DEL_NM
				  FROM  TN_LAS_BBS A LEFT OUTER JOIN
				  		TB_COM_USER B
				  ON A.REG_ID = B.USER_ID		
				 WHERE  DEL_YN = 'N' 
				   AND  GRP_NO = :vo.grp_no
				   AND  GRP_SEQNO = :vo.grp_seqno
				   
		     #if(!$vo.session_auth_comp_cd.equals(""))
		   	 	#if($vo.bbs_knd.equals("C01217") && ($vo.session_user_id.equals("M081216010319D800902") + $vo.session_user_id.equals("M110218062915C604757") + $vo.session_user_id.equals("D120924171919C609299")))
				--$vo.session_user_id
				--AND A.COMP_CD IN ($vo.session_auth_comp_cd)
				#else
					#if(!($vo.bbs_knd.equals("C01214") || $vo.bbs_knd.equals("C01215")) )
					AND A.COMP_CD IN ($vo.session_auth_comp_cd)
					#end
				#end										
			#end					
            ]]>
            </statement>
        </query>

        
<!-- 조회수 증가 -->
        <query id="las.board.bbs.increseRdcnt">
            <statement>
            <![CDATA[
                UPDATE  TN_LAS_BBS
                   SET  RDCNT = RDCNT + 1
                WHERE  GRP_NO = :vo.grp_no
                   AND  GRP_SEQNO = :vo.grp_seqno
            ]]>
            </statement>
        </query>
        
<!-- 상세하단리스트 -->
<query id="las.board.bbs.detailList" isCamelCase="false">
	<statement>
    <![CDATA[
		SELECT ROW_NUMBER() OVER (ORDER  BY GRP_NO DESC, POSTUP_SRT ASC ) RN
				,GRP_NO
				,GRP_SEQNO
				,CASE WHEN REG_DT > GETDATE()-14 THEN 'Y' ELSE '' END NEW_YN
				,POSTUP_SRT
				,POSTUP_DEPTH
				,BBS_KND
				,TITLE
				,CONT
				,RDCNT
				,TOTAL_SEQNO
				,CONVERT(CHAR(10), REG_DT, 23) AS REG_DT /*YYYY-MM-DD*/
				,REG_ID
				,REG_NM
				,REG_DEPT
				,REG_DEPT_NM
				,CONVERT(CHAR(10), MOD_DT, 23) AS MOD_DT /*YYYY-MM-DD*/
				,MOD_ID
				,MOD_NM
				,DEL_YN
				,CONVERT(CHAR(10), DEL_DT, 23) AS DEL_DT /*YYYY-MM-DD*/
				,DEL_ID
				,DEL_NM
		FROM TN_LAS_BBS 
		WHERE  DEL_YN = 'N'
		 AND GRP_NO = :vo.grp_no 
		 #if(!$vo.session_auth_comp_cd.equals(""))
			AND COMP_CD IN ($vo.session_auth_comp_cd)
		#end
		ORDER BY RN
    ]]>
		</statement>
	</query>

	
<!-- 등록 -->
	<query id="las.board.bbs.insertBbs" isCamelCase="false">
		<statement>
    <![CDATA[
    INSERT INTO TN_LAS_BBS ( GRP_NO
			               , GRP_SEQNO
			               , COMP_CD
			               , POSTUP_SRT
			               , POSTUP_DEPTH
			               , BBS_KND
			               , TITLE
			               , CONT
			               , RDCNT
			               , TOTAL_SEQNO
			               , REG_DT
			               , REG_ID
			               , REG_NM
			               , REG_DEPT
			               , REG_DEPT_NM
			               , MOD_DT
			               , MOD_ID
			               , MOD_NM
			               , DEL_YN
			               , DEL_DT
			               , DEL_ID
			               , DEL_NM
        ) VALUES (
          :vo.grp_no
          ,0
          ,#if(!$vo.session_auth_comp_cd.equals(""))
				($vo.session_auth_comp_cd)
			#else
				''
			#end
          ,0
          ,0
          ,:vo.bbs_knd
          ,:vo.title
          ,:vo.cont
          ,0
          ,:vo.total_seqno
          ,GETDATE()
          ,:vo.reg_id
          ,:vo.reg_nm
          ,:vo.reg_dept
          ,:vo.reg_dept_nm
          ,''
          ,''
          ,''
          ,'N'
          ,''
          ,''
          ,''
        )
    ]]>
		</statement>
	</query>

<!-- 답변 등록 -->	
	<query id="las.board.bbs.replyBbs" isCamelCase="false">
		<statement>
    <![CDATA[
    INSERT INTO TN_LAS_BBS ( GRP_NO
			               , GRP_SEQNO
			               , COMP_CD
			               , POSTUP_SRT
			               , POSTUP_DEPTH
			               , BBS_KND
			               , TITLE
			               , CONT
			               , RDCNT
			               , TOTAL_SEQNO
			               , REG_DT
			               , REG_ID
			               , REG_NM
			               , REG_DEPT
			               , REG_DEPT_NM
			               , MOD_DT
			               , MOD_ID
			               , MOD_NM
			               , DEL_YN
			               , DEL_DT
			               , DEL_ID
			               , DEL_NM
        ) VALUES (
				          :vo.grp_no 
				          ,:vo.grp_seqno
				          ,#if(!$vo.session_auth_comp_cd.equals(""))
								($vo.session_auth_comp_cd)
							#else
							''
							#end
						  ,:vo.postup_srt + 1
				          ,:vo.postup_depth + 1
          				  ,:vo.bbs_knd
          				  ,:vo.title
          				  ,:vo.cont
				          ,0
				          ,:vo.total_seqno
				          ,GETDATE()
				          ,:vo.reg_id
				          ,:vo.reg_nm
				          ,:vo.reg_dept
				          ,:vo.reg_dept_nm
				          ,''
				          ,''
				          ,''
				          ,'N'
				          ,''
				          ,''
				          ,''
        )
    ]]>
		</statement>
	</query>
<!-- 답변pos를 업데이트 -->
	<query id="las.board.bbs.updatePos">
		<statement>
            <![CDATA[
                UPDATE  TN_LAS_BBS 
                   SET  POSTUP_SRT = POSTUP_SRT + 1 
                 WHERE  GRP_NO = :vo.grp_no
                   AND  POSTUP_SRT > :vo.postup_srt 
            ]]>
		</statement>
	</query>
<!-- 답변pos를 업데이트 -->
	<query id="las.board.bbs.updatePosDel">
		<statement>
            <![CDATA[
                UPDATE  TN_LAS_BBS 
                   SET  POSTUP_SRT = POSTUP_SRT - 1 
                 WHERE  GRP_NO = :vo.grp_no
                   AND  POSTUP_SRT > :vo.postup_srt 
            ]]>
		</statement>
	</query>	

<!-- 수정 -->
	<query id="las.board.bbs.modifyBbs" isCamelCase="false">
		<statement>
    <![CDATA[
         UPDATE TN_LAS_BBS
          SET GRP_NO = :vo.grp_no
              , GRP_SEQNO = :vo.grp_seqno
              , POSTUP_SRT = :vo.postup_srt
              , POSTUP_DEPTH = :vo.postup_depth
              , BBS_KND = :vo.bbs_knd
              , TITLE = :vo.title
              , CONT = :vo.cont
              , MOD_DT = GETDATE() 
              , MOD_ID = :vo.mod_id 
              , MOD_NM = :vo.mod_nm
          WHERE  GRP_NO = :vo.grp_no
                 AND  GRP_SEQNO = :vo.grp_seqno
                #if(!$vo.session_auth_comp_cd.equals(""))
					AND COMP_CD IN ($vo.session_auth_comp_cd)
				#end
    ]]>
		</statement>
	</query>
<!-- DEL_YN을 업데이트 -->
	<query id="las.board.bbs.deleteBbs">
		<statement>
            <![CDATA[
                UPDATE  TN_LAS_BBS
                   SET  DEL_YN = 'Y' 
                       ,DEL_DT = GETDATE()
                       ,DEL_ID = :vo.del_id
                       ,DEL_NM = :vo.del_nm
                 WHERE  GRP_NO = :vo.grp_no
                   AND  GRP_SEQNO = :vo.grp_seqno
                   #if(!$vo.session_auth_comp_cd.equals(""))
						AND COMP_CD IN ($vo.session_auth_comp_cd)
					#end
            ]]>
		</statement>
	</query>
<!-- MAX GRP_NO을 조회 -->
	<query id="las.board.bbs.getNextGrpno">
		<statement>
            <![CDATA[
				SELECT	ISNULL(MAX(GRP_NO)+1,1) NEXT_GRP_NO
				  FROM	TN_LAS_BBS
            ]]>
		</statement>
	</query>
<!-- MAX GRP_SEQNO을 조회 -->
	<query id="las.board.bbs.getNextGrpseqno">
		<statement>
            <![CDATA[
				SELECT	ISNULL(MAX(GRP_SEQNO)+1,1) NEXT_GRP_SEQNO
				  FROM	TN_LAS_BBS
				 WHERE  GRP_NO = :vo.grp_no
            ]]>
		</statement>
	</query>
<!-- MAX TOTAL_SEQNO을 조회 -->
	<query id="las.board.bbs.getNextTotalSeqno">
		<statement>
            <![CDATA[
				SELECT	ISNULL(MAX(TOTAL_SEQNO)+1,1) NEXT_TOTAL_SEQNO
				  FROM	TN_LAS_BBS
            ]]>
		</statement>
	</query>

	<!-- 표준 조항 권한 체크 정보  -->
	<query id="las.board.authBbs" isCamelCase="false">
	  	<statement>
		    <![CDATA[
				SELECT	GRP_NO, GRP_SEQNO, POSTUP_SRT, POSTUP_DEPTH, BBS_KND, TITLE, CONT, RDCNT, TOTAL_SEQNO
					  , REPLACE(CONVERT(CHAR(10), REG_DT, 23),'-','') AS REG_DT /*YYYYMMDD*/
					  , REG_ID, REG_NM
				FROM 	TN_LAS_BBS
				WHERE	GRP_NO = :vo.grp_no
				  AND   GRP_SEQNO = :vo.grp_seqno
		    ]]>
	  	</statement>
	</query>
	
	<!-- 삭제 가능 여부 체크 -->	
	<query id="las.board.bbs.delCheck" isCamelCase="false">
		<statement>
    	<![CDATA[
    		SELECT COUNT(*) CNT FROM TN_LAS_BBS
    		WHERE 
    		GRP_NO = :vo.grp_no
    		AND POSTUP_SRT = :vo.postup_srt
    		AND POSTUP_DEPTH > :vo.postup_depth 
    		AND DEL_YN = 'N' 
    		AND BBS_KND = :vo.bbs_knd
			#if(!$vo.session_auth_comp_cd.equals(""))
				AND COMP_CD IN ($vo.session_auth_comp_cd)
			#end
     	]]>
	  	</statement>
	</query>
</queries>
</queryservice>