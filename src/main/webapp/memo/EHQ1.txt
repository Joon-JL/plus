
DECLARE @FromDate DATE = '2025-09-01';
DECLARE @ToDate DATE = '2026-01-01';

--- NEW query by Joon
-- layout 1

SELECT

	  SUBSTRING(CAST(CONVERT(VARCHAR,m.REG_DT, 23) AS VARCHAR),1,4) AS "Registration Year",
	  MONTH(m.REG_DT) AS "Registration Month",
	  CONVERT(VARCHAR,m.REG_DT, 23) AS "Registration Date",

	  CASE WHEN M.COMP_CD in ( 'SEP', 'SESA' )		THEN 'SEIB'
	       WHEN M.COMP_CD in ( 'SEH-P', 'SEH-S' )	THEN 'SEH'
	       WHEN M.COMP_CD in ( 'SESG', 'SEAG' )		THEN 'SEAS'
	       WHEN M.COMP_CD in ( 'SRUK' )				THEN 'EHQ'
	  ELSE M.COMP_CD
	  END AS "NERP Subsidiary"

	, m.COMP_CD AS "SELMS+ Subsidiary"
	, m.cntrt_no AS "Contract ID"
	, req.REQ_TITLE AS "Request Title"
	, m.CNTRT_NM AS "Contract Name"
	, req.REQ_DEPT_NM AS "Requesting dept."
	, CASE WHEN CHARINDEX('ESBO', UPPER(req.REQ_DEPT_NM)) > 0 THEN 'TRUE' ELSE 'FALSE' END AS "ESBO dept."
	, req.REQMAN_NM AS "Requester (In Charge)"
	, U.EMAIL "Email"
	--, req.REQMAN_ID
	, req.REQ_DT AS "Request Date"
	, (SELECT cd_nm_eng FROM TN_COM_CONTRACTTYPE_CD WHERE TYPE_CD = m.CNCLSNPURPS_BIGCLSFCN) AS "Area of contract"
	,
       ISNULL((SELECT cd_nm_eng FROM tn_com_contracttype_cd WHERE type_cd = m.biz_clsfcn), '') + ' / ' +
       ISNULL((SELECT cd_nm_eng FROM tn_com_contracttype_cd WHERE type_cd = m.depth_clsfcn), '') + ' / ' +
       ISNULL((SELECT cd_nm_eng FROM tn_com_contracttype_cd WHERE type_cd = m.cnclsnpurps_bigclsfcn), '') + ' / ' +
       ISNULL((SELECT cd_nm_eng FROM tn_com_contracttype_cd WHERE type_cd = m.cnclsnpurps_midclsfcn), '') + ' / ' +
       ISNULL((SELECT cd_nm_eng FROM tn_com_contracttype_cd WHERE type_cd = m.cnclsnpurps_midclsfcn_etc), '') AS "Contract Type"

	, (SELECT cd_nm_eng FROM TN_COM_CONTRACTTYPE_CD WHERE TYPE_CD = m.CNTRT_TRGT) AS "Contract matter"
	, TRY_CONVERT(DATE,m.CNTRTPERIOD_STARTDAY,23) AS "Contract start date"
	, TRY_CONVERT(DATE,m.CNTRTPERIOD_ENDDAY,23) AS "Contract end date"
	, m.CNTRT_AMT AS "Contract amount"
	, m.CRRNCY_UNIT as "Currency Uinit"

	, TRY_CONVERT(DATE,m.CNTRT_CNCLSNDAY, 23) as "Conclusion Date"

	, cd1.CD_NM_ENG AS "Step"
	, cd2.CD_NM_ENG AS "Status"

	, m.CNTRT_OPPNT_NM as "Counterparty"
,CNTRT_OPPNT_CD as 'Counterparty Code'
, CASE WHEN m.cnclsnpurps_midclsfcn_etc = 'Y' THEN 'Yes'
		   WHEN m.cnclsnpurps_midclsfcn_etc = 'N' THEN 'No'

			ELSE 'Not selected yet'
	  END AS "DP Agreement"
	 --, CC.TRGTMAN_ID
	 --, CC.EMAIL
	 ,ISNULL((
	 	SELECT --STRING_AGG(CAST(TRGTMAN_NM AS varchar(50) ), ',')
		  --TRGTMAN_ID,
		  STRING_AGG(CONCAT(TRGTMAN_NM, ' ( ', U.EMAIL, ' )'), ', ')
		  --U.EMAIL
		FROM TN_CLM_CONTRACT_AUTHREQ INNER JOIN TB_COM_USER U ON TRGTMAN_ID = U.USER_ID
		WHERE CNTRT_ID = M.CNTRT_ID
	), '') AS 'CCed'

FROM

( SELECT M.CNTRT_ID, MAX(CNSDREQ_ID) CNSDREQ_ID
	FROM TN_CLM_CONTRACT_MASTER M INNER JOIN TN_CLM_CONTRACT_CNSD RES ON M.CNTRT_ID = RES.CNTRT_ID
	WHERE 1=1
	--AND M.CNTRT_NO LIKE 'EHQ25%'
	--AND M.COMP_CD = 'EHQ'
	AND M.REG_DT >= @FromDate AND M.REG_DT < @ToDate
	GROUP BY M.CNTRT_ID
) AS L
	INNER JOIN TN_CLM_CONT_CNSDREQ REQ ON L.CNSDREQ_ID = REQ.CNSDREQ_ID
	INNER JOIN TN_CLM_CONTRACT_CNSD RES ON REQ.CNSDREQ_ID = RES.CNSDREQ_ID AND L.CNTRT_ID = RES.CNTRT_ID
	INNER JOIN TN_CLM_CONTRACT_MASTER M ON L.CNTRT_ID = M.CNTRT_ID
	LEFT JOIN TB_COM_CD cd1        ON cd1.CD = m.PRCS_DEPTH
	LEFT JOIN TB_COM_CD cd2        ON cd2.CD = m.DEPTH_STATUS
	LEFT JOIN TB_COM_USER U ON M.REG_ID = U.USER_ID

	WHERE M.DEL_YN <> 'Y' AND M.CNTRT_NO IS NOT NULL AND M.CNTRT_NO <> ''

ORDER BY 4,5, 1,2,3--,4,5
;


