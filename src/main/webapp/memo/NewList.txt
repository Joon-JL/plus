
DECLARE @FromDate DATE = '2025-09-01';
DECLARE @ToDate DATE = '2026-01-01';
DECLARE @COMP_CD VARCHAR(10) = 'SESK';


SELECT --M.CNTRT_NO, REQ.REG_NM, RES.CNSDMAN_NM

M.COMP_CD AS "Company Code",
M.CNTRT_NO AS "Contract ID",
M.CNTRTPERIOD_STARTDAY AS "Contract Start Date",
M.CNTRTPERIOD_ENDDAY  AS "Contract End Date",
--M.PRCS_DEPTH, M.DEPTH_CLSFCN, M.DEPTH_CLSFCN,
--M.PRCS_DEPTH, M.DEPTH_CLSFCN, M.DEPTH_CLSFCN,
CASE M.PRCS_DEPTH
	WHEN 'C02501' THEN 'REVIEW'
	WHEN 'C02502' THEN 'APPROVAL'
	WHEN 'C02503' THEN 'REGISTRATION'
	WHEN 'C02504' THEN 'EXECUTION'
	WHEN 'C02505' THEN 'TERMINATION'
	WHEN 'C02506' THEN 'SELMS'
END AS "Contract Status",
--M.REG_NM,
REQ.REQMAN_NM AS "Requester (In Charge)"
,REQ.REQ_DEPT_NM AS "Requesting dept."
, REQ.REQ_TITLE AS "Request Title"
, m.CNTRT_NM AS "Contract Name"
, REQ.REQ_DT AS "Request Date"
,CNTRT_OPPNT_CD as 'Counterparty Code'
, CASE WHEN m.cnclsnpurps_midclsfcn_etc = 'Y' THEN 'Yes'
		   WHEN m.cnclsnpurps_midclsfcn_etc = 'N' THEN 'No'

			ELSE 'Not selected yet'
	  END AS "DP Agreement"
	 --, CC.TRGTMAN_ID
	 --, CC.EMAIL
	 ,ISNULL((
	 	SELECT --STRING_AGG(CAST(TRGTMAN_NM AS varchar(50) ), ',')
		  --TRGTMAN_ID,
		  STRING_AGG(CONCAT(TRGTMAN_NM, ' ( ', U.EMAIL, ' )'), ', ')
		  --U.EMAIL
		FROM TN_CLM_CONTRACT_AUTHREQ INNER JOIN TB_COM_USER U ON TRGTMAN_ID = U.USER_ID
		WHERE CNTRT_ID = M.CNTRT_ID
	), '') AS 'CCed'
--    ,auth.TRGTMAN_NM as 'CCed Person Name'
--    ,user_auth.EMAIL AS 'CCed Person Email'
FROM
( SELECT M.CNTRT_ID, MAX(CNSDREQ_ID) CNSDREQ_ID
	FROM TN_CLM_CONTRACT_MASTER M INNER JOIN TN_CLM_CONTRACT_CNSD RES ON M.CNTRT_ID = RES.CNTRT_ID
	WHERE 1=1
	--AND M.CNTRT_NO LIKE 'EHQ25%'
	--AND M.COMP_CD = 'EHQ'
	AND M.REG_DT >= @FromDate AND M.REG_DT < @ToDate
	GROUP BY M.CNTRT_ID
) AS L
	INNER JOIN TN_CLM_CONT_CNSDREQ REQ ON L.CNSDREQ_ID = REQ.CNSDREQ_ID
	INNER JOIN TN_CLM_CONTRACT_CNSD RES ON REQ.CNSDREQ_ID = RES.CNSDREQ_ID AND L.CNTRT_ID = RES.CNTRT_ID
	INNER JOIN TN_CLM_CONTRACT_MASTER M ON L.CNTRT_ID = M.CNTRT_ID
	WHERE M.DEL_YN <> 'Y' AND M.CNTRT_NO IS NOT NULL AND M.CNTRT_NO <> ''
--, TN_COM_CONTRACTTYPE_CD T
ORDER BY 1



/*
OUTER APPLY (
		SELECT --STRING_AGG(CAST(TRGTMAN_NM AS varchar(50) ), ',')
		  --TRGTMAN_ID,
		  STRING_AGG(CONCAT(TRGTMAN_NM, ' (', U.EMAIL, ')'), ', ')
		  --U.EMAIL
		FROM TN_CLM_CONTRACT_AUTHREQ INNER JOIN TB_COM_USER U ON TRGTMAN_ID = U.USER_ID
		WHERE CNTRT_ID = M.CNTRT_ID
	) AS CC
	*/