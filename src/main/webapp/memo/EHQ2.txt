
DECLARE @FromDate DATE = '2025-09-01';
DECLARE @ToDate DATE = '2026-01-01';

-- Layout 2 query
SELECT
YEAR(M.REG_DT) AS "Registration Year",
M.REG_DT AS "Registration Date",
 CASE WHEN M.COMP_CD in ( 'SEP', 'SESA' )		THEN 'SEIB'
	       WHEN M.COMP_CD in ( 'SEH-P', 'SEH-S' )	THEN 'SEH'
	       WHEN M.COMP_CD in ( 'SESG', 'SEAG' )		THEN 'SEAS'
	       WHEN M.COMP_CD in ( 'SRUK' )				THEN 'EHQ'
	  ELSE M.COMP_CD
	  END AS "NERP Subsidiary",


REQ.REQ_TITLE AS "Requet Title",
M.CNTRT_NM AS "Contract Name",
REQ.REG_NM as "Requester",

REQ.REQ_DT AS "Date of the first request",
ISNULL(CAST(TRY_CONVERT(DATE,m.org_acptday,23) AS VARCHAR), '') AS "Original Copy Receipt Date", -- cpy_regday = Copy Register Date
REQ.REQMAN_NM AS "In Charge",
REQ.REQ_DEPT_NM AS "Requesting Dept.",
M.CNTRT_OPPNT_NM as "Counterparty",
M.CNTRT_OPPNT_CD as 'Counterparty Code',
RES.CNSDMAN_NM AS "Reviewer",
M.CNTRT_NO AS "Contract ID",
cd1.CD_NM_ENG AS "Step", cd2.CD_NM_ENG AS "Status",
--m.mod_dt, req.mod_dt,
--ISNULL(CAST(
case
	WHEN M.MOD_DT >= REQ.MOD_DT OR REQ.MOD_DT IS NULL THEN M.MOD_DT
	WHEN REQ.MOD_DT > M.MOD_DT OR M.MOD_DT IS NULL THEN REQ.MOD_DT
	ELSE NULL
END AS "Last Modification Date",

CASE WHEN m.CLOSE_YN = 'Y'
		THEN 'Yes'
		ELSE 'No'
	  END AS "Closed", REQ.RE_DEMNDDAY,
ISNULL(CAST(TRY_CONVERT(date, REQ.RE_DEMNDDAY, 23) AS VARCHAR), '') AS "Requested Date for Reply",
	(
	SELECT MIN(a1.mod_dt)
		FROM TN_CLM_CONT_CNSDREQ a1
			INNER JOIN TN_CLM_CONTRACT_CNSD a2 ON a2.cnsdreq_id = a1.cnsdreq_id
	WHERE a2.cntrt_id = M.cntrt_id
		--AND a1.PRGRS_STATUS like 'C0420%' --AND a1.PRGRS_STATUS = 'C04207' -- C04207 = final reply
	) AS "First Replied Date",
	(
	SELECT MAX(a1.mod_dt)
		FROM TN_CLM_CONT_CNSDREQ a1
			INNER JOIN TN_CLM_CONTRACT_CNSD a2 ON a2.cnsdreq_id = a1.cnsdreq_id
	WHERE a2.cntrt_id = M.cntrt_id
		--AND a1.PRGRS_STATUS like 'C0420%' --AND a1.PRGRS_STATUS = 'C04207' -- C04207 = final reply
	) AS "Final Replied Date",
	TRY_CONVERT(DATE,m.CNTRTPERIOD_STARTDAY,23) AS "Contract start date",
	TRY_CONVERT(DATE,m.CNTRTPERIOD_ENDDAY,23) AS "Contract end date",
	ISNULL(CAST(TRY_CONVERT(DATE,m.CNTRT_CNCLSNDAY, 23) AS VARCHAR), '') as "Conclusion Date",

	CASE WHEN m.cnclsnpurps_midclsfcn_etc = 'Y' THEN 'Yes'
		   WHEN m.cnclsnpurps_midclsfcn_etc = 'N' THEN 'No'

			ELSE 'Not selected yet'
	  END AS "DP Agreement",
 (SELECT cd_nm_eng FROM TN_COM_CONTRACTTYPE_CD WHERE TYPE_CD = m.CNCLSNPURPS_BIGCLSFCN) AS "Area of contract",
 ISNULL((
	 	SELECT --STRING_AGG(CAST(TRGTMAN_NM AS varchar(50) ), ',')
		  --TRGTMAN_ID,
		  STRING_AGG(CONCAT(TRGTMAN_NM, ' ( ', U.EMAIL, ' )'), ', ')
		  --U.EMAIL
		FROM TN_CLM_CONTRACT_AUTHREQ INNER JOIN TB_COM_USER U ON TRGTMAN_ID = U.USER_ID
		WHERE CNTRT_ID = M.CNTRT_ID
	), '') AS 'CCed'

--M.CNTRTPERIOD_STARTDAY,
--M.CNTRTPERIOD_ENDDAY,

--M.CLOSE_YN, M.DEL_YN
FROM
( SELECT M.CNTRT_ID, MAX(CNSDREQ_ID) CNSDREQ_ID
	FROM TN_CLM_CONTRACT_MASTER M INNER JOIN TN_CLM_CONTRACT_CNSD RES ON M.CNTRT_ID = RES.CNTRT_ID
	WHERE 1=1
	--AND M.CNTRT_NO LIKE 'EHQ25%'
	--AND M.COMP_CD = 'EHQ'
	AND M.REG_DT >= @FromDate AND M.REG_DT < @ToDate
	GROUP BY M.CNTRT_ID
) AS L
	INNER JOIN TN_CLM_CONT_CNSDREQ REQ ON L.CNSDREQ_ID = REQ.CNSDREQ_ID
	INNER JOIN TN_CLM_CONTRACT_CNSD RES ON REQ.CNSDREQ_ID = RES.CNSDREQ_ID AND L.CNTRT_ID = RES.CNTRT_ID
	INNER JOIN TN_CLM_CONTRACT_MASTER M ON L.CNTRT_ID = M.CNTRT_ID
	LEFT JOIN TB_COM_CD cd1        ON cd1.CD = m.PRCS_DEPTH
	LEFT JOIN TB_COM_CD cd2        ON cd2.CD = m.DEPTH_STATUS
	WHERE M.DEL_YN <> 'Y' AND M.CNTRT_NO IS NOT NULL AND M.CNTRT_NO <> ''
order by 1,3
